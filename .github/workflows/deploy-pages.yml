name: Deploy to Cloudflare Pages (Optimized)

on:
  push:
    branches: [main]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Wrangler
        run: npm install -g wrangler@latest

      - name: Validate Environment
        run: |
          echo "ğŸ” éªŒè¯ç¯å¢ƒé…ç½®..."
          
          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "âŒ CLOUDFLARE_API_TOKEN æœªè®¾ç½®"
            echo "è¯·åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­æ·»åŠ  CLOUDFLARE_API_TOKEN å¯†é’¥"
            exit 1
          fi
          
          if [ -z "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" ]; then
            echo "âŒ CLOUDFLARE_ACCOUNT_ID æœªè®¾ç½®"
            echo "è¯·åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­æ·»åŠ  CLOUDFLARE_ACCOUNT_ID å¯†é’¥"
            exit 1
          fi
          
          echo "âœ… ç¯å¢ƒé…ç½®éªŒè¯é€šè¿‡"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Prepare Deployment Artifacts
        run: |
          echo "ğŸ“¦ å‡†å¤‡éƒ¨ç½²äº§ç‰©..."
          
          # åˆ›å»ºéƒ¨ç½²ç›®å½•
          mkdir -p public
          
          # å¤åˆ¶å¿…è¦çš„æ–‡ä»¶åˆ°éƒ¨ç½²ç›®å½•
          cp _worker.js public/
          cp index.html public/
          cp data.js public/
          
          echo "âœ… éƒ¨ç½²äº§ç‰©å·²å‡†å¤‡å®Œæˆ:"
          echo "   - _worker.js (Cloudflare Functions)"
          echo "   - index.html (é™æ€é¡µé¢)"
          echo "   - data.js (æ•°æ®æ–‡ä»¶)"
          
          # æ˜¾ç¤ºéƒ¨ç½²ç›®å½•å†…å®¹
          echo ""
          echo "ğŸ“‹ éƒ¨ç½²ç›®å½•å†…å®¹:"
          ls -la public/

      - name: Deploy to Cloudflare Pages
        run: |
          echo "ğŸš€ éƒ¨ç½²åˆ° Cloudflare Pages..."
          
          # éƒ¨ç½²åˆ° Cloudflare Pages
          wrangler pages deploy ./public \
            --project-name=cfvless-admin \
            --commit-dirty=true \
            --branch=main
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸ”— è®¿é—®åœ°å€: https://cfvless-admin.pages.dev"
          
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Post-Deploy Instructions
        run: |
          echo ""
          echo "ğŸ‰ ä»£ç éƒ¨ç½²æˆåŠŸï¼"
          echo ""
          echo "âš ï¸  é‡è¦æé†’ï¼šé¦–æ¬¡éƒ¨ç½²åéœ€è¦æ‰‹åŠ¨é…ç½®èµ„æºç»‘å®š"
          echo ""
          echo "ğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œï¼ˆä»…é¦–æ¬¡éœ€è¦ï¼‰ï¼š"
          echo "1. å‰å¾€ Cloudflare Dashboard: https://dash.cloudflare.com"
          echo "2. è¿›å…¥ Workers å’Œ Pages â†’ Pages â†’ cfvless-admin"
          echo "3. ç‚¹å‡» è®¾ç½® â†’ å‡½æ•°"
          echo "4. æ·»åŠ ä»¥ä¸‹ç»‘å®šï¼š"
          echo "   ğŸ“Š D1 æ•°æ®åº“ç»‘å®š:"
          echo "      - å˜é‡å: DB"
          echo "      - D1 æ•°æ®åº“: subscription-db"
          echo "   ğŸ—„ï¸  KV å‘½åç©ºé—´ç»‘å®š:"
          echo "      - å˜é‡å: subscription"
          echo "      - KV å‘½åç©ºé—´: subscription"
          echo "5. ç‚¹å‡»ä¿å­˜ï¼ŒPages ä¼šè‡ªåŠ¨é‡æ–°éƒ¨ç½²"
          echo ""
          echo "ğŸ“– è¯¦ç»†é…ç½®æŒ‡å—è¯·å‚è€ƒ: DEPLOYMENT_FIX_GUIDE.md"