name: Deploy to Cloudflare Pages (Fixed)

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      project_name:
        description: "é¡¹ç›®åç§°"
        required: true
        default: "cfvless-admin"

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Wrangler
        run: npm install -g wrangler@latest

      - name: Validate Environment
        run: |
          echo "ğŸ” éªŒè¯ç¯å¢ƒé…ç½®..."
          
          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "âŒ CLOUDFLARE_API_TOKEN æœªè®¾ç½®"
            exit 1
          fi
          
          if [ -z "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" ]; then
            echo "âŒ CLOUDFLARE_ACCOUNT_ID æœªè®¾ç½®"
            exit 1
          fi
          
          echo "âœ… ç¯å¢ƒé…ç½®éªŒè¯é€šè¿‡"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Setup Infrastructure
        run: |
          set -euo pipefail
          
          PROJECT_NAME="${{ github.event.inputs.project_name || 'cfvless-admin' }}"
          D1_NAME="subscription-db"
          KV_BINDING="subscription"
          
          echo "ğŸ“‹ é¡¹ç›®é…ç½®:"
          echo "  é¡¹ç›®åç§°: ${PROJECT_NAME}"
          echo "  D1 æ•°æ®åº“: ${D1_NAME}"
          echo "  KV ç»‘å®š: ${KV_BINDING}"
          
          # åˆ›å»ºæˆ–è·å– KV å‘½åç©ºé—´
          echo "==> è®¾ç½® KV å‘½åç©ºé—´"
          KV_OUTPUT=$(wrangler kv namespace create ${KV_BINDING} 2>&1 || echo "å¯èƒ½å·²å­˜åœ¨")
          echo "${KV_OUTPUT}"
          
          # åˆ›å»ºæˆ–è·å– D1 æ•°æ®åº“
          echo "==> è®¾ç½® D1 æ•°æ®åº“"
          D1_OUTPUT=$(wrangler d1 create ${D1_NAME} 2>&1 || echo "å¯èƒ½å·²å­˜åœ¨")
          echo "${D1_OUTPUT}"
          
          # åˆå§‹åŒ–æ•°æ®åº“ï¼ˆå¦‚æœæœ‰ SQL æ–‡ä»¶ï¼‰
          if [ -f "d1_init.sql" ]; then
            echo "==> åˆå§‹åŒ–æ•°æ®åº“"
            wrangler d1 execute ${D1_NAME} --remote --file=d1_init.sql || echo "æ•°æ®åº“åˆå§‹åŒ–å®Œæˆæˆ–å·²å­˜åœ¨"
          fi
          
          # ä¿å­˜é¡¹ç›®åç§°
          echo "PROJECT_NAME=${PROJECT_NAME}" >> $GITHUB_ENV
          
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy to Cloudflare Pages
        run: |
          echo "ğŸš€ éƒ¨ç½²åˆ° Cloudflare Pages..."
          
          # å°è¯•éƒ¨ç½²ï¼Œå¦‚æœé¡¹ç›®ä¸å­˜åœ¨åˆ™åˆ›å»º
          if ! wrangler pages deploy . --project-name="${PROJECT_NAME}" --commit-dirty=true; then
            echo "ğŸ“‹ é¡¹ç›®ä¸å­˜åœ¨ï¼Œå°è¯•åˆ›å»ºæ–°é¡¹ç›®..."
            
            # åˆ›å»ºæ–°çš„ Pages é¡¹ç›®
            wrangler pages project create "${PROJECT_NAME}" --production-branch=main
            
            # é‡æ–°å°è¯•éƒ¨ç½²
            echo "ğŸ”„ é‡æ–°éƒ¨ç½²åˆ°æ–°åˆ›å»ºçš„é¡¹ç›®..."
            wrangler pages deploy . --project-name="${PROJECT_NAME}" --commit-dirty=true
          fi
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸ”— è®¿é—®åœ°å€: https://${PROJECT_NAME}.pages.dev"
          
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Post-Deploy Setup
        run: |
          echo "ğŸ“‹ éƒ¨ç½²åé…ç½®æé†’ï¼š"
          echo "1. è¯·å‰å¾€ Cloudflare Dashboard"
          echo "2. è¿›å…¥ Workers å’Œ Pages â†’ Pages â†’ ${PROJECT_NAME}"
          echo "3. åœ¨è®¾ç½®ä¸­ç»‘å®šä»¥ä¸‹èµ„æºï¼š"
          echo "   - D1 æ•°æ®åº“: subscription-db (å˜é‡å: DB)"
          echo "   - KV å‘½åç©ºé—´: subscription (å˜é‡å: subscription)"
          echo "4. ç»‘å®šå®Œæˆåï¼ŒPages ä¼šè‡ªåŠ¨é‡æ–°éƒ¨ç½²"
          echo ""
          echo "ğŸ‰ éƒ¨ç½²æµç¨‹å®Œæˆï¼"