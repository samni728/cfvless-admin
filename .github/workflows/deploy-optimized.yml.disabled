name: Deploy to Cloudflare (Optimized)

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      project_name:
        description: "é¡¹ç›®åç§°"
        required: true
        default: "cfvless-admin"
      d1_name:
        description: "D1 æ•°æ®åº“å"
        required: true
        default: "subscription-db"
      kv_binding:
        description: "KV ç»‘å®šå"
        required: true
        default: "subscription"

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Wrangler
        run: npm install -g wrangler@latest

      - name: Validate Environment
        run: |
          echo "ğŸ” éªŒè¯ç¯å¢ƒé…ç½®..."
          
          # æ£€æŸ¥å¿…éœ€çš„å¯†é’¥
          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "âŒ CLOUDFLARE_API_TOKEN æœªè®¾ç½®"
            echo "è¯·åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­æ·»åŠ  CLOUDFLARE_API_TOKEN å¯†é’¥"
            exit 1
          fi
          
          if [ -z "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" ]; then
            echo "âŒ CLOUDFLARE_ACCOUNT_ID æœªè®¾ç½®"
            echo "è¯·åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­æ·»åŠ  CLOUDFLARE_ACCOUNT_ID å¯†é’¥"
            exit 1
          fi
          
          echo "âœ… ç¯å¢ƒé…ç½®éªŒè¯é€šè¿‡"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Setup Infrastructure
        run: |
          set -euo pipefail
          
          # è®¾ç½®å˜é‡
          PROJECT_NAME="${{ github.event.inputs.project_name || 'cfvless-admin' }}"
          D1_NAME="${{ github.event.inputs.d1_name || 'subscription-db' }}"
          KV_BINDING="${{ github.event.inputs.kv_binding || 'subscription' }}"
          
          echo "ğŸ“‹ é¡¹ç›®é…ç½®:"
          echo "  é¡¹ç›®åç§°: ${PROJECT_NAME}"
          echo "  D1 æ•°æ®åº“: ${D1_NAME}"
          echo "  KV ç»‘å®š: ${KV_BINDING}"
          
          echo "==> æ£€æŸ¥ Wrangler ç‰ˆæœ¬"
          wrangler --version
          
          # ç¡®ä¿ KV å‘½åç©ºé—´å­˜åœ¨
          echo "==> è®¾ç½® KV å‘½åç©ºé—´ (${KV_BINDING})"
          KV_ID=""
          if wrangler kv namespace list --output json >/tmp/kv_list.json 2>/dev/null; then
            KV_ID=$(node -e "
              const fs = require('fs');
              try {
                const data = JSON.parse(fs.readFileSync('/tmp/kv_list.json', 'utf8'));
                const namespace = data.find(x => x.title && x.title.endsWith(': ${KV_BINDING}'));
                if (namespace) process.stdout.write(namespace.id);
              } catch(e) {}
            " || true)
          fi
          
          if [ -z "${KV_ID}" ]; then
            echo "åˆ›å»ºæ–°çš„ KV å‘½åç©ºé—´..."
            wrangler kv namespace create ${KV_BINDING} >/tmp/kv_create.txt 2>&1 || true
            KV_ID=$(grep -Eo 'id\s*=\s*"[a-f0-9]{32}"' /tmp/kv_create.txt | head -1 | sed -E 's/.*"(.*)"/\1/' || true)
          fi
          echo "KV_ID=${KV_ID}"
          
          # ç¡®ä¿ D1 æ•°æ®åº“å­˜åœ¨
          echo "==> è®¾ç½® D1 æ•°æ®åº“ (${D1_NAME})"
          D1_ID=""
          if wrangler d1 list --output json >/tmp/d1_list.json 2>/dev/null; then
            D1_ID=$(node -e "
              const fs = require('fs');
              try {
                const data = JSON.parse(fs.readFileSync('/tmp/d1_list.json', 'utf8'));
                const db = data.find(x => x.name === '${D1_NAME}');
                if (db) process.stdout.write(db.uuid || db.id || '');
              } catch(e) {}
            " || true)
          fi
          
          if [ -z "${D1_ID}" ]; then
            echo "åˆ›å»ºæ–°çš„ D1 æ•°æ®åº“..."
            wrangler d1 create ${D1_NAME} >/tmp/d1_create.txt 2>&1 || true
            D1_ID=$(grep -Eo 'uuid\s*:\s*[a-f0-9-]+' /tmp/d1_create.txt | head -1 | awk '{print $2}' || true)
            
            # é‡æ–°è·å– ID å¦‚æœè§£æå¤±è´¥
            if [ -z "${D1_ID}" ]; then
              sleep 2
              if wrangler d1 list --output json >/tmp/d1_list2.json 2>/dev/null; then
                D1_ID=$(node -e "
                  const fs = require('fs');
                  try {
                    const data = JSON.parse(fs.readFileSync('/tmp/d1_list2.json', 'utf8'));
                    const db = data.find(x => x.name === '${D1_NAME}');
                    if (db) process.stdout.write(db.uuid || db.id || '');
                  } catch(e) {}
                " || true)
              fi
            fi
          fi
          echo "D1_ID=${D1_ID}"
          
          # åˆ›å»ºä¸´æ—¶é…ç½®æ–‡ä»¶
          echo "==> å‡†å¤‡éƒ¨ç½²é…ç½®"
          cp wrangler.toml wrangler.deploy.toml
          
          # æ›´æ–° D1 é…ç½®
          if [ -n "${D1_ID}" ]; then
            if grep -q '^database_id\s*=' wrangler.deploy.toml; then
              sed -i.bak "s/^database_id\s*=.*/database_id = \"${D1_ID}\"/" wrangler.deploy.toml
            else
              # åœ¨ [[d1_databases]] éƒ¨åˆ†åæ·»åŠ  database_id
              awk -v id="${D1_ID}" '
                /^\[\[d1_databases\]\]/ { print; print "database_id = \"" id "\""; next }
                { print }
              ' wrangler.deploy.toml > wrangler.tmp && mv wrangler.tmp wrangler.deploy.toml
            fi
          fi
          
          # æ›´æ–° KV é…ç½®
          if [ -n "${KV_ID}" ]; then
            if grep -q '^id\s*=' wrangler.deploy.toml; then
              sed -i.bak "0,/^id\s*=/s//id = \"${KV_ID}\"/" wrangler.deploy.toml
            else
              # åœ¨ [[kv_namespaces]] éƒ¨åˆ†åæ·»åŠ  id
              awk -v id="${KV_ID}" '
                /^\[\[kv_namespaces\]\]/ { print; print "id = \"" id "\""; next }
                { print }
              ' wrangler.deploy.toml > wrangler.tmp && mv wrangler.tmp wrangler.deploy.toml
            fi
          fi
          
          echo "==> æœ€ç»ˆé…ç½®é¢„è§ˆ"
          cat wrangler.deploy.toml
          
          # åˆå§‹åŒ–æ•°æ®åº“
          if [ -f "d1_init.sql" ] && [ -n "${D1_ID}" ]; then
            echo "==> åˆå§‹åŒ–æ•°æ®åº“è¡¨ç»“æ„"
            wrangler d1 migrations apply ${D1_NAME} --remote || true
            # å¦‚æœæ²¡æœ‰ migrationsï¼Œç›´æ¥æ‰§è¡Œ SQL
            wrangler d1 execute ${D1_NAME} --remote --file=d1_init.sql || true
          fi
          
          # ä¿å­˜å˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "PROJECT_NAME=${PROJECT_NAME}" >> $GITHUB_ENV
          echo "D1_NAME=${D1_NAME}" >> $GITHUB_ENV
          echo "KV_BINDING=${KV_BINDING}" >> $GITHUB_ENV
          
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy to Cloudflare Pages
        run: |
          echo "ğŸš€ éƒ¨ç½²åˆ° Cloudflare Pages..."
          
          # æ›¿æ¢åŸå§‹é…ç½®æ–‡ä»¶ï¼Œå› ä¸º Pages ä¸æ”¯æŒè‡ªå®šä¹‰é…ç½®æ–‡ä»¶è·¯å¾„
          cp wrangler.deploy.toml wrangler.toml
          
          # ä½¿ç”¨ Pages éƒ¨ç½²
          wrangler pages deploy . \
            --project-name="${PROJECT_NAME}" \
            --commit-dirty=true
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          echo ""
          echo "ğŸ“‹ éƒ¨ç½²ä¿¡æ¯:"
          echo "  é¡¹ç›®åç§°: ${PROJECT_NAME}"
          echo "  D1 æ•°æ®åº“: ${D1_NAME}"
          echo "  KV å‘½åç©ºé—´: ${KV_BINDING}"
          echo ""
          echo "ğŸ”— è®¿é—®åœ°å€: https://${PROJECT_NAME}.pages.dev"
          
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Cleanup
        if: always()
        run: |
          # æ¢å¤åŸå§‹é…ç½®æ–‡ä»¶
          git checkout wrangler.toml 2>/dev/null || true
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f wrangler.deploy.toml wrangler.deploy.toml.bak wrangler.tmp
          rm -f /tmp/kv_*.json /tmp/d1_*.json /tmp/kv_create.txt /tmp/d1_create.txt