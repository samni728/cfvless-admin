<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>订阅聚合管理平台 V2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8fafc; /* gray-50 */
        }
        .material-icons {
            vertical-align: middle;
        }
        /* Custom styles for better UX */
        .tab-active {
            color: #2563eb; /* text-blue-600 */
            font-weight: 600;
            border-bottom: 2px solid #2563eb;
        }
        .tab-inactive {
            color: #4b5563; /* text-gray-600 */
        }
        .tab-inactive:hover {
            color: #2563eb; /* hover:text-blue-600 */
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Login/Register View -->
    <div id="login-prompt" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="max-w-4xl w-full mx-auto p-8">
            <div class="text-center mb-12">
                <h1 class="text-5xl font-bold text-gray-800">🏷️ 订阅聚合管理平台</h1>
                <p class="text-xl text-gray-600 mt-4">一个基于Tag的智能节点管理、生成与聚合系统</p>
            </div>
            <div class="bg-white rounded-2xl shadow-xl p-10">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-10 items-center">
                    <div>
                        <h2 class="text-2xl font-semibold text-gray-700 mb-6">核心功能</h2>
                        <ul class="space-y-4">
                            <li class="flex items-start">
                                <span class="material-icons text-blue-500 mt-1 mr-3">sell</span>
                                <div>
                                    <h3 class="font-semibold text-gray-800">Tag驱动的管理</h3>
                                    <p class="text-gray-600 text-sm">按需为节点打上Tag，实现灵活分类与订阅输出。</p>
                                </div>
                            </li>
                            <li class="flex items-start">
                                <span class="material-icons text-blue-500 mt-1 mr-3">bolt</span>
                                <div>
                                    <h3 class="font-semibold text-gray-800">智能节点生成器</h3>
                                    <p class="text-gray-600 text-sm">基于模板和海量IP库，批量生成可用节点。</p>
                                </div>
                            </li>
                            <li class="flex items-start">
                                <span class="material-icons text-blue-500 mt-1 mr-3">sync</span>
                                <div>
                                    <h3 class="font-semibold text-gray-800">订阅源聚合</h3>
                                    <p class="text-gray-600 text-sm">导入并聚合多个外部订阅源，自动更新节点池。</p>
                                </div>
                            </li>
                             <li class="flex items-start">
                                <span class="material-icons text-blue-500 mt-1 mr-3">hub</span>
                                <div>
                                    <h3 class="font-semibold text-gray-800">源节点配置</h3>
                                    <p class="text-gray-600 text-sm">轻松配置和管理NAT64/ProxyIP等多种基础源节点。</p>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div id="auth-form-container" class="bg-gray-50 p-8 rounded-xl">
                        <h3 id="auth-title" class="text-2xl font-bold text-center text-gray-800 mb-6">用户登录</h3>
                        <div id="auth-alert" class="hidden p-3 mb-4 rounded-md text-sm"></div>
                        <form onsubmit="event.preventDefault(); performAuth();">
                            <div class="mb-4">
                                <label for="username" class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                                <input type="text" id="username" autocomplete="username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" required>
                            </div>
                            <div class="mb-6">
                                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                                <input type="password" id="password" autocomplete="current-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" required>
                            </div>
                            <button id="auth-submit-button" type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition shadow-md">登录</button>
                        </form>
                        <p class="text-center text-sm text-gray-600 mt-6">
                            <span id="auth-switch-text">还没有账户？</span>
                            <button onclick="switchAuthMode()" class="font-semibold text-blue-600 hover:underline">
                                <span id="auth-switch-link">立即注册</span>
                            </button>
                        </p>
                    </div>
                </div>
            </div>
             <footer class="text-center py-10 text-gray-500 text-sm">
                <p>Cloudflare节点聚合管理平台 Power by @samni728</p>
                <div class="flex justify-center items-center space-x-4 my-2">
                    <a href="https://github.com/samni728/cfvless-admin" target="_blank" class="text-gray-500 hover:text-gray-700" title="项目地址">
                        <svg aria-hidden="true" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path clip-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.418 2.865 8.165 6.839 9.489.5.092.682-.217.682-.482 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.031-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.203 2.398.1 2.651.64.7 1.03 1.595 1.03 2.688 0 3.848-2.338 4.695-4.566 4.942.359.308.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.001 10.001 0 0022 12c0-5.523-4.477-10-10-10z" fill-rule="evenodd"></path></svg>
                    </a>
                    <a href="https://github.com/samni728/cfvless-admin/stargazers" target="_blank" class="text-yellow-500" title="给个Star">
                        <span class="material-icons" style="font-size: 1.5rem;">star</span>
                    </a>
                </div>
                <p>最后更新: 2025-8-26</p>
            </footer>
        </div>
    </div>

    <!-- Main Application View -->
    <div id="main-content" class="min-h-screen bg-gray-50" style="display: none;">
        <header class="bg-blue-600 text-white shadow-md">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold">订阅聚合管理平台 V2.0</h1>
                <div id="user-status-area" class="flex items-center space-x-4">
                    <!-- User status will be rendered here -->
                </div>
            </div>
        </header>

        <main class="container mx-auto px-6 py-8">
            <nav class="bg-white p-4 rounded-lg shadow-sm mb-8">
                <ul id="main-tabs" class="flex items-center space-x-8 text-gray-600">
                    <!-- Tabs will be rendered here -->
                </ul>
            </nav>

            <div id="tab-content">
                <!-- Tab panes will be rendered here -->
            </div>
        </main>

        <footer class="text-center py-6 text-gray-500 text-sm">
            <p>Cloudflare节点聚合管理平台 Power by @samni728</p>
            <div class="flex justify-center items-center space-x-4 my-2">
                <a href="https://github.com/samni728/cfvless-admin" target="_blank" class="text-gray-500 hover:text-gray-700" title="项目地址">
                    <svg aria-hidden="true" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path clip-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.418 2.865 8.165 6.839 9.489.5.092.682-.217.682-.482 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.031-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.203 2.398.1 2.651.64.7 1.03 1.595 1.03 2.688 0 3.848-2.338 4.695-4.566 4.942.359.308.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.001 10.001 0 0022 12c0-5.523-4.477-10-10-10z" fill-rule="evenodd"></path></svg>
                </a>
                 <a href="https://github.com/samni728/cfvless-admin/stargazers" target="_blank" class="text-yellow-500" title="给个Star">
                    <span class="material-icons" style="font-size: 1.5rem;">star</span>
                </a>
            </div>
            <p>最后更新: 2025-8-26</p>
        </footer>
    </div>

    <!-- Global Alert/Toast -->
    <div id="global-alert" class="hidden fixed top-5 right-5 w-auto max-w-sm p-4 rounded-lg shadow-lg text-white z-50 flex items-center">
        <span id="global-alert-icon" class="material-icons mr-3"></span>
        <span id="global-alert-message"></span>
    </div>

    <!-- Modals (re-styled with Tailwind) -->
    <!-- Create Tag Modal -->
    <div id="createTagModal" class="fixed inset-0 z-40 hidden items-center justify-center modal">
        <div class="modal-backdrop fixed inset-0 bg-black opacity-50"></div>
        <div class="bg-white rounded-lg shadow-xl m-4 max-w-lg w-full z-50">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800">创建新Tag</h3>
                <button onclick="hideModal('createTagModal')" class="text-gray-400 hover:text-gray-600">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="p-6">
                <div id="create-tag-alert" class="hidden p-3 mb-4 rounded-md text-sm"></div>
                <div class="mb-4">
                    <label for="tagName" class="block text-sm font-medium text-gray-700 mb-1">Tag名称 <span class="text-red-500">*</span></label>
                    <input type="text" id="tagName" required placeholder="例如: 游戏专用, 主力节点" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <div>
                    <label for="tagDescription" class="block text-sm font-medium text-gray-700 mb-1">描述 (可选)</label>
                    <textarea id="tagDescription" rows="2" placeholder="简单描述这个Tag的用途..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"></textarea>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 text-right space-x-2">
                <button onclick="hideModal('createTagModal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">取消</button>
                <button onclick="createNewTag()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">创建Tag</button>
            </div>
        </div>
    </div>

    <!-- Add Source Modal -->
    <div id="addSourceModal" class="fixed inset-0 z-40 hidden items-center justify-center modal">
        <div class="modal-backdrop fixed inset-0 bg-black opacity-50"></div>
        <div class="bg-white rounded-lg shadow-xl m-4 max-w-lg w-full z-50">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800">添加新订阅源</h3>
                <button onclick="hideModal('addSourceModal')" class="text-gray-400 hover:text-gray-600">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="p-6">
                <div id="add-source-alert" class="hidden p-3 mb-4 rounded-md text-sm"></div>
                <div class="mb-4">
                    <label for="sourceName" class="block text-sm font-medium text-gray-700 mb-1">订阅名称 <span class="text-red-500">*</span></label>
                    <input type="text" id="sourceName" required placeholder="例如: 机场A" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <div>
                    <label for="sourceUrl" class="block text-sm font-medium text-gray-700 mb-1">订阅链接 (URL) <span class="text-red-500">*</span></label>
                    <input type="url" id="sourceUrl" required placeholder="https://..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 text-right space-x-2">
                <button onclick="hideModal('addSourceModal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">取消</button>
                <button onclick="addSubscriptionSource()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">确认添加</button>
            </div>
        </div>
    </div>

    <script src="data.js"></script>
    <script>
    // The entire JS block from the old file will be pasted here.
    // I will keep it as is, but add new functions for the new UI.
    // =================================================================
    // 新的UI控制函数
    // =================================================================

    let activeTab = 'tag-management'; // Default active tab

    const tabs = [
        { id: 'tag-management', icon: 'sell', name: 'Tag管理' },
        { id: 'generator', icon: 'bolt', name: '节点生成器' },
        { id: 'manager', icon: 'tune', name: '订阅源管理' },
        { id: 'source-nodes', icon: 'hub', name: '源节点管理' },
        { id: 'nodepool', icon: 'storage', name: '节点池管理' },
    ];

    function renderTabs() {
        const tabsContainer = document.getElementById('main-tabs');
        if (!tabsContainer) return;
        tabsContainer.innerHTML = tabs.map(tab => `
            <li>
                <a href="#" id="tab-link-${tab.id}" onclick="switchTab('${tab.id}')" class="flex items-center pb-2 transition ${activeTab === tab.id ? 'tab-active' : 'tab-inactive'}">
                    <span class="material-icons mr-2">${tab.icon}</span>
                    ${tab.name}
                </a>
            </li>
        `).join('');
    }

    function renderTabContent() {
        const contentContainer = document.getElementById('tab-content');
        if (!contentContainer) return;

        contentContainer.innerHTML = `
            <!-- Tag Management Pane -->
            <div id="tag-management-pane" class="hidden">
                <section class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-800">我的Tag管理</h2>
                        <button onclick="showModal('createTagModal')" class="bg-blue-600 text-white px-6 py-2 rounded-lg flex items-center hover:bg-blue-700 transition shadow-md">
                            <span class="material-icons mr-2">add_circle</span> 创建新Tag
                        </button>
                    </div>
                    <div id="tags-list-container" class="bg-white p-6 rounded-lg shadow-sm"></div>
                </section>
                <section class="mb-8">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">节点批量操作</h2>
                    <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-900 p-6 rounded-lg shadow-sm">
                        <p class="font-bold mb-2">使用说明：</p>
                        <ol class="list-decimal list-inside space-y-2 text-sm">
                            <li><span class="font-semibold">勾选Tag：</span>在上方Tag卡片中勾选要操作的Tag（可多选）</li>
                            <li><span class="font-semibold">粘贴节点：</span>将节点链接粘贴到下方文本框</li>
                            <li><span class="font-semibold">选择操作：</span>添加到选中Tag或从选中Tag删除</li>
                        </ol>
                    </div>
                </section>
                <section>
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">节点列表</h2>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <textarea id="node-feedback-textarea" class="w-full h-48 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition mb-4 resize-none" placeholder="示例:\nvless://uuid@server:port?params#name\nvmess://base64data"></textarea>
                        <div class="flex items-center space-x-4">
                            <button onclick="batchOperateNodes('add')" class="bg-green-500 text-white px-6 py-2 rounded-lg flex items-center hover:bg-green-600 transition shadow-md">
                                <span class="material-icons mr-2">add</span> 添加到选中Tag
                            </button>
                            <button onclick="batchOperateNodes('delete')" class="bg-red-500 text-white px-6 py-2 rounded-lg flex items-center hover:bg-red-600 transition shadow-md">
                                <span class="material-icons mr-2">remove</span> 从选中Tag删除
                            </button>
                            <button onclick="clearNodeTextarea()" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg flex items-center hover:bg-gray-300 transition">
                                <span class="material-icons mr-2">clear</span> 清空文本框
                            </button>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Generator Pane -->
            <div id="generator-pane" class="hidden space-y-8">
                <div class="text-center">
                    <h2 class="text-3xl font-bold text-gray-800">⚡ 终极节点生成器</h2>
                    <p class="text-lg text-gray-600 mt-2">一个强大、灵活的在线节点批量生成工具</p>
                </div>

                <!-- Step 1: Data Source -->
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">第一步：提供数据源</h3>
                    <!-- Built-in vs Custom tabs -->
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <a href="#" id="gen-builtin-tab" onclick="switchGenTab('builtin')" class="border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">内置地区数据</a>
                            <a href="#" id="gen-manual-tab" onclick="switchGenTab('manual')" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">自定义粘贴数据</a>
                        </nav>
                    </div>

                    <div id="gen-builtin-pane" class="mt-4 space-y-4">
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <label class="block text-sm font-medium text-gray-700 mb-2">🌐 IP版本选择</label>
                            <div class="flex gap-4">
                                <label class="flex items-center"><input type="checkbox" id="useIPv4" checked onchange="updateEstimation()" class="h-4 w-4 text-blue-600 border-gray-300 rounded"> <span class="ml-2 text-gray-700">IPv4</span></label>
                                <label class="flex items-center"><input type="checkbox" id="useIPv6" checked onchange="updateEstimation()" class="h-4 w-4 text-blue-600 border-gray-300 rounded"> <span class="ml-2 text-gray-700">IPv6</span></label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">🌍 地区选择</label>
                            <div id="region-selector" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2"></div>
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">🔌 HTTPS端口选择</label>
                            <div id="builtin-https-port-selector" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2"></div>
                        </div>
                    </div>

                    <div id="gen-manual-pane" class="hidden mt-4 space-y-4">
                        <div>
                            <label for="customData" class="block text-sm font-medium text-gray-700">自定义地址 (IP、CIDR 或域名，每行一个)</label>
                            <textarea id="customData" rows="6" oninput="updateEstimation()" placeholder="示例：&#10;104.28.43.45/32&#10;192.168.1.0/24&#10;example.com" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">🔌 HTTPS端口选择</label>
                            <div id="https-port-selector" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Template -->
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">第二步：设置模板和选项</h3>
                     <div class="space-y-4">
                        <div>
                           <label for="templateUrl" class="block text-sm font-medium text-gray-700">粘贴源节点 (VLESS 或 VMess)</label>
                           <input type="text" id="templateUrl" placeholder="vless://... 或 vmess://..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">选择输出格式</label>
                            <div id="format-selector" class="mt-2 flex gap-4">
                                <label class="flex items-center"><input type="radio" name="outputFormat" id="formatVless" value="vless" class="h-4 w-4 text-blue-600 border-gray-300"> <span class="ml-2 text-gray-700">VLESS</span></label>
                                <label class="flex items-center"><input type="radio" name="outputFormat" id="formatVmessJson" value="vmess_json" checked class="h-4 w-4 text-blue-600 border-gray-300"> <span class="ml-2 text-gray-700">VMess (v2rayN/U)</span></label>
                            </div>
                        </div>
                        <div id="estimation" class="!mt-6 p-4 rounded-lg bg-blue-50 text-blue-800 text-center"></div>
                    </div>
                </div>

                <!-- Step 3: Generate -->
                 <div class="bg-white p-6 rounded-lg shadow-sm">
                     <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">第三步：生成节点</h3>
                     <div class="flex items-end gap-4">
                         <div class="flex-grow">
                            <label for="quantity" class="block text-sm font-medium text-gray-700">生成数量</label>
                            <input type="number" id="quantity" value="20" min="1" oninput="validateQuantityInput()" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                         </div>
                         <button onclick="generateNodes()" class="bg-blue-600 text-white h-10 px-8 rounded-lg flex items-center justify-center font-semibold hover:bg-blue-700 transition shadow-md">生成节点</button>
                     </div>
                </div>

                <!-- Step 4: Results -->
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">生成结果</h3>
                    <textarea id="output" rows="10" readonly class="w-full p-2 border bg-gray-50 rounded-md"></textarea>
                    <div class="mt-4 flex gap-4">
                        <button id="copyButton" onclick="copyResults()" class="flex-1 bg-green-500 text-white px-6 py-2 rounded-lg flex items-center justify-center hover:bg-green-600 transition">
                            <span class="material-icons mr-2">content_copy</span> 一键复制
                        </button>
                    </div>
                    <!-- Save to Tag Section -->
                    <div class="mt-6 border-t pt-4">
                        <h4 class="font-semibold text-gray-700 mb-2">💾 将这些节点存入Tag</h4>
                        <div class="flex gap-4 items-center">
                            <select id="existing-tag-select" class="flex-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">-- 选择一个已有Tag --</option>
                            </select>
                            <span class="text-gray-500">或</span>
                            <input type="text" id="new-tag-input" placeholder="输入新Tag名称..." class="flex-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <button onclick="saveNodesToTag()" class="bg-blue-500 text-white px-6 py-2 rounded-lg flex items-center hover:bg-blue-600 transition">
                                <span class="material-icons mr-2 text-sm">save</span> 存入Tag
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Subscription Manager Pane -->
            <div id="manager-pane" class="hidden">
                 <section>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-800">我的订阅源</h2>
                        <button onclick="showModal('addSourceModal')" class="bg-blue-600 text-white px-6 py-2 rounded-lg flex items-center hover:bg-blue-700 transition shadow-md">
                            <span class="material-icons mr-2">add</span> 添加新订阅源
                        </button>
                    </div>
                    <div id="subscription-sources-list" class="bg-white rounded-lg shadow-sm"></div>
                </section>
            </div>

            <!-- Source Nodes Pane -->
            <div id="source-nodes-pane" class="hidden">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-800">源节点管理</h2>
                    <p class="text-lg text-gray-600 mt-2">NAT64 和 ProxyIP 源节点生成与管理</p>
                </div>
                <div class="mb-8">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">🌟 默认源节点</h3>
                    <div id="default-source-nodes" class="space-y-4"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <!-- NAT64 Config -->
                    <div class="bg-white p-6 rounded-lg shadow-sm border-t-4 border-blue-500">
                        <h4 class="text-lg font-bold text-blue-600 mb-4">🌐 NAT64 源节点配置</h4>
                        <form id="nat64-form" class="space-y-4">
                             <div>
                                <label for="nat64-name" class="block text-sm font-medium text-gray-700">配置名称</label>
                                <input type="text" id="nat64-name" placeholder="例如：我的NAT64节点" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="nat64-domain" class="block text-sm font-medium text-gray-700">域名</label>
                                <input type="text" id="nat64-domain" placeholder="your-worker.workers.dev" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="nat64-uuid" class="block text-sm font-medium text-gray-700">UUID</label>
                                <div class="mt-1 flex rounded-md shadow-sm">
                                    <input type="text" id="nat64-uuid" placeholder="点击生成UUID" class="flex-1 block w-full rounded-none rounded-l-md px-3 py-2 border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <button type="button" onclick="generateUUID('nat64-uuid')" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 hover:bg-gray-100">生成</button>
                                </div>
                            </div>
                             <div class="flex items-center">
                                <input id="nat64-auto-fallback" type="checkbox" checked class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <label for="nat64-auto-fallback" class="ml-2 block text-sm text-gray-900">启用自动回退 (推荐)</label>
                            </div>
                            <div class="pt-2">
                                <button type="button" onclick="saveSourceNodeConfig('nat64')" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">💾 保存并添加到节点池</button>
                            </div>
                        </form>
                    </div>
                    <!-- ProxyIP Config -->
                    <div class="bg-white p-6 rounded-lg shadow-sm border-t-4 border-green-500">
                         <h4 class="text-lg font-bold text-green-600 mb-4">🌍 ProxyIP 源节点配置</h4>
                         <form id="proxyip-form" class="space-y-4">
                            <div>
                                <label for="proxyip-name" class="block text-sm font-medium text-gray-700">配置名称</label>
                                <input type="text" id="proxyip-name" placeholder="例如：我的ProxyIP节点" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            </div>
                             <div>
                                <label for="proxyip-domain" class="block text-sm font-medium text-gray-700">域名</label>
                                <input type="text" id="proxyip-domain" placeholder="your-worker.workers.dev" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            </div>
                            <div>
                                <label for="proxyip-uuid" class="block text-sm font-medium text-gray-700">UUID</label>
                                <div class="mt-1 flex rounded-md shadow-sm">
                                    <input type="text" id="proxyip-uuid" placeholder="点击生成UUID" class="flex-1 block w-full rounded-none rounded-l-md px-3 py-2 border border-gray-300 focus:outline-none focus:ring-green-500 focus:border-green-500">
                                    <button type="button" onclick="generateUUID('proxyip-uuid')" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 hover:bg-gray-100">生成</button>
                                </div>
                            </div>
                             <div>
                                <label for="proxyip-address" class="block text-sm font-medium text-gray-700">代理IP</label>
                                <input type="text" id="proxyip-address" placeholder="优选IP地址" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            </div>
                            <div class="pt-2">
                                <button type="button" onclick="saveSourceNodeConfig('proxyip')" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">💾 保存并添加到节点池</button>
                            </div>
                         </form>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xl font-semibold text-gray-700">📋 我的源节点配置</h3>
                        <button onclick="loadSourceNodes()" class="text-blue-600 hover:text-blue-800 p-2 rounded-full"><span class="material-icons">refresh</span></button>
                    </div>
                    <div id="custom-source-nodes" class="bg-white rounded-lg shadow-sm"></div>
                </div>
            </div>

            <!-- Nodepool Pane -->
            <div id="nodepool-pane" class="hidden">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">我的节点池</h2>
                    <div>
                        <span id="node-count-badge" class="inline-block bg-blue-100 text-blue-800 text-sm font-semibold px-3 py-1 rounded-full mr-4">总计: 0</span>
                        <button onclick="refreshAllSources()" class="bg-blue-600 text-white px-6 py-2 rounded-lg flex items-center hover:bg-blue-700 transition shadow-md">
                            <span class="material-icons mr-2">refresh</span> 刷新所有源
                        </button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <input type="text" id="node-search" placeholder="搜索节点名称、来源、服务器..." oninput="filterNodes()" class="p-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        <select id="source-filter" onchange="filterNodes()" class="p-2 border rounded-lg focus:ring-2 focus:ring-blue-500"><option value="">所有来源</option></select>
                        <select id="protocol-filter" onchange="filterNodes()" class="p-2 border rounded-lg focus:ring-2 focus:ring-blue-500"><option value="">所有协议</option></select>
                    </div>
                    <div id="node-pool-list" class="divide-y divide-gray-200"></div>
                    <nav class="mt-6 flex justify-center">
                        <ul id="node-pagination" class="flex items-center -space-x-px h-8 text-sm"></ul>
                    </nav>
                </div>
            </div>
        `;
    }

    function switchTab(tabId) {
        activeTab = tabId;
        renderTabs(); // Re-render tabs to update active state

        // Hide all panes
        document.getElementById('tag-management-pane').classList.add('hidden');
        document.getElementById('generator-pane').classList.add('hidden');
        document.getElementById('manager-pane').classList.add('hidden');
        document.getElementById('source-nodes-pane').classList.add('hidden');
        document.getElementById('nodepool-pane').classList.add('hidden');

        // Show the active one
        const activePane = document.getElementById(`${tabId}-pane`);
        if (activePane) {
            activePane.classList.remove('hidden');
        }

        // Trigger data loading for the new tab
        if (tabId === 'tag-management') loadTags();
        if (tabId === 'manager') loadSubscriptionSources();
        if (tabId === 'source-nodes') loadSourceNodes();
        if (tabId === 'nodepool') loadNodePool();

    }

    function showModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
    }

    function hideModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    }

    function showGlobalAlert(message, type = 'success') {
        const alertElement = document.getElementById('global-alert');
        const iconElement = document.getElementById('global-alert-icon');
        const messageElement = document.getElementById('global-alert-message');

        alertElement.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'bg-yellow-500');

        if (type === 'success') {
            alertElement.classList.add('bg-green-500');
            iconElement.textContent = 'check_circle';
        } else if (type === 'danger') {
            alertElement.classList.add('bg-red-500');
            iconElement.textContent = 'error';
        } else { // info/warning
             alertElement.classList.add('bg-yellow-500');
            iconElement.textContent = 'warning';
        }

        messageElement.textContent = message;
        alertElement.classList.remove('hidden');

        setTimeout(() => {
            alertElement.classList.add('hidden');
        }, 3000);
    }

    // =================================================================
    // 旧的JS逻辑，需要适配新的UI
    // =================================================================
    let currentUser = null;
    let isLoginMode = true;
    let allTags = [];
    let allNodes = [];
    let filteredNodes = [];
    let currentPage = 1;
    const nodesPerPage = 20;

    async function apiRequest(url, method, data = null) {
        const options = {
            method: method,
            headers: { "Content-Type": "application/json" },
        };
        if (data) options.body = JSON.stringify(data);

        try {
            const response = await fetch(url, options);
            const result = await response.json();
            return { ok: response.ok, data: result, status: response.status };
        } catch (error) {
            console.error("API请求失败:", error);
            return { ok: false, data: { error: error.message }, status: 500 };
        }
    }

    async function checkLoginStatus() {
        console.log("检查登录状态...");
        const result = await apiRequest("/api/status", "GET");
        if (result.ok && result.data.authenticated) {
            currentUser = result.data;
            console.log("用户已登录:", currentUser.username);
        } else {
            currentUser = null;
            console.log("用户未登录");
        }
        updateUI();
    }

    function updateUI() {
        const mainContent = document.getElementById("main-content");
        const loginPrompt = document.getElementById("login-prompt");

        if (currentUser) {
            mainContent.style.display = "block";
            loginPrompt.style.display = "none";

            const userStatusArea = document.getElementById("user-status-area");
            userStatusArea.innerHTML = `
                <span>欢迎, <span class="font-semibold">${currentUser.username}</span></span>
                <button onclick="logout()" class="bg-white text-blue-600 px-4 py-2 rounded-md font-semibold hover:bg-blue-100 transition">登出</button>
            `;

            renderTabs();
            renderTabContent();
            // Initial data load for the default tab
            switchTab(activeTab);

        } else {
            mainContent.style.display = "none";
            loginPrompt.style.display = "flex";
        }
    }

    function switchAuthMode() {
        isLoginMode = !isLoginMode;
        const title = document.getElementById('auth-title');
        const submitButton = document.getElementById('auth-submit-button');
        const switchText = document.getElementById('auth-switch-text');
        const switchLink = document.getElementById('auth-switch-link');

        if (isLoginMode) {
            title.textContent = "用户登录";
            submitButton.textContent = "登录";
            switchText.textContent = "还没有账户？";
            switchLink.textContent = "立即注册";
        } else {
            title.textContent = "用户注册";
            submitButton.textContent = "注册";
            switchText.textContent = "已有账户？";
            switchLink.textContent = "返回登录";
        }
    }

    async function performAuth() {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value;
        const alertElement = document.getElementById("auth-alert");

        if (!username || !password) {
            showAlert(alertElement, "danger", "用户名和密码不能为空");
            return;
        }

        const endpoint = isLoginMode ? "/api/login" : "/api/register";
        const result = await apiRequest(endpoint, "POST", { username, password });

        if (result.ok) {
            showAlert(alertElement, "success", result.data.message);
            document.getElementById("username").value = "";
            document.getElementById("password").value = "";

            if (isLoginMode) {
                setTimeout(() => {
                    checkLoginStatus();
                }, 1000);
            }
        } else {
            showAlert(alertElement, "danger", result.data.error);
        }
    }

    function showAlert(element, type, message) {
        element.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
        if (type === 'success') {
            element.classList.add('bg-green-100', 'text-green-800');
        } else {
            element.classList.add('bg-red-100', 'text-red-800');
        }
        element.textContent = message;
        element.classList.remove('hidden');
    }


    async function logout() {
        await apiRequest("/api/logout", "POST");
        currentUser = null;
        updateUI();
    }

    // =================================================================
    // Tag管理相关函数 (适配新UI)
    // =================================================================
    async function loadTags() {
        const listContainer = document.getElementById("tags-list-container");
        if (!listContainer) return;

        listContainer.innerHTML = '<p class="text-gray-500">正在加载Tag...</p>';

        const result = await apiRequest("/api/tags", "GET");

        if (result.ok && Array.isArray(result.data)) {
            allTags = result.data;

            if (allTags.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500">您还没有创建任何Tag。点击上方按钮创建第一个Tag。</p>';
                return;
            }

            const tagsHTML = allTags.map(tag => `
                <div class="border border-gray-200 rounded-lg p-4 bg-white shadow-md hover:shadow-lg transition-shadow duration-300">
                    <div class="flex items-center mb-3">
                        <input type="checkbox" id="tag-select-${tag.id}" value="${tag.id}" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-3"/>
                        <h3 class="font-bold text-lg text-gray-800 truncate">${escapeHTML(tag.tag_name)}</h3>
                    </div>
                    <div class="mb-4">
                        <span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-full mr-2">${tag.node_count || 0}个节点</span>
                        ${tag.active_count > 0 ? `<span class="inline-block bg-green-100 text-green-800 text-xs font-semibold px-3 py-1 rounded-full">${tag.active_count}可用</span>` : ''}
                    </div>
                    <div class="space-y-2">
                        <button onclick="copyTagSubscription('${tag.tag_uuid}', 'v2ray')" class="w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-md flex items-center justify-center text-sm hover:bg-gray-200 transition">
                            <span class="material-icons mr-2 text-base">link</span> V2Ray订阅
                        </button>
                        <button onclick="copyTagSubscription('${tag.tag_uuid}', 'clash')" class="w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-md flex items-center justify-center text-sm hover:bg-gray-200 transition">
                            <span class="material-icons mr-2 text-base">link</span> Clash订阅
                        </button>
                    </div>
                </div>
            `).join('');

            listContainer.innerHTML = `
                <div class="flex items-center space-x-4 mb-6 pb-4 border-b">
                    <button onclick="selectAllTags(true)" class="bg-blue-100 text-blue-700 px-4 py-2 rounded-full text-sm font-medium">全选Tag</button>
                    <button onclick="selectAllTags(false)" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-full text-sm font-medium">取消全选</button>
                    <button onclick="deleteSelectedTags()" class="bg-red-500 text-white px-4 py-2 rounded-full text-sm font-medium flex items-center">
                        <span class="material-icons text-base mr-1">delete</span> 删除选中Tag
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    ${tagsHTML}
                </div>
            `;
        } else {
            listContainer.innerHTML = '<p class="text-red-500">加载Tag失败。</p>';
        }
    }

    function selectAllTags(select) {
        document.querySelectorAll('input[id^="tag-select-"]').forEach(cb => cb.checked = select);
    }

    function getSelectedTagIds() {
        return Array.from(document.querySelectorAll('input[id^="tag-select-"]:checked')).map(cb => parseInt(cb.value));
    }

    async function createNewTag() {
        const tagName = document.getElementById("tagName").value.trim();
        const tagDescription = document.getElementById("tagDescription").value.trim();
        const alertElement = document.getElementById("create-tag-alert");

        if (!tagName) {
            showAlert(alertElement, "danger", "Tag名称不能为空");
            return;
        }

        const result = await apiRequest("/api/tags", "POST", { tag_name: tagName, description: tagDescription });

        if (result.ok) {
            showAlert(alertElement, "success", result.data.message);
            document.getElementById("tagName").value = "";
            document.getElementById("tagDescription").value = "";
            setTimeout(() => {
                hideModal('createTagModal');
                loadTags();
            }, 1500);
        } else {
            showAlert(alertElement, "danger", `创建失败: ${result.data.error}`);
        }
    }

    async function deleteSelectedTags() {
        const selectedTagIds = getSelectedTagIds();
        if (selectedTagIds.length === 0) {
            showGlobalAlert("请先勾选要删除的Tag！", "warning");
            return;
        }

        if (!confirm(`确定要删除选中的 ${selectedTagIds.length} 个Tag吗？`)) return;

        const result = await apiRequest("/api/tags/batch-delete", "POST", { tag_ids: selectedTagIds });

        if (result.ok) {
            showGlobalAlert(result.data.message, "success");
            loadTags();
        } else {
            showGlobalAlert(`删除失败: ${result.data.error}`, "danger");
        }
    }

    function copyTagSubscription(tagUuid, format) {
        const baseUrl = `${window.location.origin}/sub/tag/${tagUuid}`;
        const url = format === 'clash' ? `${baseUrl}?type=clash` : baseUrl;
        navigator.clipboard.writeText(url).then(() => {
            showGlobalAlert(`${format.charAt(0).toUpperCase() + format.slice(1)} 订阅链接已复制!`, 'success');
        });
    }

    async function batchOperateNodes(action) {
        const selectedTagIds = getSelectedTagIds();
        if (selectedTagIds.length === 0) {
            showGlobalAlert("请先勾选要操作的Tag！", "warning");
            return;
        }

        const nodeText = document.getElementById("node-feedback-textarea").value.trim();
        if (!nodeText) {
            showGlobalAlert("请输入节点链接！", "warning");
            return;
        }

        const nodes = nodeText.split('\\n').filter(line => line.trim() !== "");
        if (nodes.length === 0) {
            showGlobalAlert("没有找到有效的节点链接！", "warning");
            return;
        }

        const result = await apiRequest("/api/nodes/batch-operate", "POST", {
            tag_ids: selectedTagIds,
            nodes: nodes,
            action: action
        });

        if (result.ok) {
            let message = result.data.message;
            if (result.data.details) {
                message += " 详情: " + result.data.details.join(', ');
            }
            showGlobalAlert(message, 'success');
            clearNodeTextarea();
            loadTags();
        } else {
            showGlobalAlert(`操作失败: ${result.data.error}`, 'danger');
        }
    }

    function clearNodeTextarea() {
        document.getElementById("node-feedback-textarea").value = "";
    }

    // =================================================================
    // 订阅源管理
    // =================================================================
    async function loadSubscriptionSources() {
        const listElement = document.getElementById("subscription-sources-list");
        if (!listElement) return;

        listElement.innerHTML = '<p class="p-4 text-gray-500">正在加载订阅源...</p>';
        const result = await apiRequest("/api/subscription-sources", "GET");

        if (result.ok && Array.isArray(result.data)) {
            if (result.data.length === 0) {
                listElement.innerHTML = '<p class="p-4 text-gray-500">您还没有添加任何订阅源。</p>';
                return;
            }

            listElement.innerHTML = result.data.map(source => `
                <div class="border-b p-4 hover:bg-gray-50">
                    <div class="flex justify-between items-center">
                        <div class="flex-1 truncate">
                            <h4 class="font-semibold text-gray-800">${escapeHTML(source.source_name)}</h4>
                            <p class="text-sm text-gray-500 truncate">${escapeHTML(source.source_url)}</p>
                        </div>
                        <div class="ml-4 text-right">
                            <span class="text-sm text-gray-600">节点: ${source.node_count || 0}</span>
                            <span class="ml-2 inline-block px-2 py-1 text-xs font-semibold rounded-full bg-${getStatusColor(source.fetch_status)}-100 text-${getStatusColor(source.fetch_status)}-800">${source.fetch_status}</span>
                        </div>
                    </div>
                    <div class="flex justify-end items-center mt-2 space-x-2">
                         <button onclick="refreshSource(${source.id})" class="text-gray-500 hover:text-blue-600 p-2 rounded-full transition"><span class="material-icons">refresh</span></button>
                         <button onclick="deleteSource(${source.id})" class="text-gray-500 hover:text-red-600 p-2 rounded-full transition"><span class="material-icons">delete</span></button>
                    </div>
                </div>
            `).join('');
        } else {
            listElement.innerHTML = '<p class="p-4 text-red-500">加载订阅源失败。</p>';
        }
    }

    async function addSubscriptionSource() {
        const sourceName = document.getElementById("sourceName").value;
        const sourceUrl = document.getElementById("sourceUrl").value;
        const alertElement = document.getElementById("add-source-alert");

        const result = await apiRequest("/api/subscription-sources", "POST", { source_name: sourceName, source_url: sourceUrl });

        if (result.ok) {
            showAlert(alertElement, "success", result.data.message);
            document.getElementById("sourceName").value = "";
            document.getElementById("sourceUrl").value = "";
            setTimeout(() => {
                hideModal('addSourceModal');
                loadSubscriptionSources();
            }, 1500);
        } else {
            showAlert(alertElement, "danger", `添加失败: ${result.data.error}`);
        }
    }

    async function refreshSource(id) {
        await apiRequest(`/api/subscription-sources/${id}/refresh`, "POST");
        showGlobalAlert("刷新请求已发送，请稍后查看状态。", 'success');
        setTimeout(loadSubscriptionSources, 3000);
    }

    async function deleteSource(id) {
        if (!confirm("确定要删除这个订阅源及其所有节点吗？")) return;
        await apiRequest(`/api/subscription-sources/${id}`, "DELETE");
        showGlobalAlert("订阅源已删除", 'success');
        loadSubscriptionSources();
    }

    function getStatusColor(status) {
        switch (status) {
            case 'success': return 'green';
            case 'fetching': return 'blue';
            case 'failed': return 'red';
            default: return 'gray';
        }
    }

    function escapeHTML(str) {
        if (!str) return "";
        return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    // =================================================================
    // 源节点管理相关函数
    // =================================================================

    function generateUUID(inputId) {
        document.getElementById(inputId).value = crypto.randomUUID();
    }

    async function saveSourceNodeConfig(nodeType) {
        let configName, configData;

        if (nodeType === 'nat64') {
            configName = document.getElementById("nat64-name").value || "NAT64自动配置";
            configData = {
                uuid: document.getElementById("nat64-uuid").value,
                domain: document.getElementById("nat64-domain").value,
            };
        } else {
            // Logic for proxyip
        }

        if (!configData.domain || !configData.uuid) {
            showGlobalAlert("域名和UUID不能为空！", "danger");
            return;
        }

        const result = await apiRequest("/api/source-nodes", "POST", {
            config_name: configName,
            node_type: nodeType,
            config_data: configData,
        });

        if (result.ok) {
            showGlobalAlert("源节点配置已保存并添加到节点池！", "success");
            loadSourceNodes();
            // Optionally reset form
            document.getElementById(`${nodeType}-form`).reset();
        } else {
            showGlobalAlert(`保存失败: ${result.data.error}`, "danger");
        }
    }

    async function loadSourceNodes() {
        const result = await apiRequest("/api/source-nodes", "GET");
        if (result.ok) {
            displaySourceNodes(result.data);
        } else {
            document.getElementById("default-source-nodes").innerHTML = `<p class="text-red-500">加载默认源节点失败</p>`;
            document.getElementById("custom-source-nodes").innerHTML = `<p class="text-red-500">加载自定义源节点失败</p>`;
        }
    }

    function displaySourceNodes(configs) {
        const defaultNodesContainer = document.getElementById("default-source-nodes");
        const customNodesContainer = document.getElementById("custom-source-nodes");

        const defaultNodes = configs.filter(c => c.is_default);
        const customNodes = configs.filter(c => !c.is_default);

        if (defaultNodes.length > 0) {
            defaultNodesContainer.innerHTML = defaultNodes.map(node => {
                const configData = JSON.parse(node.config_data);
                return `
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="flex justify-between items-center">
                        <div>
                            <h5 class="font-semibold">${escapeHTML(node.config_name)}</h5>
                            <p class="text-sm text-gray-600">类型: <span class="font-medium text-blue-600">${node.node_type.toUpperCase()}</span> | 域名: ${escapeHTML(configData.domain)}</p>
                        </div>
                        <button onclick="copyToClipboard('${node.generated_node}')" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons text-gray-600">content_copy</span></button>
                    </div>
                </div>
            `;
            }).join('');
        } else {
            defaultNodesContainer.innerHTML = `<p class="text-gray-500">没有找到默认源节点。</p>`;
        }

        if (customNodes.length > 0) {
            customNodesContainer.innerHTML = customNodes.map(node => `
                 <div class="border-t p-4 hover:bg-gray-50">
                    <div class="flex justify-between items-start">
                        <div>
                            <h5 class="font-semibold">${escapeHTML(node.config_name)}</h5>
                            <p class="text-sm text-gray-500">类型: <span class="font-medium text-blue-600">${node.node_type.toUpperCase()}</span></p>
                            <p class="text-sm text-gray-500 break-all">节点: <code class="text-xs bg-gray-100 p-1 rounded">${escapeHTML(node.generated_node)}</code></p>
                        </div>
                        <div class="flex space-x-1">
                            <button onclick="deleteSourceNode(${node.id}, '${escapeHTML(node.config_name)}')" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons text-red-500">delete</span></button>
                            <button onclick="copyToClipboard('${node.generated_node}')" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons text-gray-600">content_copy</span></button>
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            customNodesContainer.innerHTML = `<p class="p-4 text-center text-gray-500">还没有自定义源节点配置。</p>`;
        }
    }

    async function deleteSourceNode(id, name) {
        if (!confirm(`确定要删除源节点配置 "${name}" 吗？`)) return;
        const result = await apiRequest(`/api/source-nodes/${id}`, 'DELETE');
        if (result.ok) {
            showGlobalAlert('源节点配置已删除', 'success');
            loadSourceNodes();
        } else {
            showGlobalAlert(`删除失败: ${result.data.error}`, 'danger');
        }
    }

    // =================================================================
    // 节点池管理
    // =================================================================
    async function loadNodePool() {
        const result = await apiRequest('/api/nodes', 'GET');
        if (result.ok) {
            allNodes = result.data;
            populateSourceFilter();
            filterNodes();
        } else {
            document.getElementById('node-pool-list').innerHTML = `<p class="text-red-500">加载节点池失败</p>`;
        }
    }

    function populateSourceFilter() {
        const sourceFilter = document.getElementById("source-filter");
        const sources = [...new Set(allNodes.map(node => node.source_name || '手动添加'))];
        sourceFilter.innerHTML = '<option value="">所有来源</option>';
        sources.forEach(source => {
            sourceFilter.innerHTML += `<option value="${escapeHTML(source)}">${escapeHTML(source)}</option>`;
        });
    }

    function filterNodes() {
        const searchTerm = document.getElementById('node-search').value.toLowerCase();
        const sourceFilter = document.getElementById('source-filter').value;
        const protocolFilter = document.getElementById('protocol-filter').value;

        filteredNodes = allNodes.filter(node => {
            const name = node.node_name || '';
            const server = node.server || '';
            const source = node.source_name || '手动添加';
            const protocol = node.protocol || '';

            return (name.toLowerCase().includes(searchTerm) || server.toLowerCase().includes(searchTerm)) &&
                   (!sourceFilter || source === sourceFilter) &&
                   (!protocolFilter || protocol === protocolFilter);
        });

        currentPage = 1;
        displayNodes();
        updatePagination();
        updateNodeCountBadge(filteredNodes.length);
    }

    function displayNodes() {
        const listElement = document.getElementById('node-pool-list');
        const startIndex = (currentPage - 1) * nodesPerPage;
        const endIndex = startIndex + nodesPerPage;
        const nodesToShow = filteredNodes.slice(startIndex, endIndex);

        if (nodesToShow.length === 0) {
            listElement.innerHTML = '<p class="text-center text-gray-500 py-4">没有找到匹配的节点。</p>';
            return;
        }

        listElement.innerHTML = nodesToShow.map(node => `
            <div class="py-3 px-2 hover:bg-gray-50">
                <div class="flex items-center justify-between">
                    <div class="flex-1 truncate">
                        <p class="font-medium text-gray-800 truncate">${escapeHTML(node.node_name)}</p>
                        <p class="text-sm text-gray-500">来源: ${escapeHTML(node.source_name || '手动添加')} | 服务器: ${escapeHTML(node.server)}</p>
                    </div>
                    <div class="ml-4 flex items-center space-x-2">
                        <span class="inline-block px-2 py-1 text-xs font-semibold rounded-full bg-indigo-100 text-indigo-800">${(node.protocol || 'N/A').toUpperCase()}</span>
                        <button onclick="copyToClipboard('${node.node_url}')" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons text-gray-600 text-base">content_copy</span></button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function updatePagination() {
        const paginationElement = document.getElementById('node-pagination');
        const totalPages = Math.ceil(filteredNodes.length / nodesPerPage);
        if (totalPages <= 1) {
            paginationElement.innerHTML = '';
            return;
        }
        // ... implementation for pagination buttons
    }

    function updateNodeCountBadge(count) {
        document.getElementById('node-count-badge').textContent = `总计: ${count}`;
    }

    async function refreshAllSources() {
         if (!confirm("确定要刷新所有订阅源吗？")) return;
         // In a real app, you might want to show a loading state
         const result = await apiRequest('/api/subscription-sources/refresh-all', 'POST'); // Assuming a new batch-refresh endpoint
         if (result.ok) {
            showGlobalAlert('所有订阅源刷新任务已启动。', 'success');
            setTimeout(() => { loadSubscriptionSources(); loadNodePool(); }, 5000);
         } else {
            showGlobalAlert('启动刷新任务失败。', 'danger');
         }
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showGlobalAlert('已复制到剪贴板!', 'success');
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        checkLoginStatus();
    });
    </script>
</body>
</html>
