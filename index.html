<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢é˜…èšåˆç®¡ç†å¹³å° V2.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .node-generator-card { margin-bottom: 1rem; }
        .save-to-tag-section { background-color: #f8f9fa; padding: 1rem; border-radius: 0.375rem; }
        .estimation { font-weight: bold; color: #0d6efd; text-align: center; padding: 0.5rem; background-color: #e7f3ff; border-radius: 0.25rem; }
        #region-selector { display: flex; flex-wrap: wrap; gap: 10px 20px; padding: 10px; border: 1px solid #e0e0e0; border-radius: 5px; }
        .region-checkbox { display: flex; align-items: center; }
        .region-checkbox label { margin-bottom: 0; margin-left: 5px; font-weight: normal;}
        .ip-version-selector { background-color: #f8f9fa; border: 1px solid #dee2e6; }
        .ip-version-selector .form-check-label { font-size: 0.95rem; }
        .ip-version-selector .form-check { margin-right: 1rem; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">ğŸ“¡ è®¢é˜…èšåˆç®¡ç†å¹³å° V2.0</a>
            <div id="user-status-area">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#authModal">ç™»å½• / æ³¨å†Œ</button>
            </div>
        </div>
    </nav>

    <!-- Login Prompt -->
    <div id="login-prompt" class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8 text-center">
                <h1 class="display-4">ğŸ·ï¸ è®¢é˜…èšåˆç®¡ç†å¹³å°</h1>
                <p class="lead">åŸºäºTagçš„æ™ºèƒ½èŠ‚ç‚¹ç®¡ç†ç³»ç»Ÿ</p>
                <div class="card mt-4">
                    <div class="card-body">
                        <h5 class="card-title">âœ¨ ä¸»è¦åŠŸèƒ½</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="list-unstyled text-start">
                                    <li>ğŸ·ï¸ <strong>Tagç®¡ç†</strong> - æŒ‰ç”¨é€”åˆ†ç±»èŠ‚ç‚¹</li>
                                    <li>âš¡ <strong>èŠ‚ç‚¹ç”Ÿæˆ</strong> - æ‰¹é‡ç”ŸæˆèŠ‚ç‚¹</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="list-unstyled text-start">
                                    <li>ğŸ“¡ <strong>è®¢é˜…æº</strong> - å¯¼å…¥å¤–éƒ¨è®¢é˜…</li>
                                    <li>ğŸ”„ <strong>çŠ¶æ€åé¦ˆ</strong> - æ™ºèƒ½èŠ‚ç‚¹ä¼˜åŒ–</li>
                                </ul>
                            </div>
                        </div>
                        <button class="btn btn-primary btn-lg mt-3" data-bs-toggle="modal" data-bs-target="#authModal">
                            ç«‹å³å¼€å§‹ä½¿ç”¨
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" style="display: none;">
        <div class="container my-4">
            <!-- Tab Navigation -->
            <ul class="nav nav-tabs" id="mainTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="tag-management-tab" data-bs-toggle="tab" data-bs-target="#tag-management-tab-pane" type="button" role="tab">ğŸ·ï¸ Tagç®¡ç†</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="generator-tab" data-bs-toggle="tab" data-bs-target="#generator-tab-pane" type="button" role="tab">âš¡ èŠ‚ç‚¹ç”Ÿæˆå™¨</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="manager-tab" data-bs-toggle="tab" data-bs-target="#manager-tab-pane" type="button" role="tab">ğŸ“¡ è®¢é˜…æºç®¡ç†</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="source-nodes-tab" data-bs-toggle="tab" data-bs-target="#source-nodes-tab-pane" type="button" role="tab">ğŸ”§ æºèŠ‚ç‚¹ç®¡ç†</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="nodepool-tab" data-bs-toggle="tab" data-bs-target="#nodepool-tab-pane" type="button" role="tab">ğŸ¯ èŠ‚ç‚¹æ± ç®¡ç†</button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="mainTabContent">
                <!-- Tag Management Tab -->
                <div class="tab-pane fade show active" id="tag-management-tab-pane" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>ğŸ·ï¸ æˆ‘çš„Tagç®¡ç†</span>
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createTagModal">+ åˆ›å»ºæ–°Tag</button>
                        </div>
                        <div class="card-body">
                            <div id="tags-list" class="mb-4">
                                <div class="text-center p-3 text-muted">æ­£åœ¨åŠ è½½Tag...</div>
                            </div>
                            
                            <!-- èŠ‚ç‚¹æ‰¹é‡æ“ä½œåŒºåŸŸ -->
                            <div class="border-top pt-4">
                                <h5 class="mb-3">ğŸ”„ èŠ‚ç‚¹æ‰¹é‡æ“ä½œ</h5>
                                <div class="alert alert-info" id="batch-operation-guide">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <strong>ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼š</strong>
                                            <ol class="mb-0 mt-2">
                                                <li><strong>å‹¾é€‰Tag</strong>ï¼šåœ¨ä¸Šæ–¹Tagå¡ç‰‡ä¸­å‹¾é€‰è¦æ“ä½œçš„Tagï¼ˆå¯å¤šé€‰ï¼‰</li>
                                                <li><strong>ç²˜è´´èŠ‚ç‚¹</strong>ï¼šå°†èŠ‚ç‚¹é“¾æ¥ç²˜è´´åˆ°ä¸‹æ–¹æ–‡æœ¬æ¡†</li>
                                                <li><strong>é€‰æ‹©æ“ä½œ</strong>ï¼šæ·»åŠ åˆ°é€‰ä¸­Tagæˆ–ä»é€‰ä¸­Tagåˆ é™¤</li>
                                            </ol>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="collapseAlert('batch-operation-guide')">
                                            ç¡®å®š
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="node-feedback-textarea" class="form-label"><strong>ğŸ“ èŠ‚ç‚¹åˆ—è¡¨</strong></label>
                                    <textarea class="form-control" id="node-feedback-textarea" rows="6" 
                                              placeholder="å°†èŠ‚ç‚¹é“¾æ¥ç²˜è´´åˆ°æ­¤å¤„ï¼Œæ¯è¡Œä¸€ä¸ª...&#10;&#10;ç¤ºä¾‹ï¼š&#10;vless://uuid@server:port?params#name&#10;vmess://base64data"></textarea>
                                </div>
                                
                                <div class="d-flex gap-2 flex-wrap">
                                    <button class="btn btn-success" onclick="batchOperateNodes('add')">
                                        âœ… æ·»åŠ åˆ°é€‰ä¸­Tag
                                    </button>
                                    <button class="btn btn-danger" onclick="batchOperateNodes('delete')">
                                        ğŸ—‘ï¸ ä»é€‰ä¸­Tagåˆ é™¤
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="clearNodeTextarea()">
                                        ğŸ§¹ æ¸…ç©ºæ–‡æœ¬æ¡†
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Node Generator Tab -->
                <div class="tab-pane fade" id="generator-tab-pane" role="tabpanel">
                    <div class="text-center mb-4 mt-3">
                        <h1 class="display-5">âš¡ ç»ˆæèŠ‚ç‚¹ç”Ÿæˆå™¨</h1>
                        <p class="lead text-muted">ä¸€ä¸ªå¼ºå¤§ã€çµæ´»çš„åœ¨çº¿èŠ‚ç‚¹æ‰¹é‡ç”Ÿæˆå·¥å…·</p>
                    </div>

                    <div class="alert alert-info" id="usage-guide">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h4 class="alert-heading">ğŸ“– ä½¿ç”¨è¯´æ˜</h4>
                                <ol class="mb-3">
                                    <li>åœ¨"ç¬¬ä¸€æ­¥"åŒºåŸŸï¼Œé€‰æ‹©"å†…ç½®æ•°æ®"æˆ–"æ‰‹åŠ¨ç²˜è´´"æ¥æä¾›åœ°å€ã€‚</li>
                                    <li>åœ¨"ç¬¬äºŒæ­¥"ç²˜è´´ä¸€ä¸ª VLESS æˆ– VMess é“¾æ¥ä½œä¸ºæ¨¡æ¿ã€‚</li>
                                    <li>ç‚¹å‡»"ç”ŸæˆèŠ‚ç‚¹"å³å¯è·å–å¤šä¸ªèŠ‚ç‚¹é“¾æ¥ã€‚</li>
                                    <li><strong>V2.0æ–°åŠŸèƒ½ï¼š</strong>ç”Ÿæˆåå¯ä»¥å°†èŠ‚ç‚¹ä¿å­˜åˆ°Tagä¸­è¿›è¡Œåˆ†ç±»ç®¡ç†ã€‚</li>
                                </ol>
                                
                                <div class="alert alert-warning mb-0">
                                    <h6 class="alert-heading">âš ï¸ ç«¯å£é€‰æ‹©é‡è¦æç¤º</h6>
                                    <ul class="mb-0">
                                        <li><strong>å›½å†…ç½‘ç»œç¯å¢ƒï¼š</strong>
                                            <ul>
                                                <li><strong>IPv4</strong>ï¼šå»ºè®®ä»…é€‰æ‹© <code>443</code> ç«¯å£ï¼Œå…¶ä»–ç«¯å£å¤§éƒ¨åˆ†è¢«è¿è¥å•†å°é”</li>
                                                <li><strong>IPv6</strong>ï¼šå¯é€‰æ‹©å¤šä¸ªç«¯å£ï¼Œè¿é€šæ€§ç›¸å¯¹è¾ƒå¥½</li>
                                            </ul>
                                        </li>
                                        <li><strong>æµ·å¤–CFç½‘æ®µï¼š</strong>IPv4ä¼˜å…ˆæµ‹è¯• <code>443</code> ç«¯å£ï¼ŒIPv6å¯å¤šç«¯å£æµ‹è¯•</li>
                                        <li><strong>æ¨èç­–ç•¥ï¼š</strong>é¦–æ¬¡æµ‹è¯•åªé€‰ <code>443</code> ç«¯å£ï¼Œç¡®è®¤å¯ç”¨åå†å°è¯•å…¶ä»–ç«¯å£</li>
                                        <li><strong>æç¤ºï¼š</strong>å†…ç½®æ•°æ®æºé»˜è®¤åªé€‰æ‹© <code>443</code> ç«¯å£ï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´</li>
                                    </ul>
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-3" onclick="collapseAlert('usage-guide')">
                                ç¡®å®š
                            </button>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header">ç¬¬ä¸€æ­¥ï¼šæä¾›æ•°æ®æº</div>
                        <div class="card-body">
                            <ul class="nav nav-tabs" id="sourceTab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="builtin-tab" data-bs-toggle="tab" data-bs-target="#builtin-tab-pane" type="button" onclick="updateEstimation()">å†…ç½®åœ°åŒºæ•°æ®</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual-tab-pane" type="button" onclick="updateEstimation()">è‡ªå®šä¹‰ç²˜è´´æ•°æ®</button>
                                </li>
                            </ul>
                            <div class="tab-content" id="sourceTabContent">
                                <div class="tab-pane fade show active p-3" id="builtin-tab-pane" role="tabpanel">
                                    <p class="text-muted">è¯·å‹¾é€‰æ‚¨æƒ³ä½¿ç”¨çš„å†…ç½®æ•°æ®æºï¼š</p>
                                    
                                    <!-- IPç‰ˆæœ¬é€‰æ‹© -->
                                    <div class="mb-3 p-3 ip-version-selector rounded">
                                        <label class="form-label fw-bold mb-2">ğŸŒ IPç‰ˆæœ¬é€‰æ‹©ï¼š</label>
                                        <div class="d-flex flex-wrap gap-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="useIPv4" checked onchange="updateEstimation()">
                                                <label class="form-check-label" for="useIPv4">
                                                    <strong>IPv4</strong> <small class="text-muted">(é€‚ç”¨äºå¤§éƒ¨åˆ†ç½‘ç»œ)</small>
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="useIPv6" checked onchange="updateEstimation()">
                                                <label class="form-check-label" for="useIPv6">
                                                    <strong>IPv6</strong> <small class="text-muted">(ç°ä»£ç½‘ç»œæ”¯æŒ)</small>
                                                </label>
                                            </div>
                                        </div>
                                        <small class="text-muted d-block mt-1">ğŸ’¡ æç¤ºï¼šå¯ä»¥åŒæ—¶é€‰æ‹©ä¸¤ç§ç‰ˆæœ¬ï¼Œæˆ–æ ¹æ®ç½‘ç»œç¯å¢ƒé€‰æ‹©å…¶ä¸­ä¸€ç§</small>
                                    </div>
                                    
                                    <!-- åœ°åŒºé€‰æ‹© -->
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">ğŸŒ åœ°åŒºé€‰æ‹©ï¼š</label>
                                        <div id="region-selector"><!-- Region checkboxes will be inserted here --></div>
                                    </div>
                                    
                                    <!-- HTTPSç«¯å£é€‰æ‹© -->
                                    <div class="mb-3 p-3 port-selector rounded border">
                                        <label class="form-label fw-bold mb-2">ğŸ”Œ HTTPSç«¯å£é€‰æ‹©ï¼š</label>
                                        <div class="row" id="builtin-https-port-selector">
                                            <!-- ç«¯å£é€‰æ‹©æ¡†å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                                        </div>
                                        <div class="alert alert-warning mt-3 mb-0" id="builtin-port-tips">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <strong>âš ï¸ é‡è¦æç¤ºï¼š</strong><br>
                                                    â€¢ <strong>å›½å†…IPv4</strong>ï¼šå»ºè®®ä»…é€‰æ‹© <code>443</code> ç«¯å£ï¼Œå…¶ä»–ç«¯å£å¯èƒ½è¢«å°é”<br>
                                                    â€¢ <strong>å›½å†…IPv6</strong>ï¼šå¯é€‰æ‹©å¤šä¸ªç«¯å£ï¼Œè¿é€šæ€§è¾ƒå¥½<br>
                                                    â€¢ <strong>æµ·å¤–CFç½‘æ®µ</strong>ï¼šIPv4ä¼˜å…ˆæµ‹è¯• <code>443</code> ç«¯å£ï¼ŒIPv6å¯å¤šç«¯å£æµ‹è¯•<br>
                                                    â€¢ <strong>å»ºè®®ç­–ç•¥</strong>ï¼šé¦–æ¬¡æµ‹è¯•åªé€‰ <code>443</code>ï¼Œç¡®è®¤å¯ç”¨åå†å°è¯•å…¶ä»–ç«¯å£
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="collapseAlert('builtin-port-tips')">
                                                    ç¡®å®š
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade p-3" id="manual-tab-pane" role="tabpanel">
                                    <div class="mb-3">
                                        <label for="customData" class="form-label"><strong>è‡ªå®šä¹‰åœ°å€ (IPã€CIDR æˆ–åŸŸåï¼Œæ¯è¡Œä¸€ä¸ª):</strong></label>
                                        <textarea class="form-control" id="customData" rows="6" oninput="updateEstimation()" placeholder="ç¤ºä¾‹ï¼š&#10;104.28.43.45/32&#10;192.168.1.0/24&#10;2a09:bac1:19c0:10::/64&#10;example.com"></textarea>
                                        <div class="mt-2">
                                            <button type="button" class="btn btn-sm btn-outline-info" onclick="testCIDRParsing()">ğŸ”§ æµ‹è¯•CIDRè§£æ (æŸ¥çœ‹æ§åˆ¶å°)</button>
                                            <small class="text-muted ms-2">ç‚¹å‡»åè¯·æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹æµ‹è¯•ç»“æœ</small>
                                        </div>
                                    </div>
                                    
                                    <!-- HTTPSç«¯å£é€‰æ‹© -->
                                    <div class="mb-3 p-3 port-selector rounded border">
                                        <label class="form-label fw-bold mb-2">ğŸ”Œ HTTPSç«¯å£é€‰æ‹©ï¼š</label>
                                        <div class="row" id="https-port-selector">
                                            <!-- ç«¯å£é€‰æ‹©æ¡†å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                                        </div>
                                        <div class="alert alert-info mt-2 mb-0" id="custom-port-tips">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <small>ğŸ’¡ <strong>æç¤ºï¼š</strong>é€‰æ‹©çš„ç«¯å£å°†ä¸åœ°å€ç»„åˆç”ŸæˆèŠ‚ç‚¹ï¼Œå»ºè®®ä¿æŒé»˜è®¤å…¨é€‰</small>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="collapseAlert('custom-port-tips')">
                                                    ç¡®å®š
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header">ç¬¬äºŒæ­¥ï¼šè®¾ç½®æ¨¡æ¿å’Œé€‰é¡¹</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="templateUrl" class="form-label"><strong>ç²˜è´´æºèŠ‚ç‚¹ (VLESS æˆ–ä»»æ„æ ¼å¼ VMess)</strong></label>
                                <input type="text" class="form-control" id="templateUrl" placeholder="vless://... æˆ– vmess://...">
                            </div>
                            <div class="mt-3">
                                <label class="form-label"><strong>é€‰æ‹©è¾“å‡ºæ ¼å¼:</strong></label>
                                <div id="format-selector">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="outputFormat" id="formatVless" value="vless">
                                        <label class="form-check-label" for="formatVless">VLESS</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="outputFormat" id="formatVmessJson" value="vmess_json" checked>
                                        <label class="form-check-label" for="formatVmessJson">VMess (for v2rayN/U)</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="outputFormat" id="formatVmessQuery" value="vmess_query">
                                        <label class="form-check-label" for="formatVmessQuery">VMess (for Shadowrocket)</label>
                                    </div>
                                </div>
                            </div>
                            <div id="estimation" class="alert alert-info estimation">
                                <strong>å‡†å¤‡å°±ç»ª</strong><br>
                                <small class="text-muted">è¯·å…ˆé…ç½®æ•°æ®æºå’Œæ¨¡æ¿</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header">ç¬¬ä¸‰æ­¥ï¼šç”ŸæˆèŠ‚ç‚¹</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="quantity" class="form-label">ç”Ÿæˆæ•°é‡:</label>
                                <input type="number" class="form-control" id="quantity" value="20" min="1" oninput="validateQuantityInput()" onchange="validateQuantityInput()">
                                <div class="form-text">å»ºè®®æ ¹æ®ä¸Šæ–¹æ˜¾ç¤ºçš„æœ€å¤§å¯ç”Ÿæˆæ•°é‡æ¥è®¾ç½®</div>
                            </div>
                            <div class="d-grid">
                                <button class="btn btn-primary btn-lg" onclick="generateNodes()">ç”ŸæˆèŠ‚ç‚¹</button>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">ç”Ÿæˆç»“æœ</div>
                        <div class="card-body">
                            <textarea class="form-control" id="output" rows="10" readonly></textarea>
                            <div class="d-flex mt-3 gap-2">
                                <button class="btn btn-success w-100" id="copyButton" onclick="copyResults()">ä¸€é”®å¤åˆ¶</button>
                            </div>
                            
                            <!-- Save to Tag Section -->
                            <div class="save-to-tag-section mt-4">
                                <h5 class="mb-3">ğŸ’¾ å°†è¿™äº›èŠ‚ç‚¹å­˜å…¥Tag</h5>
                                <div class="row g-2 mb-3">
                                    <div class="col-md-6">
                                        <label for="existing-tag-select" class="form-label">é€‰æ‹©å·²æœ‰Tag</label>
                                        <select class="form-select" id="existing-tag-select">
                                            <option value="">-- é€‰æ‹©ä¸€ä¸ªå·²æœ‰Tag --</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="new-tag-input" class="form-label">æˆ–åˆ›å»ºæ–°Tag</label>
                                        <input type="text" class="form-control" id="new-tag-input" placeholder="è¾“å…¥æ–°Tagåç§°...">
                                    </div>
                                </div>
                                <div class="d-grid">
                                    <button class="btn btn-primary" onclick="saveNodesToTag()">ğŸ·ï¸ å­˜å…¥Tag</button>
                                </div>
                                <div id="save-tag-result" class="mt-2" style="display: none;"></div>
                            </div>
                            
                            <div class="mt-3" id="sub-result-area" style="display:none;">
                                <div class="alert alert-success">
                                    <h4 class="alert-heading">ğŸš€ æ‚¨çš„ä¸“å±è®¢é˜…å·²æ›´æ–°ï¼</h4>
                                    <p>æ‚¨çš„æ°¸ä¹…è®¢é˜…é“¾æ¥å·²åŒ…å«æœ€æ–°ç”Ÿæˆçš„èŠ‚ç‚¹ã€‚æ‚¨åªéœ€åœ¨å®¢æˆ·ç«¯æ›´æ–°è®¢é˜…å³å¯ï¼Œæ— éœ€æ›´æ¢é“¾æ¥ã€‚</p>
                                    <hr>
                                    <p class="mb-0">è¯·å°†ä»¥ä¸‹é“¾æ¥é…ç½®åˆ°æ‚¨çš„å®¢æˆ·ç«¯ä¸­ï¼š</p>
                                </div>
                                <ul class="list-group">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>æ ‡å‡†æ ¼å¼ (V2Ray)</strong>
                                            <small class="d-block text-muted" id="subLinkBase64"></small>
                                        </div>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('subLinkBase64')">å¤åˆ¶</button>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>Clash æ ¼å¼</strong>
                                            <small class="d-block text-muted" id="subLinkClash"></small>
                                        </div>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('subLinkClash')">å¤åˆ¶</button>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Subscription Sources Tab -->
                <div class="tab-pane fade" id="manager-tab-pane" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>ğŸ“¡ æˆ‘çš„è®¢é˜…æº</span>
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addSourceModal">+ æ·»åŠ æ–°è®¢é˜…æº</button>
                        </div>
                        <div class="card-body">
                            <div id="subscription-sources-list" class="list-group">
                                <div class="text-center p-3 text-muted">æ­£åœ¨åŠ è½½è®¢é˜…æº...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Source Nodes Management Tab -->
                <div class="tab-pane fade" id="source-nodes-tab-pane" role="tabpanel">
                    <div class="text-center mb-4 mt-3">
                        <h1 class="display-5">ğŸ”§ æºèŠ‚ç‚¹ç®¡ç†</h1>
                        <p class="lead text-muted">NAT64 å’Œ ProxyIP æºèŠ‚ç‚¹ç”Ÿæˆä¸ç®¡ç†</p>
                    </div>

                    <!-- é»˜è®¤æºèŠ‚ç‚¹æ˜¾ç¤ºåŒºåŸŸ -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">ğŸŒŸ é»˜è®¤æºèŠ‚ç‚¹</h5>
                            <small class="text-muted">ç³»ç»Ÿä¸ºæ‚¨è‡ªåŠ¨åˆ›å»ºçš„åŸºç¡€æºèŠ‚ç‚¹ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨æˆ–åŸºäºå®ƒä»¬æ‰©å±•æ›´å¤šèŠ‚ç‚¹</small>
                        </div>
                        <div class="card-body">
                            <div id="default-source-nodes">
                                <div class="text-center p-3 text-muted">æ­£åœ¨åŠ è½½é»˜è®¤æºèŠ‚ç‚¹...</div>
                            </div>
                        </div>
                    </div>

                    <!-- æºèŠ‚ç‚¹é…ç½®å™¨ -->
                    <div class="row">
                        <!-- NAT64 æºèŠ‚ç‚¹é…ç½® -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">ğŸŒ NAT64 æºèŠ‚ç‚¹é…ç½®</h5>
                                    <small>é…ç½®NAT64ç±»å‹çš„æºèŠ‚ç‚¹ï¼Œä¿å­˜åè‡ªåŠ¨æ·»åŠ åˆ°èŠ‚ç‚¹æ± </small>
                                </div>
                                <div class="card-body">
                                    <form id="nat64-form">
                                        <div class="mb-3">
                                            <label for="nat64-name" class="form-label">é…ç½®åç§°</label>
                                            <input type="text" class="form-control" id="nat64-name" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„NAT64èŠ‚ç‚¹">
                                        </div>
                                        <div class="mb-3">
                                            <label for="nat64-domain" class="form-label">åŸŸå</label>
                                            <input type="text" class="form-control" id="nat64-domain" placeholder="your-worker.workers.dev" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="nat64-uuid" class="form-label">UUID</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="nat64-uuid" placeholder="ç‚¹å‡»ç”ŸæˆUUID">
                                                <button class="btn btn-outline-secondary" type="button" onclick="generateUUID('nat64-uuid')">ç”Ÿæˆ</button>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="nat64-prefix" class="form-label">NAT64å‰ç¼€</label>
                                            <select class="form-select" id="nat64-prefix">
                                                <option value="2602:fc59:b0:64::">2602:fc59:b0:64:: (é»˜è®¤)</option>
                                                <option value="64:ff9b::">64:ff9b:: (Google Public)</option>
                                                <option value="2001:67c:2b0::">2001:67c:2b0:: (TREX.CZ)</option>
                                                <option value="2001:67c:27e4:1064::">2001:67c:27e4:1064:: (go6lab)</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="nat64-auto-fallback" checked>
                                                <label class="form-check-label" for="nat64-auto-fallback">
                                                    å¯ç”¨è‡ªåŠ¨å›é€€
                                                </label>
                                            </div>
                                        </div>
                                        <div class="d-grid gap-2">
                                            <button type="button" class="btn btn-primary" onclick="generateNAT64Node()">ğŸ”§ é…ç½®NAT64æºèŠ‚ç‚¹</button>
                                            <button type="button" class="btn btn-success" onclick="saveNAT64Config()" style="display: none;" id="save-nat64-btn">ğŸ’¾ ä¿å­˜å¹¶æ·»åŠ åˆ°èŠ‚ç‚¹æ± </button>
                                        </div>
                                    </form>
                                    <div class="mt-3" id="nat64-result-area" style="display: none;">
                                        <label for="nat64-result" class="form-label">ç”Ÿæˆçš„æºèŠ‚ç‚¹</label>
                                        <div class="input-group">
                                            <textarea class="form-control" id="nat64-result" rows="3" readonly></textarea>
                                            <button class="btn btn-outline-primary" type="button" onclick="copyToClipboard('nat64-result')">ğŸ“‹</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ProxyIP æºèŠ‚ç‚¹é…ç½® -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">ğŸŒ ProxyIP æºèŠ‚ç‚¹é…ç½®</h5>
                                    <small>é…ç½®ProxyIPç±»å‹çš„æºèŠ‚ç‚¹ï¼Œä¿å­˜åè‡ªåŠ¨æ·»åŠ åˆ°èŠ‚ç‚¹æ± </small>
                                </div>
                                <div class="card-body">
                                    <form id="proxyip-form">
                                        <div class="mb-3">
                                            <label for="proxyip-name" class="form-label">é…ç½®åç§°</label>
                                            <input type="text" class="form-control" id="proxyip-name" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ProxyIPèŠ‚ç‚¹">
                                        </div>
                                        <div class="mb-3">
                                            <label for="proxyip-domain" class="form-label">åŸŸå</label>
                                            <input type="text" class="form-control" id="proxyip-domain" placeholder="your-worker.workers.dev" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="proxyip-uuid" class="form-label">UUID</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="proxyip-uuid" placeholder="ç‚¹å‡»ç”ŸæˆUUID">
                                                <button class="btn btn-outline-secondary" type="button" onclick="generateUUID('proxyip-uuid')">ç”Ÿæˆ</button>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="proxyip-address" class="form-label">ä»£ç†IPåœ°å€</label>
                                            <input type="text" class="form-control" id="proxyip-address" placeholder="ä¾‹å¦‚ï¼š1.2.3.4 æˆ–ç•™ç©ºä½¿ç”¨é»˜è®¤">
                                        </div>
                                        <div class="mb-3">
                                            <label for="proxyip-port" class="form-label">ä»£ç†ç«¯å£</label>
                                            <input type="number" class="form-control" id="proxyip-port" value="443" min="1" max="65535">
                                        </div>
                                        <div class="d-grid gap-2">
                                            <button type="button" class="btn btn-success" onclick="generateProxyIPNode()">ğŸ”§ é…ç½®ProxyIPæºèŠ‚ç‚¹</button>
                                            <button type="button" class="btn btn-primary" onclick="saveProxyIPConfig()" style="display: none;" id="save-proxyip-btn">ğŸ’¾ ä¿å­˜å¹¶æ·»åŠ åˆ°èŠ‚ç‚¹æ± </button>
                                        </div>
                                    </form>
                                    <div class="mt-3" id="proxyip-result-area" style="display: none;">
                                        <label for="proxyip-result" class="form-label">ç”Ÿæˆçš„æºèŠ‚ç‚¹</label>
                                        <div class="input-group">
                                            <textarea class="form-control" id="proxyip-result" rows="3" readonly></textarea>
                                            <button class="btn btn-outline-primary" type="button" onclick="copyToClipboard('proxyip-result')">ğŸ“‹</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è‡ªå®šä¹‰æºèŠ‚ç‚¹é…ç½®åˆ—è¡¨ -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">ğŸ“‹ æˆ‘çš„æºèŠ‚ç‚¹é…ç½®</h5>
                            <button class="btn btn-outline-primary btn-sm" onclick="refreshSourceNodes()">ğŸ”„ åˆ·æ–°</button>
                        </div>
                        <div class="card-body">
                            <div id="custom-source-nodes">
                                <div class="text-center p-3 text-muted">æ­£åœ¨åŠ è½½æºèŠ‚ç‚¹é…ç½®...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Node Pool Tab -->
                <div class="tab-pane fade" id="nodepool-tab-pane" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>ğŸ¯ æˆ‘çš„èŠ‚ç‚¹æ± </span>
                            <div>
                                <span id="node-count-badge" class="badge bg-info me-2">æ€»è®¡: 0</span>
                                <button class="btn btn-outline-primary btn-sm" onclick="refreshAllSources()">ğŸ”„ åˆ·æ–°æ‰€æœ‰æº</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text">ğŸ”</span>
                                        <input type="text" class="form-control" id="node-search" placeholder="æœç´¢èŠ‚ç‚¹åç§°æˆ–æ¥æº..." oninput="filterNodes()">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="source-filter" onchange="filterNodes()">
                                        <option value="">æ‰€æœ‰æ¥æº</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="protocol-filter" onchange="filterNodes()">
                                        <option value="">æ‰€æœ‰åè®®</option>
                                        <option value="vmess">VMess</option>
                                        <option value="vless">VLESS</option>
                                        <option value="trojan">Trojan</option>
                                        <option value="ss">Shadowsocks</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div id="node-pool-list" class="list-group">
                                <div class="text-center p-3 text-muted">æ­£åœ¨åŠ è½½èŠ‚ç‚¹...</div>
                            </div>
                            
                            <nav aria-label="èŠ‚ç‚¹åˆ†é¡µ" class="mt-3">
                                <ul class="pagination justify-content-center" id="node-pagination"></ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Auth Modal -->
    <div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="authModalLabel">ç”¨æˆ·ç™»å½•</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="auth-alert" class="alert" style="display: none;"></div>
                    <div class="mb-3">
                        <label for="username" class="form-label">ç”¨æˆ·å</label>
                        <input type="text" class="form-control" id="username" required autocomplete="username">
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">å¯†ç </label>
                        <input type="password" class="form-control" id="password" required autocomplete="current-password">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="switchAuthMode()">åˆ‡æ¢åˆ°æ³¨å†Œ</button>
                    <button type="button" class="btn btn-primary" onclick="performAuth()">ç™»å½•</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Tag Modal -->
    <div class="modal fade" id="createTagModal" tabindex="-1" aria-labelledby="createTagModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createTagModalLabel">åˆ›å»ºæ–°Tag</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="create-tag-alert" class="alert" style="display: none;"></div>
                    <div class="mb-3">
                        <label for="tagName" class="form-label">Tagåç§° <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="tagName" required placeholder="ä¾‹å¦‚: æ¸¸æˆä¸“ç”¨, ä¸»åŠ›èŠ‚ç‚¹">
                        <div class="form-text">ç”¨äºåˆ†ç±»ç®¡ç†æ‚¨çš„èŠ‚ç‚¹ï¼Œå¦‚ï¼šæ¸¸æˆä¸“ç”¨ã€ä¸»åŠ›èŠ‚ç‚¹ã€å¤‡ç”¨çº¿è·¯ç­‰</div>
                    </div>
                    <div class="mb-3">
                        <label for="tagDescription" class="form-label">æè¿° (å¯é€‰)</label>
                        <textarea class="form-control" id="tagDescription" rows="2" placeholder="ç®€å•æè¿°è¿™ä¸ªTagçš„ç”¨é€”..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="createNewTag()">åˆ›å»ºTag</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Source Modal -->
    <div class="modal fade" id="addSourceModal" tabindex="-1" aria-labelledby="addSourceModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSourceModalLabel">æ·»åŠ æ–°è®¢é˜…æº</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="add-source-alert" class="alert" style="display: none;"></div>
                    <div class="mb-3">
                        <label for="sourceName" class="form-label">è®¢é˜…åç§° (ä¾‹å¦‚: æœºåœºA)</label>
                        <input type="text" class="form-control" id="sourceName" required>
                    </div>
                    <div class="mb-3">
                        <label for="sourceUrl" class="form-label">è®¢é˜…é“¾æ¥ (URL)</label>
                        <input type="url" class="form-control" id="sourceUrl" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="addSubscriptionSource()">ç¡®è®¤æ·»åŠ </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="data.js"></script>
    <script>
        // =================================================================
        // å…¨å±€å˜é‡å’ŒçŠ¶æ€ç®¡ç†
        // =================================================================
        let currentUser = null;
        let authModal, createTagModal, addSourceModal;
        let isLoginMode = true;
        let allTags = [];
        let allNodes = [];
        let filteredNodes = [];
        let currentPage = 1;
        const nodesPerPage = 20;

        // =================================================================
        // æ ¸å¿ƒAPIè¯·æ±‚å‡½æ•°
        // =================================================================
        async function apiRequest(url, method, data = null) {
            const options = {
                method: method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (data) options.body = JSON.stringify(data);
            
            try {
                const response = await fetch(url, options);
                const result = await response.json();
                return { ok: response.ok, data: result, status: response.status };
            } catch (error) {
                console.error('APIè¯·æ±‚å¤±è´¥:', error);
                return { ok: false, data: { error: error.message }, status: 500 };
            }
        }

        // =================================================================
        // æºèŠ‚ç‚¹ç®¡ç†ç›¸å…³å‡½æ•°
        // =================================================================
        
        // UUIDç”Ÿæˆå‡½æ•°
        function generateUUID(inputId) {
            const uuid = crypto.randomUUID();
            document.getElementById(inputId).value = uuid;
        }
        
        // NAT64æºèŠ‚ç‚¹ç”Ÿæˆ
        async function generateNAT64Node() {
            const config = {
                uuid: document.getElementById('nat64-uuid').value,
                domain: document.getElementById('nat64-domain').value,
                nat64Prefix: document.getElementById('nat64-prefix').value,
                autoFallback: document.getElementById('nat64-auto-fallback').checked
            };
            
            if (!config.uuid) {
                generateUUID('nat64-uuid');
                config.uuid = document.getElementById('nat64-uuid').value;
            }
            
            if (!config.domain) {
                showAlert('è¯·è¾“å…¥åŸŸå', 'danger');
                return;
            }
            
            try {
                const result = await apiRequest('/api/generate-source-node', 'POST', {
                    node_type: 'nat64',
                    config_data: config
                });
                
                if (result.ok) {
                    document.getElementById('nat64-result').value = result.data.generated_node;
                    document.getElementById('nat64-result-area').style.display = 'block';
                    document.getElementById('save-nat64-btn').style.display = 'block';
                    showAlert('NAT64æºèŠ‚ç‚¹é…ç½®æˆåŠŸï¼ç‚¹å‡»ä¿å­˜å°†è‡ªåŠ¨æ·»åŠ åˆ°èŠ‚ç‚¹æ± ', 'success');
                } else {
                    showAlert(`é…ç½®å¤±è´¥: ${result.data.error}`, 'danger');
                }
            } catch (error) {
                showAlert(`ç”Ÿæˆå¤±è´¥: ${error.message}`, 'danger');
            }
        }
        
        // ProxyIPæºèŠ‚ç‚¹ç”Ÿæˆ
        async function generateProxyIPNode() {
            const config = {
                uuid: document.getElementById('proxyip-uuid').value,
                domain: document.getElementById('proxyip-domain').value,
                proxyIP: document.getElementById('proxyip-address').value,
                proxyPort: document.getElementById('proxyip-port').value
            };
            
            if (!config.uuid) {
                generateUUID('proxyip-uuid');
                config.uuid = document.getElementById('proxyip-uuid').value;
            }
            
            if (!config.domain) {
                showAlert('è¯·è¾“å…¥åŸŸå', 'danger');
                return;
            }
            
            try {
                const result = await apiRequest('/api/generate-source-node', 'POST', {
                    node_type: 'proxyip',
                    config_data: config
                });
                
                if (result.ok) {
                    document.getElementById('proxyip-result').value = result.data.generated_node;
                    document.getElementById('proxyip-result-area').style.display = 'block';
                    document.getElementById('save-proxyip-btn').style.display = 'block';
                    showAlert('ProxyIPæºèŠ‚ç‚¹é…ç½®æˆåŠŸï¼ç‚¹å‡»ä¿å­˜å°†è‡ªåŠ¨æ·»åŠ åˆ°èŠ‚ç‚¹æ± ', 'success');
                } else {
                    showAlert(`é…ç½®å¤±è´¥: ${result.data.error}`, 'danger');
                }
            } catch (error) {
                showAlert(`ç”Ÿæˆå¤±è´¥: ${error.message}`, 'danger');
            }
        }
        
        // ä¿å­˜NAT64é…ç½®
        async function saveNAT64Config() {
            const configName = document.getElementById('nat64-name').value || 'NAT64é…ç½®';
            const config = {
                uuid: document.getElementById('nat64-uuid').value,
                domain: document.getElementById('nat64-domain').value,
                nat64Prefix: document.getElementById('nat64-prefix').value,
                autoFallback: document.getElementById('nat64-auto-fallback').checked
            };
            
            try {
                const result = await apiRequest('/api/source-nodes', 'POST', {
                    config_name: configName,
                    node_type: 'nat64',
                    config_data: config
                });
                
                if (result.ok) {
                    showAlert('NAT64æºèŠ‚ç‚¹å·²ä¿å­˜å¹¶æ·»åŠ åˆ°èŠ‚ç‚¹æ± ï¼', 'success');
                    document.getElementById('save-nat64-btn').style.display = 'none';
                    refreshSourceNodes();
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('nat64-form').reset();
                    document.getElementById('nat64-result-area').style.display = 'none';
                } else {
                    showAlert(`ä¿å­˜å¤±è´¥: ${result.data.error}`, 'danger');
                }
            } catch (error) {
                showAlert(`ä¿å­˜å¤±è´¥: ${error.message}`, 'danger');
            }
        }
        
        // ä¿å­˜ProxyIPé…ç½®
        async function saveProxyIPConfig() {
            const configName = document.getElementById('proxyip-name').value || 'ProxyIPé…ç½®';
            const config = {
                uuid: document.getElementById('proxyip-uuid').value,
                domain: document.getElementById('proxyip-domain').value,
                proxyIP: document.getElementById('proxyip-address').value,
                proxyPort: document.getElementById('proxyip-port').value
            };
            
            try {
                const result = await apiRequest('/api/source-nodes', 'POST', {
                    config_name: configName,
                    node_type: 'proxyip',
                    config_data: config
                });
                
                if (result.ok) {
                    showAlert('ProxyIPæºèŠ‚ç‚¹å·²ä¿å­˜å¹¶æ·»åŠ åˆ°èŠ‚ç‚¹æ± ï¼', 'success');
                    document.getElementById('save-proxyip-btn').style.display = 'none';
                    refreshSourceNodes();
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('proxyip-form').reset();
                    document.getElementById('proxyip-result-area').style.display = 'none';
                } else {
                    showAlert(`ä¿å­˜å¤±è´¥: ${result.data.error}`, 'danger');
                }
            } catch (error) {
                showAlert(`ä¿å­˜å¤±è´¥: ${error.message}`, 'danger');
            }
        }
        
        // åŠ è½½æºèŠ‚ç‚¹é…ç½®
        async function loadSourceNodes() {
            try {
                const result = await apiRequest('/api/source-nodes', 'GET');
                if (result.ok) {
                    displaySourceNodes(result.data);
                } else {
                    console.error('åŠ è½½æºèŠ‚ç‚¹é…ç½®å¤±è´¥:', result.data.error);
                    document.getElementById('default-source-nodes').innerHTML = 
                        '<div class="text-center p-3 text-danger">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
                    document.getElementById('custom-source-nodes').innerHTML = 
                        '<div class="text-center p-3 text-danger">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
                }
            } catch (error) {
                console.error('åŠ è½½æºèŠ‚ç‚¹é…ç½®å¤±è´¥:', error);
            }
        }
        
        // æ˜¾ç¤ºæºèŠ‚ç‚¹é…ç½®
        function displaySourceNodes(configs) {
            const defaultNodes = configs.filter(config => config.is_default);
            const customNodes = configs.filter(config => !config.is_default);
            
            // æ˜¾ç¤ºé»˜è®¤æºèŠ‚ç‚¹
            displayDefaultNodes(defaultNodes);
            
            // æ˜¾ç¤ºè‡ªå®šä¹‰æºèŠ‚ç‚¹
            displayCustomNodes(customNodes);
        }
        
        // æ˜¾ç¤ºé»˜è®¤æºèŠ‚ç‚¹
        function displayDefaultNodes(defaultNodes) {
            const container = document.getElementById('default-source-nodes');
            
            if (defaultNodes.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <h6>ğŸ”§ è¿˜æ²¡æœ‰é»˜è®¤æºèŠ‚ç‚¹</h6>
                        <p class="mb-0">ç³»ç»Ÿä¼šåœ¨ç”¨æˆ·æ³¨å†Œæ—¶è‡ªåŠ¨åˆ›å»ºé»˜è®¤æºèŠ‚ç‚¹ã€‚å¦‚æœæ‚¨æ˜¯è€ç”¨æˆ·ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = defaultNodes.map(node => {
                const configData = JSON.parse(node.config_data);
                const nodeType = node.node_type.toUpperCase();
                const badgeClass = node.node_type === 'nat64' ? 'bg-primary' : 'bg-success';
                
                return `
                    <div class="card mb-2">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="card-title">
                                        ${node.config_name} 
                                        <span class="badge ${badgeClass}">${nodeType}</span>
                                        <span class="badge bg-info">é»˜è®¤</span>
                                    </h6>
                                    <small class="text-muted">åŸŸå: ${configData.domain}</small>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="copyToClipboard('default-node-${node.id}')">ğŸ“‹</button>
                                    <button class="btn btn-outline-success" onclick="importToGenerator('${node.generated_node}', '${node.node_type}')">ğŸš€ å¯¼å…¥</button>
                                </div>
                            </div>
                            <div class="mt-2">
                                <textarea class="form-control" id="default-node-${node.id}" rows="2" readonly>${node.generated_node}</textarea>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // æ˜¾ç¤ºè‡ªå®šä¹‰æºèŠ‚ç‚¹
        function displayCustomNodes(customNodes) {
            const container = document.getElementById('custom-source-nodes');
            
            if (customNodes.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-3 text-muted">
                        <p>è¿˜æ²¡æœ‰è‡ªå®šä¹‰æºèŠ‚ç‚¹é…ç½®</p>
                        <p>ä½¿ç”¨ä¸Šæ–¹çš„ç”Ÿæˆå™¨åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªæºèŠ‚ç‚¹é…ç½®å§ï¼</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = customNodes.map(node => {
                const configData = JSON.parse(node.config_data);
                const nodeType = node.node_type.toUpperCase();
                const badgeClass = node.node_type === 'nat64' ? 'bg-primary' : 'bg-success';
                const statusBadge = node.enabled ? 
                    '<span class="badge bg-success">å¯ç”¨</span>' : 
                    '<span class="badge bg-secondary">ç¦ç”¨</span>';
                
                return `
                    <div class="card mb-2">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="card-title">
                                        ${node.config_name} 
                                        <span class="badge ${badgeClass}">${nodeType}</span>
                                        ${statusBadge}
                                    </h6>
                                    <small class="text-muted">
                                        åŸŸå: ${configData.domain} | 
                                        åˆ›å»ºæ—¶é—´: ${new Date(node.created_at).toLocaleString()}
                                    </small>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="copyToClipboard('custom-node-${node.id}')">ğŸ“‹</button>
                                    <button class="btn btn-outline-success" onclick="importToGenerator('${node.generated_node}', '${node.node_type}')">ğŸš€ å¯¼å…¥</button>
                                    <button class="btn btn-outline-danger" onclick="deleteSourceNode(${node.id}, '${node.config_name}')">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                            <div class="mt-2">
                                <textarea class="form-control" id="custom-node-${node.id}" rows="2" readonly>${node.generated_node}</textarea>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // å¯¼å…¥åˆ°ç”Ÿæˆå™¨
        function importToGenerator(nodeUrl, nodeType) {
            // è§£æèŠ‚ç‚¹URLè·å–é…ç½®ä¿¡æ¯
            try {
                const url = new URL(nodeUrl);
                const uuid = url.username;
                const domain = url.hostname;
                
                if (nodeType === 'nat64') {
                    document.getElementById('nat64-uuid').value = uuid;
                    document.getElementById('nat64-domain').value = domain;
                    // åˆ‡æ¢åˆ°æºèŠ‚ç‚¹ç®¡ç†æ ‡ç­¾é¡µ
                    document.getElementById('source-nodes-tab').click();
                    showAlert('å·²å¯¼å…¥åˆ°NAT64ç”Ÿæˆå™¨', 'success');
                } else if (nodeType === 'proxyip') {
                    document.getElementById('proxyip-uuid').value = uuid;
                    document.getElementById('proxyip-domain').value = domain;
                    // åˆ‡æ¢åˆ°æºèŠ‚ç‚¹ç®¡ç†æ ‡ç­¾é¡µ
                    document.getElementById('source-nodes-tab').click();
                    showAlert('å·²å¯¼å…¥åˆ°ProxyIPç”Ÿæˆå™¨', 'success');
                }
            } catch (error) {
                showAlert('å¯¼å…¥å¤±è´¥ï¼šèŠ‚ç‚¹æ ¼å¼æ— æ•ˆ', 'danger');
            }
        }
        
        // åˆ é™¤æºèŠ‚ç‚¹é…ç½®
        async function deleteSourceNode(nodeId, nodeName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æºèŠ‚ç‚¹é…ç½® "${nodeName}" å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const result = await apiRequest(`/api/source-nodes/${nodeId}`, 'DELETE');
                if (result.ok) {
                    showAlert('æºèŠ‚ç‚¹é…ç½®åˆ é™¤æˆåŠŸï¼', 'success');
                    refreshSourceNodes();
                } else {
                    showAlert(`åˆ é™¤å¤±è´¥: ${result.data.error}`, 'danger');
                }
            } catch (error) {
                showAlert(`åˆ é™¤å¤±è´¥: ${error.message}`, 'danger');
            }
        }
        
        // åˆ·æ–°æºèŠ‚ç‚¹é…ç½®
        async function refreshSourceNodes() {
            await loadSourceNodes();
        }
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿å‡½æ•°
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.select();
                document.execCommand('copy');
                showAlert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
            }
        }

        // =================================================================
        // ç”¨æˆ·è®¤è¯ç›¸å…³å‡½æ•°
        // =================================================================
        async function checkLoginStatus() {
            console.log('æ£€æŸ¥ç™»å½•çŠ¶æ€...');
            const result = await apiRequest('/api/status', 'GET');
            if (result.ok && result.data.authenticated) {
                currentUser = result.data;
                console.log('ç”¨æˆ·å·²ç™»å½•:', currentUser.username);
            } else {
                currentUser = null;
                console.log('ç”¨æˆ·æœªç™»å½•');
            }
            updateUI();
        }

        function updateUI() {
            const userStatusArea = document.getElementById('user-status-area');
            const mainContent = document.getElementById('main-content');
            const loginPrompt = document.getElementById('login-prompt');

            if (currentUser) {
                if (mainContent) mainContent.style.display = 'block';
                if (loginPrompt) loginPrompt.style.display = 'none';
                if (userStatusArea) {
                    userStatusArea.innerHTML = `
                        <span class="navbar-text me-3">æ¬¢è¿, <strong>${currentUser.username}</strong></span>
                        <button class="btn btn-outline-light" onclick="logout()">ç™»å‡º</button>
                    `;
                }
                // åŠ è½½æ•°æ®
                loadTags();
                loadSubscriptionSources();
                loadSourceNodes(); // åŠ è½½æºèŠ‚ç‚¹é…ç½®
                loadNodePool(); // åŠ è½½èŠ‚ç‚¹æ± 
            } else {
                if (mainContent) mainContent.style.display = 'none';
                if (loginPrompt) loginPrompt.style.display = 'block';
                if (userStatusArea) {
                    userStatusArea.innerHTML = `<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#authModal">ç™»å½• / æ³¨å†Œ</button>`;
                }
            }
        }

        function switchAuthMode() {
            isLoginMode = !isLoginMode;
            const modalTitle = document.getElementById('authModalLabel');
            const submitButton = document.querySelector('#authModal .btn-primary');
            const switchButton = document.querySelector('#authModal .btn-secondary');
            
            if (isLoginMode) {
                modalTitle.textContent = 'ç”¨æˆ·ç™»å½•';
                submitButton.textContent = 'ç™»å½•';
                switchButton.textContent = 'åˆ‡æ¢åˆ°æ³¨å†Œ';
            } else {
                modalTitle.textContent = 'ç”¨æˆ·æ³¨å†Œ';
                submitButton.textContent = 'æ³¨å†Œ';
                switchButton.textContent = 'åˆ‡æ¢åˆ°ç™»å½•';
            }
        }

        async function performAuth() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const alertElement = document.getElementById('auth-alert');

            if (!username || !password) {
                showAlert(alertElement, 'danger', 'ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º');
                return;
            }

            const endpoint = isLoginMode ? '/api/login' : '/api/register';
            const result = await apiRequest(endpoint, 'POST', { username, password });

            if (result.ok) {
                showAlert(alertElement, 'success', result.data.message);
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                
                if (isLoginMode) {
                    setTimeout(() => {
                        authModal.hide();
                        checkLoginStatus();
                    }, 1000);
                }
            } else {
                showAlert(alertElement, 'danger', result.data.error);
            }
        }

        async function logout() {
            await apiRequest('/api/logout', 'POST');
            currentUser = null;
            updateUI();
        }

        function showAlert(element, type, message) {
            element.className = `alert alert-${type}`;
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        // =================================================================
        // Tagç®¡ç†ç›¸å…³å‡½æ•°
        // =================================================================
        async function loadTags() {
            const listElement = document.getElementById('tags-list');
            if (!listElement) return;
            
            listElement.innerHTML = '<div class="text-center p-3 text-muted">æ­£åœ¨åŠ è½½Tag...</div>';
            
            const result = await apiRequest('/api/tags', 'GET');
            
            if (result.ok && Array.isArray(result.data)) {
                allTags = result.data;
                
                // Tagé€‰æ‹©å™¨å·²é›†æˆåˆ°å¡ç‰‡ä¸­ï¼Œæ— éœ€å•ç‹¬æ¸²æŸ“
                
                if (allTags.length === 0) {
                    listElement.innerHTML = '<div class="text-center p-3 text-muted">æ‚¨è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•Tagã€‚ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªTagã€‚</div>';
                    return;
                }
                
                // å°†tagsåˆ†æˆå››åˆ—æ˜¾ç¤ºï¼Œæ›´ç´§å‡‘çš„å¸ƒå±€
                const tagsHTML = allTags.map(tag => `
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center mb-2">
                                    <input class="form-check-input me-2" type="checkbox" id="tag-select-${tag.id}" value="${tag.id}">
                                    <h6 class="card-title mb-0 text-truncate">
                                        ğŸ·ï¸ ${escapeHTML(tag.tag_name)}
                                    </h6>
                                </div>
                                <div class="mb-2">
                                    <span class="badge bg-info me-1">${tag.node_count || 0}ä¸ªèŠ‚ç‚¹</span>
                                    ${tag.active_count > 0 ? `<span class="badge bg-success">${tag.active_count}å¯ç”¨</span>` : ''}
                                </div>
                                ${tag.description ? `<p class="card-text text-muted small mb-2 text-truncate">${escapeHTML(tag.description)}</p>` : ''}
                                <div class="d-grid gap-1">
                                    <button class="btn btn-outline-primary btn-sm" onclick="copyTagSubscription('${tag.tag_uuid}', 'v2ray')">
                                        ğŸ“‹ V2Rayè®¢é˜…
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="copyTagSubscription('${tag.tag_uuid}', 'clash')">
                                        ğŸ“‹ Clashè®¢é˜…
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                listElement.innerHTML = `
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="selectAllTagsInCards(true)">å…¨é€‰Tag</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="selectAllTagsInCards(false)">å–æ¶ˆå…¨é€‰</button>
                        <button type="button" class="btn btn-sm btn-danger" onclick="deleteSelectedTags()">ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­Tag</button>
                    </div>
                    <div class="row">${tagsHTML}</div>
                `;
                
                updateTagDropdown();
            } else {
                listElement.innerHTML = '<div class="text-center p-3 text-danger">åŠ è½½Tagå¤±è´¥ã€‚</div>';
            }
        }

        async function createNewTag() {
            const tagName = document.getElementById('tagName').value.trim();
            const tagDescription = document.getElementById('tagDescription').value.trim();
            const alertElement = document.getElementById('create-tag-alert');

            if (!tagName) {
                showAlert(alertElement, 'danger', 'Tagåç§°ä¸èƒ½ä¸ºç©º');
                return;
            }

            const result = await apiRequest('/api/tags', 'POST', { 
                tag_name: tagName, 
                description: tagDescription 
            });

            if (result.ok) {
                showAlert(alertElement, 'success', result.data.message);
                document.getElementById('tagName').value = '';
                document.getElementById('tagDescription').value = '';
                setTimeout(() => {
                    createTagModal.hide();
                    loadTags();
                }, 1500);
            } else {
                showAlert(alertElement, 'danger', `åˆ›å»ºå¤±è´¥: ${result.data.error}`);
            }
        }

        function updateTagDropdown() {
            const dropdown = document.getElementById('existing-tag-select');
            if (!dropdown) return;
            
            dropdown.innerHTML = '<option value="">-- é€‰æ‹©ä¸€ä¸ªå·²æœ‰Tag --</option>';
            allTags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag.tag_name;
                option.textContent = `${tag.tag_name} (${tag.node_count || 0}ä¸ªèŠ‚ç‚¹)`;
                dropdown.appendChild(option);
            });
        }

        function copyTagSubscription(tagUuid, format) {
            const baseUrl = `${window.location.origin}/sub/tag/${tagUuid}`;
            const url = format === 'clash' ? `${baseUrl}?type=clash` : baseUrl;
            
            const button = event.target;
            const originalText = button.textContent;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(() => {
                    button.textContent = 'âœ… å·²å¤åˆ¶';
                    button.classList.add('btn-success');
                    button.classList.remove('btn-outline-primary', 'btn-outline-secondary');
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('btn-success');
                        button.classList.add(format === 'clash' ? 'btn-outline-secondary' : 'btn-outline-primary');
                    }, 2000);
                }).catch(() => {
                    fallbackCopyTextToClipboard(url, button, originalText);
                });
            } else {
                fallbackCopyTextToClipboard(url, button, originalText);
            }
        }

        async function deleteTag(tagId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªTagå—ï¼Ÿè¿™å°†åŒæ—¶åˆ é™¤Tagä¸èŠ‚ç‚¹çš„å…³è”å…³ç³»ã€‚')) return;
            alert('åˆ é™¤åŠŸèƒ½å°†åœ¨ä¸‹ä¸ªç‰ˆæœ¬å®ç°');
        }

        function escapeHTML(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }

        // =================================================================
        // èŠ‚ç‚¹ç”Ÿæˆå™¨ç›¸å…³å‡½æ•°
        // =================================================================
        function generateNodes() {
            const dataSource = document.querySelector('input[name="dataSource"]:checked').value;
            const templateLink = document.getElementById('templateLink').value.trim();
            
            if (!templateLink) {
                alert('è¯·å…ˆç²˜è´´æ¨¡æ¿é“¾æ¥ï¼');
                return;
            }

            let addresses = [];
            
            if (dataSource === 'builtin') {
                const selectedDataset = document.getElementById('builtInSelect').value;
                if (!selectedDataset) {
                    alert('è¯·é€‰æ‹©ä¸€ä¸ªå†…ç½®æ•°æ®é›†ï¼');
                    return;
                }
                addresses = window.builtInData[selectedDataset] || [];
            } else {
                const customText = document.getElementById('customAddresses').value.trim();
                if (!customText) {
                    alert('è¯·è¾“å…¥è‡ªå®šä¹‰åœ°å€ï¼');
                    return;
                }
                addresses = customText.split('\n').filter(addr => addr.trim());
            }

            if (addresses.length === 0) {
                alert('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„åœ°å€æ•°æ®ï¼');
                return;
            }

            const results = [];
            addresses.forEach(address => {
                const generatedNode = generateSingleNode(templateLink, address.trim());
                if (generatedNode) {
                    results.push(generatedNode);
                }
            });

            document.getElementById('output').value = results.join('\n');
            
            if (results.length > 0) {
                alert(`æˆåŠŸç”Ÿæˆ ${results.length} ä¸ªèŠ‚ç‚¹ï¼`);
            } else {
                alert('ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ¨¡æ¿é“¾æ¥æ ¼å¼ï¼');
            }
        }

        function generateSingleNode(template, newAddress) {
            try {
                if (template.startsWith('vless://')) {
                    const url = new URL(template);
                    url.hostname = newAddress;
                    if (url.hash) {
                        const originalName = decodeURIComponent(url.hash.substring(1));
                        const newName = `${originalName}-${newAddress}`;
                        url.hash = encodeURIComponent(newName);
                    }
                    return url.toString();
                } else if (template.startsWith('vmess://')) {
                    const data = template.substring('vmess://'.length);
                    const decoded = safeBase64Decode(data);
                    const config = JSON.parse(decoded);
                    config.add = newAddress;
                    config.ps = `${config.ps || 'vmess'}-${newAddress}`;
                    return 'vmess://' + safeBase64Encode(JSON.stringify(config));
                }
            } catch (e) {
                console.error('ç”ŸæˆèŠ‚ç‚¹å¤±è´¥:', e);
            }
            return null;
        }

        function copyResults() {
            const output = document.getElementById('output');
            if (!output.value) {
                alert('æ²¡æœ‰å†…å®¹å¯å¤åˆ¶ï¼');
                return;
            }
            
            const button = document.getElementById('copyButton');
            const originalText = button.textContent;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(output.value).then(() => {
                    button.textContent = 'âœ… å·²å¤åˆ¶';
                    button.classList.add('btn-success');
                    button.classList.remove('btn-success');
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('btn-success');
                        button.classList.add('btn-success');
                    }, 2000);
                }).catch(() => {
                    fallbackCopyTextToClipboard(output.value, button, originalText);
                });
            } else {
                fallbackCopyTextToClipboard(output.value, button, originalText);
            }
        }

        async function saveNodesToTag() {
            const outputText = document.getElementById('output').value;
            if (!outputText) {
                alert('è¯·å…ˆç”ŸæˆèŠ‚ç‚¹ï¼');
                return;
            }

            const existingTag = document.getElementById('existing-tag-select').value;
            const newTagName = document.getElementById('new-tag-input').value.trim();
            
            if (!existingTag && !newTagName) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªå·²æœ‰Tagæˆ–è¾“å…¥æ–°Tagåç§°ï¼');
                return;
            }

            const tagName = existingTag || newTagName;
            const nodes = outputText.split('\n').filter(Boolean);
            
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'ä¿å­˜ä¸­...';

            try {
                const result = await apiRequest('/api/tags/add-nodes', 'POST', {
                    tag_name: tagName,
                    nodes: nodes
                });

                const resultDiv = document.getElementById('save-tag-result');
                if (result.ok) {
                    resultDiv.className = 'alert alert-success';
                    resultDiv.textContent = result.data.message;
                    resultDiv.style.display = 'block';
                    
                    document.getElementById('existing-tag-select').value = '';
                    document.getElementById('new-tag-input').value = '';
                    
                    setTimeout(() => {
                        loadTags();
                        resultDiv.style.display = 'none';
                    }, 3000);
                } else {
                    resultDiv.className = 'alert alert-danger';
                    resultDiv.textContent = `ä¿å­˜å¤±è´¥: ${result.data.error}`;
                    resultDiv.style.display = 'block';
                }
            } catch (error) {
                const resultDiv = document.getElementById('save-tag-result');
                resultDiv.className = 'alert alert-danger';
                resultDiv.textContent = `ä¿å­˜å¤±è´¥: ${error.message}`;
                resultDiv.style.display = 'block';
            } finally {
                button.disabled = false;
                button.textContent = originalText;
            }
        }

        // Base64ç¼–ç è§£ç å‡½æ•°
        function safeBase64Encode(str) {
            try {
                return btoa(unescape(encodeURIComponent(str)));
            } catch (e) {
                console.error("Base64 encoding error:", e);
                return null;
            }
        }

        function safeBase64Decode(str) {
            try {
                return decodeURIComponent(escape(atob(str.replace(/-/g, '+').replace(/_/g, '/'))));
            } catch (e) {
                console.error("Base64 decoding error:", e);
                return null;
            }
        }

        // =================================================================
        // è®¢é˜…æºç®¡ç†å’Œå…¶ä»–åŠŸèƒ½
        // =================================================================
        async function loadSubscriptionSources() {
            const listElement = document.getElementById('subscription-sources-list');
            if (!listElement) return;
            
            listElement.innerHTML = '<div class="text-center p-3 text-muted">æ­£åœ¨åŠ è½½è®¢é˜…æº...</div>';
            
            const result = await apiRequest('/api/subscription-sources', 'GET');
            
            if (result.ok && Array.isArray(result.data)) {
                if (result.data.length === 0) {
                    listElement.innerHTML = '<div class="text-center p-3 text-muted">æ‚¨è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•è®¢é˜…æºã€‚</div>';
                    return;
                }
                
                listElement.innerHTML = result.data.map(source => `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">${escapeHTML(source.source_name)}</h5>
                            <small>èŠ‚ç‚¹æ•°: ${source.node_count || 0}</small>
                        </div>
                        <p class="mb-1 small text-muted text-truncate">${escapeHTML(source.source_url)}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small>çŠ¶æ€: <span class="badge bg-${getStatusColor(source.fetch_status)}">${source.fetch_status}</span></small>
                            <div>
                                <button class="btn btn-outline-primary btn-sm" onclick="refreshSource(${source.id})">ğŸ”„</button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteSource(${source.id})">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                listElement.innerHTML = '<div class="text-center p-3 text-danger">åŠ è½½è®¢é˜…æºå¤±è´¥ã€‚</div>';
            }
        }

        async function addSubscriptionSource() {
            const sourceName = document.getElementById('sourceName').value;
            const sourceUrl = document.getElementById('sourceUrl').value;
            const alertElement = document.getElementById('add-source-alert');

            const result = await apiRequest('/api/subscription-sources', 'POST', { source_name: sourceName, source_url: sourceUrl });

            if (result.ok) {
                showAlert(alertElement, 'success', result.data.message);
                document.getElementById('sourceName').value = '';
                document.getElementById('sourceUrl').value = '';
                setTimeout(() => {
                    addSourceModal.hide();
                    loadSubscriptionSources();
                }, 1500);
            } else {
                showAlert(alertElement, 'danger', `æ·»åŠ å¤±è´¥: ${result.data.error}`);
            }
        }

        async function refreshSource(id) {
            if(!confirm('ç¡®å®šè¦ç«‹å³åˆ·æ–°è¿™ä¸ªè®¢é˜…æºå—ï¼Ÿ')) return;
            await apiRequest(`/api/subscription-sources/${id}/refresh`, 'POST');
            alert('åˆ·æ–°è¯·æ±‚å·²å‘é€ï¼Œè¯·ç¨åæŸ¥çœ‹çŠ¶æ€æ›´æ–°ã€‚');
            setTimeout(loadSubscriptionSources, 3000);
        }

        async function deleteSource(id) {
            if(!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¢é˜…æºåŠå…¶æ‰€æœ‰èŠ‚ç‚¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;
            await apiRequest(`/api/subscription-sources/${id}`, 'DELETE');
            loadSubscriptionSources();
        }

        // å…¨é€‰/å–æ¶ˆå…¨é€‰Tagå¡ç‰‡ä¸­çš„å‹¾é€‰æ¡†
        function selectAllTagsInCards(selectAll) {
            const checkboxes = document.querySelectorAll('input[id^="tag-select-"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll;
            });
        }
        
        // è·å–é€‰ä¸­çš„Tag IDsï¼ˆä»å¡ç‰‡ä¸­çš„å‹¾é€‰æ¡†ï¼‰
        function getSelectedTagIdsFromCards() {
            const checkboxes = document.querySelectorAll('input[id^="tag-select-"]:checked');
            return Array.from(checkboxes).map(cb => parseInt(cb.value));
        }
        
        // æ¸…ç©ºèŠ‚ç‚¹æ–‡æœ¬æ¡†
        function clearNodeTextarea() {
            document.getElementById('node-feedback-textarea').value = '';
        }
        
        // åˆ é™¤é€‰ä¸­çš„Tag
        async function deleteSelectedTags() {
            const selectedTagIds = getSelectedTagIdsFromCards();
            if (selectedTagIds.length === 0) {
                alert('è¯·å…ˆå‹¾é€‰è¦åˆ é™¤çš„Tagï¼');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedTagIds.length} ä¸ªTagå—ï¼Ÿè¿™å°†åŒæ—¶åˆ é™¤Tagä¸èŠ‚ç‚¹çš„å…³è”å…³ç³»ã€‚`)) {
                return;
            }
            
            try {
                const result = await apiRequest('/api/tags/batch-delete', 'POST', {
                    tag_ids: selectedTagIds
                });
                
                if (result.ok) {
                    alert(result.data.message);
                    loadTags(); // é‡æ–°åŠ è½½Tagåˆ—è¡¨
                } else {
                    alert(`åˆ é™¤å¤±è´¥: ${result.data.error}`);
                }
            } catch (error) {
                console.error('åˆ é™¤Tagå¤±è´¥:', error);
                alert(`åˆ é™¤å¤±è´¥: ${error.message}`);
            }
        }
        
        // æ–°çš„æ‰¹é‡æ“ä½œå‡½æ•°
        async function batchOperateNodes(action) {
            const selectedTagIds = getSelectedTagIdsFromCards();
            if (selectedTagIds.length === 0) {
                alert('è¯·å…ˆå‹¾é€‰è¦æ“ä½œçš„Tagï¼');
                return;
            }
            
            const nodeText = document.getElementById('node-feedback-textarea').value.trim();
            if (!nodeText) {
                alert('è¯·è¾“å…¥èŠ‚ç‚¹é“¾æ¥ï¼');
                return;
            }
            
            const nodes = nodeText.split('\n').filter(line => line.trim() !== '');
            if (nodes.length === 0) {
                alert('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„èŠ‚ç‚¹é“¾æ¥ï¼');
                return;
            }
            
            const actionText = action === 'add' ? 'æ·»åŠ ' : 'åˆ é™¤';
            
            if (!confirm(`ç¡®å®šè¦åœ¨é€‰ä¸­çš„ ${selectedTagIds.length} ä¸ªTagä¸­${actionText} ${nodes.length} ä¸ªèŠ‚ç‚¹å—ï¼Ÿ`)) {
                return;
            }
            
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'å¤„ç†ä¸­...';
            
            try {
                const result = await apiRequest('/api/nodes/batch-operate', 'POST', {
                    tag_ids: selectedTagIds,
                    nodes: nodes,
                    action: action
                });
                
                if (result.ok) {
                    // æ˜¾ç¤ºè¯¦ç»†çš„æ“ä½œç»“æœ
                    let message = result.data.message;
                    if (result.data.details) {
                        message += '\n\nè¯¦ç»†ç»“æœï¼š\n' + result.data.details.join('\n');
                    }
                    alert(message);
                    clearNodeTextarea();
                    loadTags(); // é‡æ–°åŠ è½½Tagåˆ—è¡¨
                } else {
                    alert(`æ“ä½œå¤±è´¥: ${result.data.error}`);
                }
            } catch (error) {
                console.error('æ‰¹é‡æ“ä½œé”™è¯¯:', error);
                alert(`æ“ä½œå¤±è´¥: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = originalText;
            }
        }

        // ä¿ç•™åŸæœ‰çš„å‡½æ•°ï¼ˆå‘åå…¼å®¹ï¼‰
        async function updateNodeStatus(markOthersFailed) {
            const nodeText = document.getElementById('node-feedback-textarea').value.trim();
            if (!nodeText) {
                alert('è¯·ç²˜è´´å¯ç”¨èŠ‚ç‚¹åˆ—è¡¨ï¼');
                return;
            }

            const nodes = nodeText.split('\n').filter(Boolean);
            if (nodes.length === 0) {
                alert('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„èŠ‚ç‚¹ï¼');
                return;
            }

            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'æ›´æ–°ä¸­...';

            try {
                const result = await apiRequest('/api/nodes/update-status', 'POST', {
                    nodes: nodes,
                    mark_others_failed: markOthersFailed
                });

                if (result.ok) {
                    alert(result.data.message);
                    document.getElementById('node-feedback-textarea').value = '';
                    loadTags();
                } else {
                    alert(`æ›´æ–°å¤±è´¥: ${result.data.error}`);
                }
            } catch (error) {
                alert(`æ›´æ–°å¤±è´¥: ${error.message}`);
            } finally {
                button.disabled = false;
                button.textContent = originalText;
            }
        }

        // =================================================================
        // èŠ‚ç‚¹æ± ç®¡ç†åŠŸèƒ½
        // =================================================================
        async function loadNodePool() {
            const listElement = document.getElementById('node-pool-list');
            if (!listElement) return;
            
            listElement.innerHTML = '<div class="text-center p-3 text-muted">æ­£åœ¨åŠ è½½èŠ‚ç‚¹...</div>';
            
            const result = await apiRequest('/api/nodes', 'GET');
            
            if (result.ok && Array.isArray(result.data)) {
                allNodes = result.data;
                
                if (allNodes.length === 0) {
                    listElement.innerHTML = '<div class="text-center p-3 text-muted">æ‚¨çš„èŠ‚ç‚¹æ± æ˜¯ç©ºçš„ã€‚è¯·å…ˆæ·»åŠ å¹¶åˆ·æ–°è®¢é˜…æºã€‚</div>';
                    updateNodeCountBadge(0);
                    return;
                }
                
                // å¡«å……æ¥æºè¿‡æ»¤å™¨ä¸‹æ‹‰åˆ—è¡¨
                populateSourceFilter();
                
                // åº”ç”¨åˆå§‹è¿‡æ»¤å¹¶æ˜¾ç¤º
                filterNodes();
                
            } else {
                listElement.innerHTML = '<div class="text-center p-3 text-danger">åŠ è½½èŠ‚ç‚¹æ± å¤±è´¥ã€‚</div>';
                updateNodeCountBadge(0);
            }
        }

        // å¡«å……æ¥æºè¿‡æ»¤å™¨ä¸‹æ‹‰åˆ—è¡¨
        function populateSourceFilter() {
            const sourceFilter = document.getElementById('source-filter');
            if (!sourceFilter) return;
            
            const sources = [...new Set(allNodes.map(node => node.source_name))];
            
            // æ¸…é™¤ç°æœ‰é€‰é¡¹ï¼Œé™¤äº†ç¬¬ä¸€ä¸ª
            sourceFilter.innerHTML = '<option value="">æ‰€æœ‰æ¥æº</option>';
            
            sources.forEach(source => {
                const option = document.createElement('option');
                option.value = source;
                option.textContent = source;
                sourceFilter.appendChild(option);
            });
        }

        // è¿‡æ»¤èŠ‚ç‚¹
        function filterNodes() {
            const searchTerm = document.getElementById('node-search')?.value.toLowerCase() || '';
            const sourceFilter = document.getElementById('source-filter')?.value || '';
            const protocolFilter = document.getElementById('protocol-filter')?.value || '';
            
            filteredNodes = allNodes.filter(node => {
                const matchesSearch = !searchTerm || 
                    (node.node_name && node.node_name.toLowerCase().includes(searchTerm)) ||
                    (node.source_name && node.source_name.toLowerCase().includes(searchTerm)) ||
                    (node.server && node.server.toLowerCase().includes(searchTerm));
                
                const matchesSource = !sourceFilter || node.source_name === sourceFilter;
                const matchesProtocol = !protocolFilter || node.protocol === protocolFilter;
                
                return matchesSearch && matchesSource && matchesProtocol;
            });
            
            currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
            displayNodes();
            updatePagination();
            updateNodeCountBadge(filteredNodes.length);
        }

        // æ˜¾ç¤ºå½“å‰é¡µçš„èŠ‚ç‚¹
        function displayNodes() {
            const listElement = document.getElementById('node-pool-list');
            if (!listElement) return;
            
            const startIndex = (currentPage - 1) * nodesPerPage;
            const endIndex = startIndex + nodesPerPage;
            const nodesToShow = filteredNodes.slice(startIndex, endIndex);
            
            if (nodesToShow.length === 0) {
                listElement.innerHTML = '<div class="text-center p-3 text-muted">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„èŠ‚ç‚¹ã€‚</div>';
                return;
            }
            
            listElement.innerHTML = nodesToShow.map(node => `
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <h6 class="mb-0 text-truncate" style="max-width: 60%;">${escapeHTML(node.node_name || 'æœªçŸ¥èŠ‚ç‚¹')}</h6>
                                <div>
                                    <span class="badge bg-primary me-1">${(node.protocol || 'unknown').toUpperCase()}</span>
                                    <span class="badge bg-secondary">${escapeHTML(node.server || 'unknown')}</span>
                                </div>
                            </div>
                            <p class="mb-1 small text-muted">æ¥æº: ${escapeHTML(node.source_name || 'æœªçŸ¥')}</p>
                            <small class="text-muted">æ·»åŠ æ—¶é—´: ${new Date(node.created_at).toLocaleString('zh-CN')}</small>
                        </div>
                        <div class="ms-2">
                            <button class="btn btn-outline-info btn-sm" onclick="copyNodeUrl('${escapeHTML(node.node_url || '')}', this)" title="å¤åˆ¶èŠ‚ç‚¹é“¾æ¥">ğŸ“‹</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // æ›´æ–°åˆ†é¡µ
        function updatePagination() {
            const paginationElement = document.getElementById('node-pagination');
            if (!paginationElement) return;
            
            const totalPages = Math.ceil(filteredNodes.length / nodesPerPage);
            
            if (totalPages <= 1) {
                paginationElement.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // ä¸Šä¸€é¡µæŒ‰é’®
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">ä¸Šä¸€é¡µ</a>
                </li>
            `;
            
            // é¡µç 
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
                paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(1)">1</a></li>`;
                if (startPage > 2) {
                    paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${totalPages})">${totalPages}</a></li>`;
            }
            
            // ä¸‹ä¸€é¡µæŒ‰é’®
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">ä¸‹ä¸€é¡µ</a>
                </li>
            `;
            
            paginationElement.innerHTML = paginationHTML;
        }

        // åˆ‡æ¢é¡µé¢
        function changePage(page) {
            const totalPages = Math.ceil(filteredNodes.length / nodesPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            displayNodes();
            updatePagination();
        }

        // æ›´æ–°èŠ‚ç‚¹è®¡æ•°å¾½ç« 
        function updateNodeCountBadge(count) {
            const badge = document.getElementById('node-count-badge');
            if (badge) {
                badge.textContent = `æ€»è®¡: ${count}`;
            }
        }

        // å¤åˆ¶èŠ‚ç‚¹URL
        function copyNodeUrl(nodeUrl, button) {
            if (navigator.clipboard && window.isSecureContext) {
                // ä½¿ç”¨ç°ä»£ Clipboard API
                navigator.clipboard.writeText(nodeUrl).then(() => {
                    showCopySuccess(button);
                }).catch(() => {
                    fallbackCopyTextToClipboard(nodeUrl, button, 'ğŸ“‹');
                });
            } else {
                // ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
                fallbackCopyTextToClipboard(nodeUrl, button, 'ğŸ“‹');
            }
        }

        // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçŠ¶æ€
        function showCopySuccess(button) {
            const originalText = button.textContent;
            button.textContent = 'âœ…';
            button.classList.add('btn-success');
            button.classList.remove('btn-outline-info');
            
            setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-info');
            }, 1000);
        }

        // åˆ·æ–°æ‰€æœ‰è®¢é˜…æº
        async function refreshAllSources() {
            if (!confirm('ç¡®å®šè¦åˆ·æ–°æ‰€æœ‰è®¢é˜…æºå—ï¼Ÿè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚')) return;
            
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'åˆ·æ–°ä¸­...';
            
            try {
                // è·å–æ‰€æœ‰è®¢é˜…æºå¹¶åˆ·æ–°å®ƒä»¬
                const sourcesResult = await apiRequest('/api/subscription-sources', 'GET');
                if (sourcesResult.ok && sourcesResult.data.length > 0) {
                    const refreshPromises = sourcesResult.data.map(source => 
                        apiRequest(`/api/subscription-sources/${source.id}/refresh`, 'POST')
                    );
                    
                    await Promise.all(refreshPromises);
                    alert('æ‰€æœ‰è®¢é˜…æºåˆ·æ–°è¯·æ±‚å·²å‘é€ï¼Œè¯·ç¨åæŸ¥çœ‹æ›´æ–°ç»“æœã€‚');
                    
                    // å»¶è¿Ÿåé‡æ–°åŠ è½½è®¢é˜…æºå’ŒèŠ‚ç‚¹æ± 
                    setTimeout(() => {
                        loadSubscriptionSources();
                        loadNodePool();
                    }, 3000);
                } else {
                    alert('æ²¡æœ‰æ‰¾åˆ°è®¢é˜…æºéœ€è¦åˆ·æ–°ã€‚');
                }
            } catch (error) {
                alert('åˆ·æ–°å¤±è´¥: ' + error.message);
            } finally {
                button.disabled = false;
                button.textContent = originalText;
            }
        }

        function getStatusColor(status) {
            switch(status) {
                case 'success': return 'success';
                case 'fetching': return 'info';
                case 'failed': return 'danger';
                default: return 'secondary';
            }
        }

        // å¤åˆ¶åŠŸèƒ½çš„å¤‡ç”¨æ–¹æ¡ˆ
        function fallbackCopyTextToClipboard(text, button, originalText) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            textArea.style.opacity = "0";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess(button);
                } else {
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                }
            } catch (err) {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            }
            
            document.body.removeChild(textArea);
        }

        // =================================================================
        // èŠ‚ç‚¹ç”Ÿæˆå™¨åŠŸèƒ½
        // =================================================================
        
        // ç«¯å£é…ç½®
        const httpsPorts = [2053, 2083, 2087, 2096, 8443, 443];
        const httpPorts = [2052, 2082, 2086, 2095, 80, 8080, 8880];

        // æ›´æ–°é¢„ä¼°å‡½æ•°
        function updateEstimation() {
            let totalAddressSources = 0;
            const isBuiltinTabActive = document.getElementById('builtin-tab').classList.contains('active');
            
            if (isBuiltinTabActive) {
                const selectedRegions = Array.from(document.querySelectorAll('#region-selector input[type="checkbox"]:checked')).map(cb => cb.value);
                const useIPv4 = document.getElementById('useIPv4').checked;
                const useIPv6 = document.getElementById('useIPv6').checked;
                
                selectedRegions.forEach(region => {
                    const data = dataByCountry[region];
                    
                    // æ­£ç¡®è®¡ç®—IPv4 CIDRæ®µçš„IPæ•°é‡
                    if (useIPv4 && data.ipv4) {
                        data.ipv4.forEach(cidr => {
                            const [ip, prefix] = cidr.split('/');
                            const prefixNum = parseInt(prefix);
                            if (prefixNum >= 0 && prefixNum <= 32) {
                                const hostBits = 32 - prefixNum;
                                const availableIPs = Math.pow(2, hostBits);
                                totalAddressSources += availableIPs;
                                console.log(`å†…ç½®IPv4 CIDR ${cidr}: ${availableIPs.toLocaleString()} ä¸ªå¯ç”¨åœ°å€`);
                            }
                        });
                    }
                    
                    // æ­£ç¡®è®¡ç®—IPv6 CIDRæ®µçš„IPæ•°é‡
                    if (useIPv6 && data.ipv6) {
                        data.ipv6.forEach(cidr => {
                            const [ip, prefix] = cidr.split('/');
                            const prefixNum = parseInt(prefix);
                            if (prefixNum >= 0 && prefixNum <= 128) {
                                const hostBits = 128 - prefixNum;
                                if (hostBits <= 32) {
                                    const availableIPs = Math.pow(2, hostBits);
                                    totalAddressSources += availableIPs;
                                    console.log(`å†…ç½®IPv6 CIDR ${cidr}: ${availableIPs.toLocaleString()} ä¸ªå¯ç”¨åœ°å€`);
                                } else {
                                    // å¯¹äºå¤§å‹IPv6ç½‘ç»œï¼Œä½¿ç”¨åˆç†çš„ä¼°ç®—å€¼
                                    const estimatedIPs = Math.pow(2, 32); // çº¦42äº¿ä¸ªåœ°å€ä½œä¸ºä¸Šé™
                                    totalAddressSources += estimatedIPs;
                                    console.log(`å†…ç½®IPv6 CIDR ${cidr}: è¶…å¤§ç½‘ç»œï¼Œä¼°ç®— ${estimatedIPs.toLocaleString()} ä¸ªå¯ç”¨åœ°å€`);
                                }
                            }
                        });
                    }
                    
                    // åŸŸåæ•°é‡
                    if (data.domains) {
                        totalAddressSources += data.domains.length;
                        console.log(`å†…ç½®åŸŸå ${region}: ${data.domains.length} ä¸ªåŸŸå`);
                    }
                });
            } else {
                // è‡ªå®šä¹‰æ•°æ®ï¼šè§£æCIDRå¹¶è®¡ç®—å¯ç”¨IPæ•°é‡
                const customData = document.getElementById('customData').value.trim();
                const lines = customData.split('\n').filter(Boolean);
                
                lines.forEach(line => {
                    if (line.includes('/')) {
                        // CIDRæ ¼å¼ï¼šæ­£ç¡®åŒºåˆ†IPv4å’ŒIPv6
                        const [ip, prefix] = line.split('/');
                        const prefixNum = parseInt(prefix);
                        
                        if (ip.includes('.')) {
                            // IPv4 å¤„ç†
                            if (prefixNum >= 0 && prefixNum <= 32) {
                                const hostBits = 32 - prefixNum;
                                const availableIPs = Math.pow(2, hostBits);
                                totalAddressSources += availableIPs;
                                console.log(`IPv4 CIDR ${line}: ${availableIPs} ä¸ªå¯ç”¨åœ°å€`);
                            }
                        } else if (ip.includes(':')) {
                            // IPv6 å¤„ç†
                            if (prefixNum >= 0 && prefixNum <= 128) {
                                const hostBits = 128 - prefixNum;
                                // IPv6åœ°å€ç©ºé—´å·¨å¤§ï¼Œéœ€è¦é™åˆ¶è®¡ç®—èŒƒå›´
                                if (hostBits <= 32) {
                                    // åªæœ‰å½“ä¸»æœºä½ <= 32 æ—¶æ‰è®¡ç®—ï¼Œå¦åˆ™æ•°å­—å¤ªå¤§
                                    const availableIPs = Math.pow(2, hostBits);
                                    totalAddressSources += availableIPs;
                                    console.log(`IPv6 CIDR ${line}: ${availableIPs} ä¸ªå¯ç”¨åœ°å€`);
                                } else {
                                    // å¯¹äºå¤§å‹IPv6ç½‘ç»œï¼Œä½¿ç”¨ä¸€ä¸ªåˆç†çš„ä¼°ç®—å€¼
                                    const estimatedIPs = Math.pow(2, 32); // çº¦42äº¿ä¸ªåœ°å€ä½œä¸ºä¸Šé™
                                    totalAddressSources += estimatedIPs;
                                    console.log(`IPv6 CIDR ${line}: è¶…å¤§ç½‘ç»œï¼Œä¼°ç®— ${estimatedIPs} ä¸ªå¯ç”¨åœ°å€`);
                                }
                            }
                        }
                    } else {
                        // å•ä¸ªIPæˆ–åŸŸå
                        totalAddressSources += 1;
                    }
                });
            }
            
            // è·å–é€‰ä¸­çš„ç«¯å£æ•°é‡
            const selectedPorts = getSelectedPorts();
            const totalCombinations = totalAddressSources * selectedPorts.length;
            
            // æ›´æ–°æ˜¾ç¤ºä¿¡æ¯ï¼ŒåŒ…å«æœ€å¤§å¯ç”Ÿæˆæ•°é‡
            const estimationElement = document.getElementById('estimation');
            estimationElement.innerHTML = `
                <strong>å½“å‰é…ç½®å¯ç”Ÿæˆ ${totalCombinations.toLocaleString()} ä¸ªä¸é‡å¤çš„"åœ°å€:ç«¯å£"ç»„åˆ</strong><br>
                <small class="text-muted">åœ°å€æº: ${totalAddressSources.toLocaleString()} ä¸ª Ã— ç«¯å£: ${selectedPorts.length} ä¸ª = ${totalCombinations.toLocaleString()} ä¸ªç»„åˆ</small>
            `;
            
            // å­˜å‚¨æœ€å¤§å¯ç”Ÿæˆæ•°é‡ä¾›éªŒè¯ä½¿ç”¨
            window.maxGeneratableNodes = totalCombinations;
            
            // æ£€æŸ¥å½“å‰è¾“å…¥çš„ç”Ÿæˆæ•°é‡æ˜¯å¦è¶…é™
            validateQuantityInput();
        }
        
        // éªŒè¯ç”Ÿæˆæ•°é‡è¾“å…¥
        function validateQuantityInput() {
            const quantityInput = document.getElementById('quantity');
            const requestedQuantity = parseInt(quantityInput.value) || 0;
            const maxNodes = window.maxGeneratableNodes || 0;
            
            // ç§»é™¤ä¹‹å‰çš„è­¦å‘Šæ ·å¼
            quantityInput.classList.remove('is-invalid');
            
            // ç§»é™¤ä¹‹å‰çš„è­¦å‘Šä¿¡æ¯
            const existingWarning = document.getElementById('quantity-warning');
            if (existingWarning) {
                existingWarning.remove();
            }
            
            if (requestedQuantity > maxNodes && maxNodes > 0) {
                // æ·»åŠ è­¦å‘Šæ ·å¼
                quantityInput.classList.add('is-invalid');
                
                // åˆ›å»ºè­¦å‘Šä¿¡æ¯
                const warningDiv = document.createElement('div');
                warningDiv.id = 'quantity-warning';
                warningDiv.className = 'invalid-feedback';
                warningDiv.innerHTML = `
                    <strong>âš ï¸ æ•°é‡è¶…é™ï¼</strong><br>
                    è¯·æ±‚ç”Ÿæˆ <strong>${requestedQuantity}</strong> ä¸ªèŠ‚ç‚¹ï¼Œä½†å½“å‰é…ç½®æœ€å¤šåªèƒ½ç”Ÿæˆ <strong>${maxNodes.toLocaleString()}</strong> ä¸ªä¸é‡å¤èŠ‚ç‚¹ã€‚<br>
                    <small>è¶…å‡ºéƒ¨åˆ†å°†äº§ç”Ÿé‡å¤èŠ‚ç‚¹ï¼Œå»ºè®®è°ƒæ•´ç”Ÿæˆæ•°é‡æˆ–å¢åŠ åœ°å€æºã€‚</small>
                `;
                
                quantityInput.parentNode.appendChild(warningDiv);
                return false;
            }
            
            return true;
        }
        
        // æŠ˜å æç¤ºä¿¡æ¯å‡½æ•°
        function collapseAlert(alertId) {
            const alertElement = document.getElementById(alertId);
            if (alertElement) {
                // æ·»åŠ æ·¡å‡ºåŠ¨ç”»
                alertElement.style.transition = 'opacity 0.3s ease-out, height 0.3s ease-out';
                alertElement.style.opacity = '0';
                alertElement.style.height = '0';
                alertElement.style.overflow = 'hidden';
                alertElement.style.marginBottom = '0';
                alertElement.style.paddingTop = '0';
                alertElement.style.paddingBottom = '0';
                
                // 300msåå®Œå…¨éšè—å…ƒç´ 
                setTimeout(() => {
                    alertElement.style.display = 'none';
                }, 300);
            }
        }
        
        // è·å–é€‰ä¸­çš„ç«¯å£
        function getSelectedPorts() {
            const isBuiltinTabActive = document.getElementById('builtin-tab').classList.contains('active');
            
            if (isBuiltinTabActive) {
                // å†…ç½®æ•°æ®ä½¿ç”¨é€‰ä¸­çš„ç«¯å£
                const selectedPorts = [];
                const portCheckboxes = document.querySelectorAll('#builtin-https-port-selector input[type="checkbox"]:checked');
                portCheckboxes.forEach(checkbox => {
                    selectedPorts.push(parseInt(checkbox.value));
                });
                return selectedPorts.length > 0 ? selectedPorts : [443]; // å¦‚æœæ²¡æœ‰é€‰ä¸­ä»»ä½•ç«¯å£ï¼Œé»˜è®¤ä½¿ç”¨443
            } else {
                // è‡ªå®šä¹‰æ•°æ®ä½¿ç”¨é€‰ä¸­çš„ç«¯å£
                const selectedPorts = [];
                const portCheckboxes = document.querySelectorAll('#https-port-selector input[type="checkbox"]:checked');
                portCheckboxes.forEach(checkbox => {
                    selectedPorts.push(parseInt(checkbox.value));
                });
                return selectedPorts.length > 0 ? selectedPorts : httpsPorts; // å¦‚æœæ²¡æœ‰é€‰ä¸­ä»»ä½•ç«¯å£ï¼Œä½¿ç”¨é»˜è®¤ç«¯å£
            }
        }

        // å¤åˆ¶ç»“æœå‡½æ•°
        function copyResults() {
            const outputText = document.getElementById('output');
            if (!outputText.value) {
                alert('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹ï¼');
                return;
            }
            navigator.clipboard.writeText(outputText.value).then(() => {
                alert('å·²æˆåŠŸå¤åˆ¶ ' + outputText.value.split('\n').length + ' ä¸ªèŠ‚ç‚¹åˆ°å‰ªè´´æ¿ï¼');
            }).catch(err => {
                try {
                    outputText.select();
                    document.execCommand('copy');
                    alert('è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œä½†å·²ä¸ºæ‚¨å…¨é€‰æ–‡æœ¬ï¼Œè¯·æŒ‰ Ctrl+C æ‰‹åŠ¨å¤åˆ¶ã€‚');
                } catch (e) {
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
                }
            });
        }





        // å¤åˆ¶åˆ°å‰ªè´´æ¿å‡½æ•°
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(err => {
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                } catch (e) {
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
                }
            });
        }

        // æ­£ç¡®çš„CIDRè§£æå‡½æ•°
        function parseCIDR(cidr) {
            try {
                const [ip, prefixStr] = cidr.split('/');
                const prefix = parseInt(prefixStr, 10);
                
                if (ip.includes('.')) {
                    // IPv4 å¤„ç†
                    if (isNaN(prefix) || prefix < 0 || prefix > 32) return null;
                    const parts = ip.split('.').map(Number);
                    if (parts.length !== 4 || parts.some(p => isNaN(p) || p < 0 || p > 255)) return null;
                    
                    // å°†IPåœ°å€è½¬æ¢ä¸ºBigInt
                    const ipBigInt = (BigInt(parts[0]) << 24n) | (BigInt(parts[1]) << 16n) | (BigInt(parts[2]) << 8n) | BigInt(parts[3]);
                    
                    // è®¡ç®—ç½‘ç»œåœ°å€ï¼ˆæ¸…é™¤ä¸»æœºä½ï¼‰
                    const hostBits = 32 - prefix;
                    const mask = hostBits === 0 ? 0n : (1n << BigInt(hostBits)) - 1n;
                    const networkAddress = ipBigInt & ~mask;
                    
                    return { 
                        type: 'v4', 
                        network: networkAddress, 
                        prefix: prefix,
                        hostBits: hostBits
                    };
                } else {
                    // IPv6 å¤„ç†
                    if (isNaN(prefix) || prefix < 0 || prefix > 128) return null;
                    
                    // æ­£ç¡®å¤„ç†IPv6åœ°å€å±•å¼€
                    let expandedIP = ip;
                    if (ip.includes('::')) {
                        const parts = ip.split('::');
                        const leftParts = parts[0] ? parts[0].split(':').filter(p => p !== '') : [];
                        const rightParts = parts[1] ? parts[1].split(':').filter(p => p !== '') : [];
                        const missingParts = 8 - leftParts.length - rightParts.length;
                        const middleParts = Array(missingParts).fill('0');
                        expandedIP = [...leftParts, ...middleParts, ...rightParts].join(':');
                    }
                    
                    const parts = expandedIP.split(':');
                    if (parts.length !== 8) return null;
                    
                    // éªŒè¯æ¯ä¸ªéƒ¨åˆ†éƒ½æ˜¯æœ‰æ•ˆçš„16è¿›åˆ¶
                    for (let part of parts) {
                        if (part === '') part = '0';
                        const num = parseInt(part, 16);
                        if (isNaN(num) || num < 0 || num > 0xffff) return null;
                    }
                    
                    // è®¡ç®—IPv6åœ°å€çš„BigIntå€¼
                    let ipBigInt = 0n;
                    for (let i = 0; i < 8; i++) {
                        const part = parts[i] === '' ? '0' : parts[i];
                        ipBigInt = (ipBigInt << 16n) | BigInt(parseInt(part, 16));
                    }
                    
                    // è®¡ç®—ç½‘ç»œåœ°å€
                    const hostBits = 128 - prefix;
                    const mask = hostBits === 0 ? 0n : (1n << BigInt(hostBits)) - 1n;
                    const networkAddress = ipBigInt & ~mask;
                    
                    return { 
                        type: 'v6', 
                        network: networkAddress, 
                        prefix: prefix,
                        hostBits: hostBits
                    };
                }
            } catch (e) {
                console.error('CIDRè§£æé”™è¯¯:', e, 'CIDR:', cidr);
                return null;
            }
        }

        function getRandomIP(range) {
            // å¦‚æœæ²¡æœ‰ä¸»æœºä½ï¼ˆ/32 æˆ– /128ï¼‰ï¼Œç›´æ¥è¿”å›ç½‘ç»œåœ°å€
            if (range.hostBits === 0) {
                const ip = range.network;
                if (range.type === 'v4') {
                    return [(ip >> 24n) & 255n, (ip >> 16n) & 255n, (ip >> 8n) & 255n, ip & 255n].join('.');
                } else {
                    const parts = [];
                    for (let i = 7; i >= 0; i--) {
                        const part = ((ip >> BigInt(i * 16)) & 0xffffn).toString(16).padStart(4, '0');
                        parts.push(part);
                    }
                    return parts.join(':');
                }
            }
            
            const hostBits = BigInt(range.hostBits);
            
            // ç”Ÿæˆéšæœºä¸»æœºéƒ¨åˆ†
            let randomHost;
            if (hostBits <= 53n) {
                // å¯¹äºè¾ƒå°çš„èŒƒå›´ï¼Œä½¿ç”¨æ ‡å‡†æ–¹æ³•
                const maxHost = (1n << hostBits) - 1n;
                randomHost = BigInt(Math.floor(Math.random() * Number(maxHost + 1n)));
            } else {
                // å¯¹äºå¤§èŒƒå›´ï¼Œä½¿ç”¨æ›´å®‰å…¨çš„åˆ†æ®µéšæœº
                const maxSafeInt = BigInt(Number.MAX_SAFE_INTEGER);
                const maxHost = (1n << hostBits) - 1n;
                
                // ä½¿ç”¨å¤šæ¬¡éšæœºæ¥è¦†ç›–å¤§èŒƒå›´
                let attempts = 0;
                do {
                    const segment = BigInt(Math.floor(Math.random() * Number(maxSafeInt)));
                    const offset = BigInt(Math.floor(Math.random() * Number(maxSafeInt)));
                    randomHost = (segment << 32n) | offset;
                    attempts++;
                } while (randomHost > maxHost && attempts < 10);
                
                // å¦‚æœè¿˜æ˜¯è¶…å‡ºèŒƒå›´ï¼Œä½¿ç”¨å–æ¨¡
                if (randomHost > maxHost) {
                    randomHost = randomHost % (maxHost + 1n);
                }
            }
            
            // ç½‘ç»œåœ°å€ + éšæœºä¸»æœºéƒ¨åˆ† = æœ€ç»ˆIP
            const finalIP = range.network + randomHost;
            
            if (range.type === 'v4') {
                return [(finalIP >> 24n) & 255n, (finalIP >> 16n) & 255n, (finalIP >> 8n) & 255n, finalIP & 255n].join('.');
            } else {
                const parts = [];
                for (let i = 7; i >= 0; i--) {
                    const part = ((finalIP >> BigInt(i * 16)) & 0xffffn).toString(16).padStart(4, '0');
                    parts.push(part);
                }
                // ç®€åŒ–IPv6åœ°å€è¡¨ç¤ºï¼ˆç§»é™¤å‰å¯¼é›¶ï¼‰
                let ipv6 = parts.join(':');
                ipv6 = ipv6.replace(/(^|:)0+([0-9a-f])/g, '$1$2');
                // å¤„ç†å…¨é›¶æ®µ
                ipv6 = ipv6.replace(/(^|:)0(:|$)/g, '$1$2');
                return ipv6;
            }
        }

        // æµ‹è¯•CIDRè§£æï¼ˆè°ƒè¯•ç”¨ï¼‰
        function testCIDRParsing() {
            const testCases = [
                // IPv4 æµ‹è¯•
                '104.28.43.44/22',  // æ‚¨çš„æµ‹è¯•ç”¨ä¾‹
                '104.28.43.45/32',  // å•ä¸ªIP
                '192.168.1.100/24', // æ ‡å‡†ç½‘æ®µ
                '10.0.0.0/8',       // å¤§ç½‘æ®µ
                // IPv6 æµ‹è¯•
                '2a09:bac1:19c0:10::1/64',
                '2606:4700::1/32',
                '2001:db8::1/128',  // å•ä¸ªIPv6
                'fe80::/10'
            ];
            
            console.log('=== CIDR è§£ææµ‹è¯• ===');
            testCases.forEach(cidr => {
                console.log(`\nğŸ” æµ‹è¯•: ${cidr}`);
                const parsed = parseCIDR(cidr);
                if (parsed) {
                    console.log(`âœ… è§£ææˆåŠŸ:`);
                    console.log(`   ç±»å‹: ${parsed.type === 'v4' ? 'IPv4' : 'IPv6'}`);
                    console.log(`   ç½‘ç»œåœ°å€: ${parsed.network.toString()}`);
                    console.log(`   å‰ç¼€é•¿åº¦: /${parsed.prefix}`);
                    console.log(`   ä¸»æœºä½æ•°: ${parsed.hostBits}`);
                    console.log(`   å¯ç”¨IPæ•°: ${parsed.hostBits === 0 ? 1 : (parsed.hostBits > 20 ? '2^' + parsed.hostBits + ' (å¾ˆå¤§)' : Math.pow(2, parsed.hostBits))}`);
                    
                    // æ˜¾ç¤ºç½‘ç»œèŒƒå›´
                    if (parsed.hostBits > 0) {
                        const startIP = getRandomIP({...parsed, hostBits: 0}); // ç½‘ç»œåœ°å€
                        console.log(`   ç½‘ç»œèŒƒå›´èµ·å§‹: ${startIP}`);
                    }
                    
                    // ç”Ÿæˆå‡ ä¸ªéšæœºIPæµ‹è¯•
                    const testCount = parsed.hostBits === 0 ? 1 : 5;
                    console.log(`   ç”Ÿæˆ${testCount}ä¸ªéšæœºIP:`);
                    for (let i = 0; i < testCount; i++) {
                        const randomIP = getRandomIP(parsed);
                        console.log(`     ${i+1}. ${randomIP}`);
                    }
                } else {
                    console.log(`âŒ è§£æå¤±è´¥`);
                }
                console.log('â”€'.repeat(50));
            });
        }

        // åˆå§‹åŒ–åœ°åŒºé€‰æ‹©å™¨
        function initializeRegionSelector() {
            const regionSelector = document.getElementById('region-selector');
            if (!regionSelector || !window.dataByCountry) return;
            
            let checkboxesHTML = '';
            for (const region in window.dataByCountry) {
                checkboxesHTML += `
                    <div class="region-checkbox">
                        <input class="form-check-input" type="checkbox" id="region-${region.replace(/[^a-zA-Z0-9]/g, '-')}" value="${region}" checked onchange="updateEstimation()">
                        <label class="form-check-label" for="region-${region.replace(/[^a-zA-Z0-9]/g, '-')}">${region}</label>
                    </div>`;
            }
            regionSelector.innerHTML = checkboxesHTML;
            
            // åˆå§‹åŒ–HTTPSç«¯å£é€‰æ‹©å™¨
            initializePortSelector();
            
            // åˆå§‹åŒ–å…¶ä»–ç»„ä»¶
            initializeOtherComponents();
        }
        
        // åˆå§‹åŒ–ç«¯å£é€‰æ‹©å™¨
        function initializePortSelector() {
            // ä¸ºè‡ªå®šä¹‰æ•°æ®æºåˆå§‹åŒ–ç«¯å£é€‰æ‹©å™¨
            const customPortSelector = document.getElementById('https-port-selector');
            if (customPortSelector && window.portConfig) {
                let portsHTML = '';
                window.portConfig.https.forEach(port => {
                    portsHTML += `
                        <div class="col-md-4 col-sm-6 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="custom-port-${port}" value="${port}" checked onchange="updateEstimation()">
                                <label class="form-check-label" for="custom-port-${port}">
                                    <strong>${port}</strong>
                                </label>
                            </div>
                        </div>`;
                });
                customPortSelector.innerHTML = portsHTML;
            }
            
            // ä¸ºå†…ç½®æ•°æ®æºåˆå§‹åŒ–ç«¯å£é€‰æ‹©å™¨
            const builtinPortSelector = document.getElementById('builtin-https-port-selector');
            if (builtinPortSelector && window.portConfig) {
                let portsHTML = '';
                window.portConfig.https.forEach((port, index) => {
                    // é»˜è®¤åªé€‰æ‹©443ç«¯å£ï¼Œå…¶ä»–ç«¯å£ä¸é€‰ä¸­
                    const isChecked = port === 443 ? 'checked' : '';
                    portsHTML += `
                        <div class="col-md-4 col-sm-6 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="builtin-port-${port}" value="${port}" ${isChecked} onchange="updateEstimation()">
                                <label class="form-check-label" for="builtin-port-${port}">
                                    <strong>${port}</strong>
                                </label>
                            </div>
                        </div>`;
                });
                builtinPortSelector.innerHTML = portsHTML;
            }
        }
        
        // åˆå§‹åŒ–å…¶ä»–ç»„ä»¶
        function initializeOtherComponents() {
            // æ·»åŠ æ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶ç›‘å¬å™¨
            document.querySelectorAll('#sourceTab button').forEach(tab => {
                tab.addEventListener('shown.bs.tab', updateEstimation);
            });

            // æ™ºèƒ½æ ¼å¼é€‰æ‹©ï¼šæ ¹æ®è¾“å…¥çš„æ¨¡æ¿è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„è¾“å‡ºæ ¼å¼
            const templateInput = document.getElementById('templateUrl');
            templateInput.addEventListener('input', (event) => {
                const url = event.target.value.trim();
                const vlessRadio = document.getElementById('formatVless');
                const vmessJsonRadio = document.getElementById('formatVmessJson');
                const vmessQueryRadio = document.getElementById('formatVmessQuery');

                if (url.startsWith('vless://')) {
                    vlessRadio.checked = true;
                    vmessJsonRadio.disabled = true;
                    vmessQueryRadio.disabled = true;
                } else if (url.startsWith('vmess://')) {
                    vlessRadio.disabled = true;
                    vmessJsonRadio.disabled = false;
                    vmessQueryRadio.disabled = false;
                    // å¦‚æœå½“å‰æ²¡æœ‰é€‰ä¸­çš„æ ¼å¼ï¼Œé»˜è®¤é€‰æ‹©JSONæ ¼å¼
                    if (!document.querySelector('input[name="outputFormat"]:checked')) {
                        vmessJsonRadio.checked = true;
                    }
                } else {
                    // é‡æ–°å¯ç”¨æ‰€æœ‰é€‰é¡¹
                    vlessRadio.disabled = false;
                    vmessJsonRadio.disabled = false;
                    vmessQueryRadio.disabled = false;
                }
            });

            // ä¸ºè‡ªå®šä¹‰æ•°æ®è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const customDataInput = document.getElementById('customData');
            if (customDataInput) {
                customDataInput.addEventListener('input', updateEstimation);
            }

            // åˆå§‹åŒ–é¢„ä¼°
            updateEstimation();
        }

        // ========================================================================
        // START: UTF-8 Safe Base64 Encoder/Decoder Pair
        // ========================================================================
        function safeBase64Encode(str) {
            try {
                return btoa(unescape(encodeURIComponent(str)));
            } catch (e) {
                console.error("Base64 encoding error:", e);
                return null;
            }
        }

        function safeBase64Decode(str) {
            try {
                return decodeURIComponent(escape(atob(str.replace(/-/g, '+').replace(/_/g, '/'))));
            } catch (e) {
                console.error("Base64 decoding error:", e);
                return null;
            }
        }
        // ========================================================================
        // END: UTF-8 Safe Base64 Encoder/Decoder Pair
        // ========================================================================

        // ä¸»è§£æå‡½æ•° - ä¿®å¤Shadowrocketéæ ‡å‡†æ ¼å¼æ”¯æŒ
        function parseNodeLink(url) {
            if (url.startsWith('vless://')) {
                try {
                    // Shadowrocketå¯èƒ½åœ¨usernameä¸­æ”¾ç½®auth: `auto:<uuid>`
                    const urlObject = new URL(url);
                    let uuid = urlObject.username;
                    if (uuid.includes(':')) {
                        uuid = uuid.split(':')[1];
                    }
                    const config = {
                        id: uuid,
                        address: urlObject.hostname,
                        port: urlObject.port,
                        ...Object.fromEntries(urlObject.searchParams.entries())
                    };
                    config.ps = urlObject.hash ? decodeURIComponent(urlObject.hash.substring(1)) : 'VLESS_Node';

                    return { protocol: 'vless', config: config };
                } catch (e) {
                    console.error("VLESS parsing error:", e);
                    return null;
                }
            } else if (url.startsWith('vmess://')) {
                const data = url.substring('vmess://'.length);
                const decodedJsonStr = safeBase64Decode(data);
                if (decodedJsonStr) {
                    try {
                        const config = JSON.parse(decodedJsonStr);
                        if(config.v && config.add) return { protocol: 'vmess', config: config };
                    } catch (e) {}
                }
                try {
                    const urlObject = new URL(url);
                    const decodedAuth = safeBase64Decode(urlObject.username);
                    const [scy, id] = decodedAuth.split(':');
                    const config = {
                        ps: urlObject.hash ? decodeURIComponent(urlObject.hash.substring(1)) : 'VMess_Node',
                        add: urlObject.hostname,
                        port: urlObject.port,
                        id: id,
                        scy: scy,
                        net: urlObject.searchParams.get('obfs') || 'tcp',
                        type: 'none',
                        host: urlObject.searchParams.get('obfsParam') || urlObject.searchParams.get('peer') || '',
                        path: urlObject.searchParams.get('path') || '/',
                        tls: urlObject.searchParams.get('tls') === '1' ? 'tls' : '',
                        sni: urlObject.searchParams.get('peer') || '',
                        aid: urlObject.searchParams.get('alterId') || '0',
                    };
                    return { protocol: 'vmess', config: config };
                } catch (e) {
                    console.error("VMess parsing failed for both formats:", e);
                }
            }
            return null;
        }

        // è¾“å‡ºæ ¼å¼ç”Ÿæˆå‡½æ•°
        function createVlessLink(config, newAddress, newPort) {
            const newConfig = { ...config };
            newConfig.address = newAddress.includes(':') ? `[${newAddress}]` : newAddress;
            newConfig.port = newPort;

            const query = new URLSearchParams();
            for (const key in newConfig) {
                if (!['id', 'address', 'port', 'ps'].includes(key)) {
                    query.set(key, newConfig[key]);
                }
            }
            const queryString = query.toString() ? `?${query.toString()}` : '';
            const name = encodeURIComponent(`${newConfig.ps || 'VLESS'}_${newAddress}`);

            return `vless://${newConfig.id}@${newConfig.address}:${newConfig.port}${queryString}#${name}`;
        }

        function createVmessJsonLink(config, newAddress, newPort) {
            const newConfig = { ...config };
            newConfig.add = newAddress;
            newConfig.port = newPort.toString();
            newConfig.ps = `${newConfig.ps || 'VMess'}_${newAddress}`;

            const jsonString = JSON.stringify(newConfig);
            const base64String = safeBase64Encode(jsonString);
            return `vmess://${base64String}`;
        }

        function createVmessQueryLink(config, newAddress, newPort) {
            const newConfig = { ...config };
            newConfig.add = newAddress;
            newConfig.port = newPort.toString();
            newConfig.ps = `${newConfig.ps || 'VMess'}_${newAddress}`;

            const authString = `${newConfig.scy || 'auto'}:${newConfig.id}`;
            const base64Auth = safeBase64Encode(authString).replace(/=/g, '');

            const params = new URLSearchParams();
            if (newConfig.net === 'ws') params.set('obfs', 'websocket');
            if (newConfig.host) params.set('obfsParam', newConfig.host);
            if (newConfig.path) params.set('path', newConfig.path);
            if (newConfig.tls === 'tls') params.set('tls', '1');
            if (newConfig.sni) params.set('peer', newConfig.sni);
            if (newConfig.aid) params.set('alterId', newConfig.aid);
            
            const queryString = params.toString() ? `?${params.toString()}` : '';
            const name = encodeURIComponent(newConfig.ps);
            const finalAddress = newAddress.includes(':') ? `[${newAddress}]` : newAddress;
            
            return `vmess://${base64Auth}@${finalAddress}:${newConfig.port}${queryString}#${name}`;
        }

        // ä¸»è§£æå‡½æ•° - ä¿®å¤Shadowrocketéæ ‡å‡†æ ¼å¼æ”¯æŒ
        function parseNodeLink(url) {
            if (url.startsWith('vless://')) {
                try {
                    // Shadowrocketå¯èƒ½åœ¨usernameä¸­æ”¾ç½®auth: `auto:<uuid>`
                    const urlObject = new URL(url);
                    let uuid = urlObject.username;
                    if (uuid.includes(':')) {
                        uuid = uuid.split(':')[1];
                    }
                    const config = {
                        id: uuid,
                        address: urlObject.hostname,
                        port: urlObject.port,
                        ...Object.fromEntries(urlObject.searchParams.entries())
                    };
                    config.ps = urlObject.hash ? decodeURIComponent(urlObject.hash.substring(1)) : 'VLESS_Node';

                    return { protocol: 'vless', config: config };
                } catch (e) {
                    console.error("VLESS parsing error:", e);
                    return null;
                }
            } else if (url.startsWith('vmess://')) {
                const data = url.substring('vmess://'.length);
                const decodedJsonStr = safeBase64Decode(data);
                if (decodedJsonStr) {
                    try {
                        const config = JSON.parse(decodedJsonStr);
                        if(config.v && config.add) return { protocol: 'vmess', config: config };
                    } catch (e) {}
                }
                try {
                    const urlObject = new URL(url);
                    const decodedAuth = safeBase64Decode(urlObject.username);
                    const [scy, id] = decodedAuth.split(':');
                    const config = {
                        ps: urlObject.hash ? decodeURIComponent(urlObject.hash.substring(1)) : 'VMess_Node',
                        add: urlObject.hostname,
                        port: urlObject.port,
                        id: id,
                        scy: scy,
                        net: urlObject.searchParams.get('obfs') || 'tcp',
                        type: 'none',
                        host: urlObject.searchParams.get('obfsParam') || urlObject.searchParams.get('peer') || '',
                        path: urlObject.searchParams.get('path') || '/',
                        tls: urlObject.searchParams.get('tls') === '1' ? 'tls' : '',
                        sni: urlObject.searchParams.get('peer') || '',
                        aid: urlObject.searchParams.get('alterId') || '0',
                    };
                    return { protocol: 'vmess', config: config };
                } catch (e) {
                    console.error("VMess parsing failed for both formats:", e);
                }
            }
            return null;
        }

        // è¾“å‡ºæ ¼å¼ç”Ÿæˆå‡½æ•°
        function createVlessLink(config, newAddress, newPort) {
            const newConfig = { ...config };
            newConfig.address = newAddress.includes(':') ? `[${newAddress}]` : newAddress;
            newConfig.port = newPort;

            const query = new URLSearchParams();
            for (const key in newConfig) {
                if (!['id', 'address', 'port', 'ps'].includes(key)) {
                    query.set(key, newConfig[key]);
                }
            }
            const queryString = query.toString() ? `?${query.toString()}` : '';
            const name = encodeURIComponent(`${newConfig.ps || 'VLESS'}_${newAddress}`);

            return `vless://${newConfig.id}@${newConfig.address}:${newConfig.port}${queryString}#${name}`;
        }

        function createVmessJsonLink(config, newAddress, newPort) {
            const newConfig = { ...config };
            newConfig.add = newAddress;
            newConfig.port = newPort.toString();
            newConfig.ps = `${newConfig.ps || 'VMess'}_${newAddress}`;

            const jsonString = JSON.stringify(newConfig);
            const base64String = safeBase64Encode(jsonString);
            return `vmess://${base64String}`;
        }

        function createVmessQueryLink(config, newAddress, newPort) {
            const newConfig = { ...config };
            newConfig.add = newAddress;
            newConfig.port = newPort.toString();
            newConfig.ps = `${newConfig.ps || 'VMess'}_${newAddress}`;

            const authString = `${newConfig.scy || 'auto'}:${newConfig.id}`;
            const base64Auth = safeBase64Encode(authString).replace(/=/g, '');

            const params = new URLSearchParams();
            if (newConfig.net === 'ws') params.set('obfs', 'websocket');
            if (newConfig.host) params.set('obfsParam', newConfig.host);
            if (newConfig.path) params.set('path', newConfig.path);
            if (newConfig.tls === 'tls') params.set('tls', '1');
            if (newConfig.sni) params.set('peer', newConfig.sni);
            if (newConfig.aid) params.set('alterId', newConfig.aid);
            
            const queryString = params.toString() ? `?${params.toString()}` : '';
            const name = encodeURIComponent(newConfig.ps);
            const finalAddress = newAddress.includes(':') ? `[${newAddress}]` : newAddress;
            
            return `vmess://${base64Auth}@${finalAddress}:${newConfig.port}${queryString}#${name}`;
        }

        // ç”ŸæˆèŠ‚ç‚¹å‡½æ•°
        function generateNodes() {
            const templateUrl = document.getElementById('templateUrl').value.trim();
            const quantity = parseInt(document.getElementById('quantity').value, 10);
            const selectedFormat = document.querySelector('input[name="outputFormat"]:checked')?.value;

            if (!templateUrl || isNaN(quantity) || quantity < 1) {
                alert('è¯·ç¡®ä¿æºèŠ‚ç‚¹é“¾æ¥å’Œç”Ÿæˆæ•°é‡å·²æ­£ç¡®å¡«å†™ï¼');
                return;
            }

            if (!selectedFormat) {
                alert('è¯·é€‰æ‹©è¾“å‡ºæ ¼å¼ï¼');
                return;
            }

            // éªŒè¯ç”Ÿæˆæ•°é‡æ˜¯å¦è¶…é™
            if (!validateQuantityInput()) {
                const maxNodes = window.maxGeneratableNodes || 0;
                const confirmMessage = `âš ï¸ è­¦å‘Šï¼šè¯·æ±‚ç”Ÿæˆ ${quantity} ä¸ªèŠ‚ç‚¹ï¼Œä½†å½“å‰é…ç½®æœ€å¤šåªèƒ½ç”Ÿæˆ ${maxNodes.toLocaleString()} ä¸ªä¸é‡å¤èŠ‚ç‚¹ã€‚\n\nè¶…å‡ºéƒ¨åˆ†å°†äº§ç”Ÿé‡å¤èŠ‚ç‚¹ï¼Œè¿™å¯èƒ½å¯¼è‡´ï¼š\nâ€¢ èŠ‚ç‚¹åŠŸèƒ½é‡å¤\nâ€¢ å­˜å‚¨ç©ºé—´æµªè´¹\nâ€¢ ç®¡ç†å¤æ‚åº¦å¢åŠ \n\næ˜¯å¦ç»§ç»­ç”Ÿæˆï¼Ÿå»ºè®®è°ƒæ•´æ•°é‡ä¸º ${maxNodes} æˆ–æ›´å°‘ã€‚`;
                
                if (!confirm(confirmMessage)) {
                    return;
                }
            }

            const parsedData = parseNodeLink(templateUrl);
            if (!parsedData) {
                alert('æ— æ³•è§£ææºèŠ‚ç‚¹é“¾æ¥ï¼è¯·æ£€æŸ¥æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚');
                return;
            }

            // æ„å»ºåœ°å€æ± 
            const addressPool = [];
            const isBuiltinTabActive = document.getElementById('builtin-tab').classList.contains('active');

            if (isBuiltinTabActive) {
                const selectedRegions = Array.from(document.querySelectorAll('#region-selector input[type="checkbox"]:checked')).map(cb => cb.value);
                const useIPv4 = document.getElementById('useIPv4').checked;
                const useIPv6 = document.getElementById('useIPv6').checked;
                
                if (selectedRegions.length === 0) {
                    alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå†…ç½®åœ°åŒºæ•°æ®æºï¼');
                    return;
                }
                
                if (!useIPv4 && !useIPv6) {
                    alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§IPç‰ˆæœ¬ï¼ˆIPv4æˆ–IPv6ï¼‰ï¼');
                    return;
                }
                
                // å¯¹äºå†…ç½®æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨CIDRæ®µï¼Œä¸é¢„å…ˆå±•å¼€æ‰€æœ‰IP
                selectedRegions.forEach(region => {
                    const data = dataByCountry[region];
                    if (useIPv4 && data.ipv4) addressPool.push(...data.ipv4);
                    if (useIPv6 && data.ipv6) addressPool.push(...data.ipv6);
                    if (data.domains) addressPool.push(...data.domains);
                });
                
                console.log(`å†…ç½®æ•°æ®æºåŠ è½½å®Œæˆ: ${addressPool.length} ä¸ªCIDRæ®µ/åŸŸå`);
            } else {
                const customDataLines = document.getElementById('customData').value.trim().split('\n').filter(Boolean);
                addressPool.push(...customDataLines);
                console.log(`è‡ªå®šä¹‰æ•°æ®æºåŠ è½½å®Œæˆ: ${addressPool.length} ä¸ªæ¡ç›®`);
            }
            
            if (addressPool.length === 0) {
                alert('åœ°å€æ± ä¸ºç©ºï¼è¯·æ£€æŸ¥æ‰€é€‰çš„æ•°æ®æ˜¯å¦æœ‰æ•ˆã€‚');
                return;
            }

            // è·å–é€‰ä¸­çš„ç«¯å£
            const selectedPorts = getSelectedPorts();
            
            // æ™ºèƒ½ç”ŸæˆèŠ‚ç‚¹ï¼šæŒ‰éœ€ç”Ÿæˆï¼Œé¿å…å†…å­˜é—®é¢˜
            const generatedCombinations = [];
            const usedCombinations = new Set(); // é˜²æ­¢é‡å¤
            let attempts = 0;
            const maxAttempts = quantity * 10; // é˜²æ­¢æ— é™å¾ªç¯
            
            while (generatedCombinations.length < quantity && attempts < maxAttempts) {
                attempts++;
                
                // éšæœºé€‰æ‹©ä¸€ä¸ªåœ°å€æº
                const randomAddressItem = addressPool[Math.floor(Math.random() * addressPool.length)];
                if (!randomAddressItem || typeof randomAddressItem !== 'string') continue;
                
                let randomAddress;
                if (randomAddressItem.includes('/')) {
                    // å¤„ç†CIDRæ ¼å¼ - éšæœºç”Ÿæˆä¸€ä¸ªIP
                    const parsedCidr = parseCIDR(randomAddressItem);
                    if (parsedCidr) {
                        randomAddress = getRandomIP(parsedCidr);
                    } else {
                        continue;
                    }
                } else {
                    // ç›´æ¥ä½¿ç”¨IPåœ°å€æˆ–åŸŸå
                    randomAddress = randomAddressItem;
                }
                
                // éšæœºé€‰æ‹©ä¸€ä¸ªç«¯å£
                const randomPort = selectedPorts[Math.floor(Math.random() * selectedPorts.length)];
                
                // åˆ›å»ºå”¯ä¸€æ ‡è¯†ï¼Œé˜²æ­¢é‡å¤
                const combinationKey = `${randomAddress}:${randomPort}`;
                if (!usedCombinations.has(combinationKey)) {
                    usedCombinations.add(combinationKey);
                    generatedCombinations.push({ address: randomAddress, port: randomPort });
                }
            }
            
            if (generatedCombinations.length === 0) {
                alert('æ— æ³•ç”Ÿæˆæœ‰æ•ˆçš„åœ°å€:ç«¯å£ç»„åˆï¼è¯·æ£€æŸ¥æ•°æ®æºé…ç½®ã€‚');
                return;
            }
            
            const selectedCombinations = generatedCombinations;
            
            const generatedNodes = [];
            
            for (const combination of selectedCombinations) {
                let newNode;

                switch (selectedFormat) {
                    case 'vless':
                        if (parsedData.protocol !== 'vless') {
                            alert('æºèŠ‚ç‚¹ä¸æ˜¯ VLESS åè®®ï¼Œæ— æ³•ç”Ÿæˆ VLESS é“¾æ¥ï¼');
                            return;
                        }
                        newNode = createVlessLink(parsedData.config, combination.address, combination.port);
                        break;
                    case 'vmess_json':
                        if (parsedData.protocol !== 'vmess') {
                            alert('æºèŠ‚ç‚¹ä¸æ˜¯ VMess åè®®ï¼Œæ— æ³•ç”Ÿæˆ VMess é“¾æ¥ï¼');
                            return;
                        }
                        newNode = createVmessJsonLink(parsedData.config, combination.address, combination.port);
                        break;
                    case 'vmess_query':
                        if (parsedData.protocol !== 'vmess') {
                            alert('æºèŠ‚ç‚¹ä¸æ˜¯ VMess åè®®ï¼Œæ— æ³•ç”Ÿæˆ VMess é“¾æ¥ï¼');
                            return;
                        }
                        newNode = createVmessQueryLink(parsedData.config, combination.address, combination.port);
                        break;
                }
                
                if (newNode) {
                    generatedNodes.push(newNode);
                }
            }
            
            if (generatedNodes.length < quantity) {
                alert(`æ³¨æ„ï¼šç”±äºåœ°å€æ± é™åˆ¶ï¼Œå®é™…ç”Ÿæˆäº† ${generatedNodes.length} ä¸ªèŠ‚ç‚¹ï¼ˆè¯·æ±‚ ${quantity} ä¸ªï¼‰ã€‚\n\nå»ºè®®ï¼š\nâ€¢ å¢åŠ æ›´å¤šåœ°å€æº\nâ€¢ å‡å°‘ç”Ÿæˆæ•°é‡\nâ€¢ æ£€æŸ¥CIDRé…ç½®æ˜¯å¦æ­£ç¡®`);
            } else {
                alert(`âœ… æˆåŠŸç”Ÿæˆ ${generatedNodes.length} ä¸ªä¸é‡å¤èŠ‚ç‚¹ï¼`);
            }

            document.getElementById('output').value = generatedNodes.join('\n');
        }

        // ä»CIDRç”ŸæˆéšæœºIPçš„å‡½æ•°
        function generateRandomIPFromCIDR(cidr) {
            const [baseIP, prefix] = cidr.split('/');
            const prefixNum = parseInt(prefix);
            
            // å°†IPè½¬æ¢ä¸º32ä½æ•´æ•°
            const ipParts = baseIP.split('.').map(Number);
            let baseIPInt = (ipParts[0] << 24) + (ipParts[1] << 16) + (ipParts[2] << 8) + ipParts[3];
            
            // è®¡ç®—ç½‘ç»œæ©ç 
            const mask = (0xFFFFFFFF << (32 - prefixNum)) >>> 0;
            const networkAddress = baseIPInt & mask;
            
            // è®¡ç®—å¯ç”¨IPèŒƒå›´
            const totalIPs = Math.pow(2, 32 - prefixNum);
            const randomOffset = Math.floor(Math.random() * totalIPs);
            
            // ç”ŸæˆéšæœºIPï¼ˆè·³è¿‡ç½‘ç»œåœ°å€å’Œå¹¿æ’­åœ°å€ï¼‰
            const randomIPInt = networkAddress + randomOffset;
            
            // è½¬æ¢å›IPå­—ç¬¦ä¸²
            const ip1 = (randomIPInt >>> 24) & 0xFF;
            const ip2 = (randomIPInt >>> 16) & 0xFF;
            const ip3 = (randomIPInt >>> 8) & 0xFF;
            const ip4 = randomIPInt & 0xFF;
            
            return `${ip1}.${ip2}.${ip3}.${ip4}`;
        }

        // =================================================================
        // é¡µé¢åˆå§‹åŒ–
        // =================================================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('é¡µé¢å¼€å§‹åˆå§‹åŒ–...');
            
            try {
                // åˆå§‹åŒ–æ¨¡æ€æ¡†
                const authModalElement = document.getElementById('authModal');
                if (authModalElement) {
                    authModal = new bootstrap.Modal(authModalElement);
                }
                
                const addSourceModalElement = document.getElementById('addSourceModal');
                if (addSourceModalElement) {
                    addSourceModal = new bootstrap.Modal(addSourceModalElement);
                }
                
                const createTagModalElement = document.getElementById('createTagModal');
                if (createTagModalElement) {
                    createTagModal = new bootstrap.Modal(createTagModalElement);
                }

                // åˆå§‹åŒ–åœ°åŒºé€‰æ‹©å™¨
                initializeRegionSelector();

                // æ·»åŠ æ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶ç›‘å¬å™¨
                const nodePoolTab = document.getElementById('nodepool-tab');
                if (nodePoolTab) {
                    nodePoolTab.addEventListener('shown.bs.tab', function (event) {
                        console.log('åˆ‡æ¢åˆ°èŠ‚ç‚¹æ± æ ‡ç­¾ï¼Œå¼€å§‹åŠ è½½èŠ‚ç‚¹...');
                        loadNodePool(); // å½“æ ‡ç­¾æ˜¾ç¤ºæ—¶åŠ è½½èŠ‚ç‚¹
                    });
                }

                // æ·»åŠ è®¢é˜…æºç®¡ç†æ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶ç›‘å¬å™¨
                const managerTab = document.getElementById('manager-tab');
                if (managerTab) {
                    managerTab.addEventListener('shown.bs.tab', function (event) {
                        console.log('åˆ‡æ¢åˆ°è®¢é˜…æºç®¡ç†æ ‡ç­¾ï¼Œå¼€å§‹åŠ è½½è®¢é˜…æº...');
                        loadSubscriptionSources(); // å½“æ ‡ç­¾æ˜¾ç¤ºæ—¶åŠ è½½è®¢é˜…æº
                    });
                }

                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                checkLoginStatus();
                
                console.log('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                // å¦‚æœåˆå§‹åŒ–å¤±è´¥ï¼Œè‡³å°‘æ˜¾ç¤ºç™»å½•æç¤º
                const loginPrompt = document.getElementById('login-prompt');
                if (loginPrompt) {
                    loginPrompt.style.display = 'block';
                }
            }
        });
    </script>
</body>
</html>