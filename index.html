<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>订阅聚合管理平台 V2.0</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      .node-generator-card {
        margin-bottom: 1rem;
      }
      .save-to-tag-section {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.375rem;
      }
      .estimation {
        font-weight: bold;
        color: #0d6efd;
        text-align: center;
        padding: 0.5rem;
        background-color: #e7f3ff;
        border-radius: 0.25rem;
      }
      #region-selector {
        display: flex;
        flex-wrap: wrap;
        gap: 10px 20px;
        padding: 10px;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
      }
      .region-checkbox {
        display: flex;
        align-items: center;
      }
      .region-checkbox label {
        margin-bottom: 0;
        margin-left: 5px;
        font-weight: normal;
      }
      .ip-version-selector {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
      }
      .ip-version-selector .form-check-label {
        font-size: 0.95rem;
      }
      .ip-version-selector .form-check {
        margin-right: 1rem;
      }

      /* 节点池管理优化样式 */
      #nodepool-tab-pane .container-fluid {
        max-width: 100%;
        padding-left: 0;
        padding-right: 0;
      }

      #nodepool-tab-pane .card {
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      }

      #nodepool-tab-pane .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
      }

      /* 确保标签页内容正确隔离 */
      .tab-pane {
        display: none;
      }

      .tab-pane.active {
        display: block;
      }

      /* 源节点管理页面优化 */
      #source-nodes-tab-pane .card {
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        margin-bottom: 1.5rem;
      }

      #source-nodes-tab-pane .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <!-- Global Alert Container -->
    <div
      id="global-alert"
      class="alert"
      style="
        display: none;
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        max-width: 400px;
      "
    ></div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="#">📡 订阅聚合管理平台 V2.0</a>
        <div id="user-status-area">
          <button
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#authModal"
          >
            登录 / 注册
          </button>
        </div>
      </div>
    </nav>

    <!-- Login Prompt -->
    <div id="login-prompt" class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-md-8 text-center">
          <h1 class="display-4">🏷️ 订阅聚合管理平台</h1>
          <p class="lead">基于Tag的智能节点管理系统</p>
          <div class="card mt-4">
            <div class="card-body">
              <h5 class="card-title">✨ 主要功能</h5>
              <div class="row">
                <div class="col-md-6">
                  <ul class="list-unstyled text-start">
                    <li>🏷️ <strong>Tag管理</strong> - 按用途分类节点</li>
                    <li>⚡ <strong>节点生成</strong> - 批量生成节点</li>
                  </ul>
                </div>
                <div class="col-md-6">
                  <ul class="list-unstyled text-start">
                    <li>📡 <strong>订阅源</strong> - 导入外部订阅</li>
                    <li>🔄 <strong>状态反馈</strong> - 智能节点优化</li>
                  </ul>
                </div>
              </div>
              <button
                class="btn btn-primary btn-lg mt-3"
                data-bs-toggle="modal"
                data-bs-target="#authModal"
              >
                立即开始使用
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" style="display: none">
      <div class="container my-4">
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs" id="mainTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button
              class="nav-link active"
              id="tag-management-tab"
              data-bs-toggle="tab"
              data-bs-target="#tag-management-tab-pane"
              type="button"
              role="tab"
            >
              🏷️ Tag管理
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="generator-tab"
              data-bs-toggle="tab"
              data-bs-target="#generator-tab-pane"
              type="button"
              role="tab"
            >
              ⚡ 节点生成器
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="manager-tab"
              data-bs-toggle="tab"
              data-bs-target="#manager-tab-pane"
              type="button"
              role="tab"
            >
              📡 订阅源管理
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="source-nodes-tab"
              data-bs-toggle="tab"
              data-bs-target="#source-nodes-tab-pane"
              type="button"
              role="tab"
            >
              🔧 源节点管理
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              id="nodepool-tab"
              data-bs-toggle="tab"
              data-bs-target="#nodepool-tab-pane"
              type="button"
              role="tab"
            >
              🎯 节点池管理
            </button>
          </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="mainTabContent">
          <!-- Tag Management Tab -->
          <div
            class="tab-pane fade show active"
            id="tag-management-tab-pane"
            role="tabpanel"
          >
            <div class="card mt-3">
              <div
                class="card-header d-flex justify-content-between align-items-center"
              >
                <span>🏷️ 我的Tag管理</span>
                <button
                  class="btn btn-primary btn-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#createTagModal"
                >
                  + 创建新Tag
                </button>
              </div>
              <div class="card-body">
                <div id="tags-list" class="mb-4">
                  <div class="text-center p-3 text-muted">正在加载Tag...</div>
                </div>

                <!-- 节点批量操作区域 -->
                <div class="border-top pt-4">
                  <h5 class="mb-3">🔄 节点批量操作</h5>
                  <div class="alert alert-info" id="batch-operation-guide">
                    <div
                      class="d-flex justify-content-between align-items-start"
                    >
                      <div class="flex-grow-1">
                        <strong>💡 使用说明：</strong>
                        <ol class="mb-0 mt-2">
                          <li>
                            <strong>勾选Tag</strong
                            >：在上方Tag卡片中勾选要操作的Tag（可多选）
                          </li>
                          <li>
                            <strong>粘贴节点</strong
                            >：将节点链接粘贴到下方文本框
                          </li>
                          <li>
                            <strong>选择操作</strong
                            >：添加到选中Tag或从选中Tag删除
                          </li>
                        </ol>
                      </div>
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-secondary ms-2"
                        onclick="collapseAlert('batch-operation-guide')"
                      >
                        确定
                      </button>
                    </div>
                  </div>

                  <div class="mb-3">
                    <label for="node-feedback-textarea" class="form-label"
                      ><strong>📝 节点列表</strong></label
                    >
                    <textarea
                      class="form-control"
                      id="node-feedback-textarea"
                      rows="6"
                      placeholder="将节点链接粘贴到此处，每行一个...&#10;&#10;示例：&#10;vless://uuid@server:port?params#name&#10;vmess://base64data"
                    ></textarea>
                  </div>

                  <div class="d-flex gap-2 flex-wrap">
                    <button
                      class="btn btn-success"
                      onclick="batchOperateNodes('add')"
                    >
                      ✅ 添加到选中Tag
                    </button>
                    <button
                      class="btn btn-danger"
                      onclick="batchOperateNodes('delete')"
                    >
                      🗑️ 从选中Tag删除
                    </button>
                    <button
                      class="btn btn-outline-secondary"
                      onclick="clearNodeTextarea()"
                    >
                      🧹 清空文本框
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Node Generator Tab -->
          <div class="tab-pane fade" id="generator-tab-pane" role="tabpanel">
            <div class="text-center mb-4 mt-3">
              <h1 class="display-5">⚡ 终极节点生成器</h1>
              <p class="lead text-muted">
                一个强大、灵活的在线节点批量生成工具
              </p>
            </div>

            <div class="alert alert-info" id="usage-guide">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                  <h4 class="alert-heading">📖 使用说明</h4>
                  <ol class="mb-3">
                    <li>
                      在"第一步"区域，选择"内置数据"或"手动粘贴"来提供地址。
                    </li>
                    <li>在"第二步"粘贴一个 VLESS 或 VMess 链接作为模板。</li>
                    <li>点击"生成节点"即可获取多个节点链接。</li>
                    <li>
                      <strong>V2.0新功能：</strong
                      >生成后可以将节点保存到Tag中进行分类管理。
                    </li>
                  </ol>

                  <div class="alert alert-warning mb-0">
                    <h6 class="alert-heading">⚠️ 端口选择重要提示</h6>
                    <ul class="mb-0">
                      <li>
                        <strong>国内网络环境：</strong>
                        <ul>
                          <li>
                            <strong>IPv4</strong>：建议仅选择
                            <code>443</code> 端口，其他端口大部分被运营商封锁
                          </li>
                          <li>
                            <strong>IPv6</strong
                            >：可选择多个端口，连通性相对较好
                          </li>
                        </ul>
                      </li>
                      <li>
                        <strong>海外CF网段：</strong>IPv4优先测试
                        <code>443</code> 端口，IPv6可多端口测试
                      </li>
                      <li>
                        <strong>推荐策略：</strong>首次测试只选
                        <code>443</code> 端口，确认可用后再尝试其他端口
                      </li>
                      <li>
                        <strong>提示：</strong>内置数据源默认只选择
                        <code>443</code> 端口，可根据需要调整
                      </li>
                    </ul>
                  </div>
                </div>
                <button
                  type="button"
                  class="btn btn-sm btn-outline-secondary ms-3"
                  onclick="collapseAlert('usage-guide')"
                >
                  确定
                </button>
              </div>
            </div>

            <div class="card mb-3">
              <div class="card-header">第一步：提供数据源</div>
              <div class="card-body">
                <ul class="nav nav-tabs" id="sourceTab" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button
                      class="nav-link active"
                      id="builtin-tab"
                      data-bs-toggle="tab"
                      data-bs-target="#builtin-tab-pane"
                      type="button"
                      onclick="updateEstimation()"
                    >
                      内置地区数据
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button
                      class="nav-link"
                      id="manual-tab"
                      data-bs-toggle="tab"
                      data-bs-target="#manual-tab-pane"
                      type="button"
                      onclick="updateEstimation()"
                    >
                      自定义粘贴数据
                    </button>
                  </li>
                </ul>
                <div class="tab-content" id="sourceTabContent">
                  <div
                    class="tab-pane fade show active p-3"
                    id="builtin-tab-pane"
                    role="tabpanel"
                  >
                    <p class="text-muted">请勾选您想使用的内置数据源：</p>

                    <!-- IP版本选择 -->
                    <div class="mb-3 p-3 ip-version-selector rounded">
                      <label class="form-label fw-bold mb-2"
                        >🌐 IP版本选择：</label
                      >
                      <div class="d-flex flex-wrap gap-3">
                        <div class="form-check">
                          <input
                            class="form-check-input"
                            type="checkbox"
                            id="useIPv4"
                            checked
                            onchange="updateEstimation()"
                          />
                          <label class="form-check-label" for="useIPv4">
                            <strong>IPv4</strong>
                            <small class="text-muted">(适用于大部分网络)</small>
                          </label>
                        </div>
                        <div class="form-check">
                          <input
                            class="form-check-input"
                            type="checkbox"
                            id="useIPv6"
                            checked
                            onchange="updateEstimation()"
                          />
                          <label class="form-check-label" for="useIPv6">
                            <strong>IPv6</strong>
                            <small class="text-muted">(现代网络支持)</small>
                          </label>
                        </div>
                      </div>
                      <small class="text-muted d-block mt-1"
                        >💡
                        提示：可以同时选择两种版本，或根据网络环境选择其中一种</small
                      >
                    </div>

                    <!-- 地区选择 -->
                    <div class="mb-3">
                      <label class="form-label fw-bold">🌍 地区选择：</label>
                      <div id="region-selector">
                        <!-- Region checkboxes will be inserted here -->
                      </div>
                    </div>

                    <!-- HTTPS端口选择 -->
                    <div class="mb-3 p-3 port-selector rounded border">
                      <label class="form-label fw-bold mb-2"
                        >🔌 HTTPS端口选择：</label
                      >
                      <div class="row" id="builtin-https-port-selector">
                        <!-- 端口选择框将在这里动态生成 -->
                      </div>
                      <div
                        class="alert alert-warning mt-3 mb-0"
                        id="builtin-port-tips"
                      >
                        <div
                          class="d-flex justify-content-between align-items-start"
                        >
                          <div class="flex-grow-1">
                            <strong>⚠️ 重要提示：</strong><br />
                            • <strong>国内IPv4</strong>：建议仅选择
                            <code>443</code> 端口，其他端口可能被封锁<br />
                            •
                            <strong>国内IPv6</strong
                            >：可选择多个端口，连通性较好<br />
                            • <strong>海外CF网段</strong>：IPv4优先测试
                            <code>443</code> 端口，IPv6可多端口测试<br />
                            • <strong>建议策略</strong>：首次测试只选
                            <code>443</code>，确认可用后再尝试其他端口
                          </div>
                          <button
                            type="button"
                            class="btn btn-sm btn-outline-secondary ms-2"
                            onclick="collapseAlert('builtin-port-tips')"
                          >
                            确定
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div
                    class="tab-pane fade p-3"
                    id="manual-tab-pane"
                    role="tabpanel"
                  >
                    <div class="mb-3">
                      <label for="customData" class="form-label"
                        ><strong
                          >自定义地址 (IP、CIDR 或域名，每行一个):</strong
                        ></label
                      >
                      <textarea
                        class="form-control"
                        id="customData"
                        rows="6"
                        oninput="updateEstimation()"
                        placeholder="示例：&#10;104.28.43.45/32&#10;192.168.1.0/24&#10;2a09:bac1:19c0:10::/64&#10;example.com"
                      ></textarea>
                      <div class="mt-2">
                        <button
                          type="button"
                          class="btn btn-sm btn-outline-info"
                          onclick="testCIDRParsing()"
                        >
                          🔧 测试CIDR解析 (查看控制台)
                        </button>
                        <small class="text-muted ms-2"
                          >点击后请打开浏览器控制台查看测试结果</small
                        >
                      </div>
                    </div>

                    <!-- HTTPS端口选择 -->
                    <div class="mb-3 p-3 port-selector rounded border">
                      <label class="form-label fw-bold mb-2"
                        >🔌 HTTPS端口选择：</label
                      >
                      <div class="row" id="https-port-selector">
                        <!-- 端口选择框将在这里动态生成 -->
                      </div>
                      <div
                        class="alert alert-info mt-2 mb-0"
                        id="custom-port-tips"
                      >
                        <div
                          class="d-flex justify-content-between align-items-start"
                        >
                          <div class="flex-grow-1">
                            <small
                              >💡
                              <strong>提示：</strong
                              >选择的端口将与地址组合生成节点，建议保持默认全选</small
                            >
                          </div>
                          <button
                            type="button"
                            class="btn btn-sm btn-outline-secondary ms-2"
                            onclick="collapseAlert('custom-port-tips')"
                          >
                            确定
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card mb-3">
              <div class="card-header">第二步：设置模板和选项</div>
              <div class="card-body">
                <!-- 模板节点选择 -->
                <div class="mb-3">
                  <label for="templateNodeSelect" class="form-label">
                    <strong>🌐 选择模板节点:</strong>
                  </label>
                  <select
                    class="form-select"
                    id="templateNodeSelect"
                    onchange="onTemplateNodeSelect()"
                  >
                    <option value="">请选择模板节点...</option>
                  </select>
                  <div class="form-text">
                    💡
                    从您的Tag节点中选择一个作为生成模板，如果没有可用节点请先添加节点到Tag
                  </div>
                </div>

                <!-- 手动粘贴节点（备用方案） -->
                <div class="mb-3">
                  <label for="templateUrl" class="form-label">
                    <strong>📝 或手动粘贴节点链接:</strong>
                  </label>
                  <input
                    type="text"
                    class="form-control"
                    id="templateUrl"
                    placeholder="vless://... 或 vmess://... (如果上方没有可选节点，可在此粘贴)"
                    oninput="onTemplateUrlInput()"
                  />
                </div>

                <!-- 输出格式选择 -->
                <div class="mt-3">
                  <label class="form-label">
                    <strong>🎯 选择输出格式:</strong>
                  </label>
                  <div id="format-selector">
                    <div class="form-check form-check-inline">
                      <input
                        class="form-check-input"
                        type="radio"
                        name="outputFormat"
                        id="formatVless"
                        value="vless"
                      />
                      <label class="form-check-label" for="formatVless"
                        >VLESS</label
                      >
                    </div>
                    <div class="form-check form-check-inline">
                      <input
                        class="form-check-input"
                        type="radio"
                        name="outputFormat"
                        id="formatVmessJson"
                        value="vmess_json"
                        checked
                      />
                      <label class="form-check-label" for="formatVmessJson"
                        >VMess (for v2rayN/U)</label
                      >
                    </div>
                    <div class="form-check form-check-inline">
                      <input
                        class="form-check-input"
                        type="radio"
                        name="outputFormat"
                        id="formatVmessQuery"
                        value="vmess_query"
                      />
                      <label class="form-check-label" for="formatVmessQuery"
                        >VMess (for Shadowrocket)</label
                      >
                    </div>
                  </div>
                </div>

                <div id="estimation" class="alert alert-info estimation">
                  <strong>准备就绪</strong><br />
                  <small class="text-muted">请先配置数据源和模板</small>
                </div>
              </div>
            </div>

            <div class="card mb-3">
              <div class="card-header">第三步：生成节点</div>
              <div class="card-body">
                <div class="mb-3">
                  <label for="quantity" class="form-label">生成数量:</label>
                  <input
                    type="number"
                    class="form-control"
                    id="quantity"
                    value="20"
                    min="1"
                    oninput="validateQuantityInput()"
                    onchange="validateQuantityInput()"
                  />
                  <div class="form-text">
                    建议根据上方显示的最大可生成数量来设置
                  </div>
                </div>
                <div class="d-grid">
                  <button
                    class="btn btn-primary btn-lg"
                    onclick="generateNodes()"
                  >
                    生成节点
                  </button>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">生成结果</div>
              <div class="card-body">
                <textarea
                  class="form-control"
                  id="output"
                  rows="10"
                  readonly
                ></textarea>
                <div class="d-flex mt-3 gap-2">
                  <button
                    class="btn btn-success w-100"
                    id="copyButton"
                    onclick="copyResults()"
                  >
                    一键复制
                  </button>
                </div>

                <!-- Save to Tag Section -->
                <div class="save-to-tag-section mt-4">
                  <h5 class="mb-3">💾 将这些节点存入Tag</h5>
                  <div class="row g-2 mb-3">
                    <div class="col-md-6">
                      <label for="existing-tag-select" class="form-label"
                        >选择已有Tag</label
                      >
                      <select class="form-select" id="existing-tag-select">
                        <option value="">-- 选择一个已有Tag --</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label for="new-tag-input" class="form-label"
                        >或创建新Tag</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="new-tag-input"
                        placeholder="输入新Tag名称..."
                      />
                    </div>
                  </div>
                  <div class="d-grid">
                    <button class="btn btn-primary" onclick="saveNodesToTag()">
                      🏷️ 存入Tag
                    </button>
                  </div>
                  <div
                    id="save-tag-result"
                    class="mt-2"
                    style="display: none"
                  ></div>
                </div>

                <div class="mt-3" id="sub-result-area" style="display: none">
                  <div class="alert alert-success">
                    <h4 class="alert-heading">🚀 您的专属订阅已更新！</h4>
                    <p>
                      您的永久订阅链接已包含最新生成的节点。您只需在客户端更新订阅即可，无需更换链接。
                    </p>
                    <hr />
                    <p class="mb-0">请将以下链接配置到您的客户端中：</p>
                  </div>
                  <ul class="list-group">
                    <li
                      class="list-group-item d-flex justify-content-between align-items-center"
                    >
                      <div>
                        <strong>标准格式 (V2Ray)</strong>
                        <small
                          class="d-block text-muted"
                          id="subLinkBase64"
                        ></small>
                      </div>
                      <button
                        class="btn btn-sm btn-outline-secondary"
                        onclick="copyToClipboard('subLinkBase64')"
                      >
                        复制
                      </button>
                    </li>
                    <li
                      class="list-group-item d-flex justify-content-between align-items-center"
                    >
                      <div>
                        <strong>Clash 格式</strong>
                        <small
                          class="d-block text-muted"
                          id="subLinkClash"
                        ></small>
                      </div>
                      <button
                        class="btn btn-sm btn-outline-secondary"
                        onclick="copyToClipboard('subLinkClash')"
                      >
                        复制
                      </button>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <!-- Subscription Sources Tab -->
          <div class="tab-pane fade" id="manager-tab-pane" role="tabpanel">
            <div class="card mt-3">
              <div
                class="card-header d-flex justify-content-between align-items-center"
              >
                <span>📡 我的订阅源</span>
                <button
                  class="btn btn-primary btn-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#addSourceModal"
                >
                  + 添加新订阅源
                </button>
              </div>
              <div class="card-body">
                <div id="subscription-sources-list" class="list-group">
                  <div class="text-center p-3 text-muted">
                    正在加载订阅源...
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Source Nodes Management Tab -->
          <div class="tab-pane fade" id="source-nodes-tab-pane" role="tabpanel">
            <div class="text-center mb-4 mt-3">
              <h1 class="display-5">🔧 源节点管理</h1>
              <p class="lead text-muted">ProxyIP 源节点生成与管理</p>
            </div>

            <!-- 默认源节点显示区域 -->
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0">🌟 系统默认源节点</h5>
                <small class="text-muted"
                  >系统为您自动创建的基础源节点，可以直接使用或基于它们扩展更多节点</small
                >
              </div>
              <div class="card-body">
                <div id="default-source-nodes">
                  <div class="text-center p-3 text-muted">
                    正在加载默认源节点...
                  </div>
                </div>
              </div>
            </div>

            <!-- 源节点配置器 -->
            <div class="card mb-4">
              <div class="card-header bg-success text-white">
                <h5 class="mb-0">🌍 源节点配置</h5>
                <small>配置ProxyIP类型的源节点，支持自定义IP地址和参数</small>
              </div>
              <div class="card-body">
                <form id="proxyip-form">
                  <div class="mb-3">
                    <label for="proxyip-name" class="form-label"
                      >配置名称</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="proxyip-name"
                      placeholder="例如：我的ProxyIP节点"
                    />
                  </div>
                  <!-- 域名字段已隐藏，系统自动获取当前域名 -->
                  <input type="hidden" id="proxyip-domain" />
                  <div class="mb-3">
                    <label for="proxyip-uuid" class="form-label">UUID</label>
                    <div class="input-group">
                      <input
                        type="text"
                        class="form-control"
                        id="proxyip-uuid"
                        placeholder="点击生成UUID"
                      />
                      <button
                        class="btn btn-outline-secondary"
                        type="button"
                        onclick="generateUUID('proxyip-uuid')"
                      >
                        生成
                      </button>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="proxyip-address" class="form-label"
                      >代理IP地址</label
                    >
                    <div class="input-group">
                      <input
                        type="text"
                        class="form-control"
                        id="proxyip-address"
                        placeholder="例如：164.90.228.172"
                      />
                      <button
                        class="btn btn-outline-info"
                        type="button"
                        onclick="openProxyIPSelector()"
                        title="获取可用代理IP"
                      >
                        🌐 获取代理IP
                      </button>
                    </div>
                    <div class="form-text">
                      点击"获取代理IP"按钮测试可用IP，选择您想要的落地地区
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="proxyip-port" class="form-label"
                      >🔌 HTTPS端口选择</label
                    >
                    <select class="form-control" id="proxyip-port">
                      <option value="443">443</option>
                      <option value="2053">2053</option>
                      <option value="2083">2083</option>
                      <option value="2087">2087</option>
                      <option value="2096">2096</option>
                      <option value="8443">8443</option>
                    </select>
                  </div>
                  <div class="d-grid gap-2">
                    <button
                      type="button"
                      class="btn btn-success"
                      onclick="generateAndSaveProxyIPNode()"
                    >
                      🔧 配置源节点
                    </button>
                  </div>
                </form>
                <div
                  class="mt-3"
                  id="proxyip-result-area"
                  style="display: none"
                >
                  <label for="proxyip-result" class="form-label"
                    >生成的源节点</label
                  >
                  <div class="input-group">
                    <textarea
                      class="form-control"
                      id="proxyip-result"
                      rows="3"
                      readonly
                    ></textarea>
                    <button
                      class="btn btn-outline-primary"
                      type="button"
                      onclick="copyToClipboard('proxyip-result')"
                    >
                      📋
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- 自定义源节点配置列表 -->
            <div class="card">
              <div
                class="card-header d-flex justify-content-between align-items-center"
              >
                <h5 class="mb-0">📋 我的源节点配置</h5>
                <button
                  class="btn btn-outline-primary btn-sm"
                  onclick="refreshSourceNodes()"
                >
                  🔄 刷新
                </button>
              </div>
              <div class="card-body">
                <div id="custom-source-nodes">
                  <div class="text-center p-3 text-muted">
                    正在加载源节点配置...
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Node Pool Tab -->
          <div class="tab-pane fade" id="nodepool-tab-pane" role="tabpanel">
            <div class="container-fluid px-0">
              <div class="card mt-3">
                <div
                  class="card-header d-flex justify-content-between align-items-center"
                >
                  <span>🎯 我的节点池</span>
                  <div>
                    <span id="node-count-badge" class="badge bg-info me-2"
                      >总计: 0</span
                    >
                    <button
                      class="btn btn-outline-primary btn-sm"
                      onclick="refreshAllSources()"
                    >
                      🔄 刷新所有源
                    </button>
                  </div>
                </div>
                <div class="card-body">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <div class="input-group">
                        <span class="input-group-text">🔍</span>
                        <input
                          type="text"
                          class="form-control"
                          id="node-search"
                          placeholder="搜索节点名称或来源..."
                          oninput="filterNodes()"
                        />
                      </div>
                    </div>
                    <div class="col-md-3">
                      <select
                        class="form-select"
                        id="source-filter"
                        onchange="filterNodes()"
                      >
                        <option value="">所有来源</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <select
                        class="form-select"
                        id="protocol-filter"
                        onchange="filterNodes()"
                      >
                        <option value="">所有协议</option>
                        <option value="vmess">VMess</option>
                        <option value="vless">VLESS</option>
                        <option value="trojan">Trojan</option>
                        <option value="ss">Shadowsocks</option>
                      </select>
                    </div>
                  </div>

                  <div id="node-pool-list" class="list-group">
                    <div class="text-center p-3 text-muted">
                      正在加载节点...
                    </div>
                  </div>

                  <nav aria-label="节点分页" class="mt-3">
                    <ul
                      class="pagination justify-content-center"
                      id="node-pagination"
                    ></ul>
                  </nav>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="bg-light py-3 mt-5">
      <div class="container">
        <div class="text-center">
          <p
            class="text-muted"
            style="font-size: 0.8rem; margin-bottom: 0.5rem"
          >
            Cloudflare节点聚合管理平台 Power by @samni728
          </p>
          <div
            class="d-flex justify-content-center align-items-center gap-3 mb-2"
          >
            <a
              href="https://github.com/samni728/cfvless-admin"
              target="_blank"
              class="text-muted text-decoration-none"
              title="项目地址"
            >
              <i class="bi bi-github fs-6"></i>
            </a>
            <a
              href="https://github.com/samni728/cfvless-admin"
              target="_blank"
              class="text-decoration-none"
              onclick="openGitHubStar()"
              title="给个 Star"
            >
              <i class="bi bi-star-fill fs-6" style="color: #ffc107"></i>
            </a>
          </div>
          <small class="text-muted" style="font-size: 0.75rem"
            >最后更新: 2025-8-25</small
          >
        </div>
      </div>
    </footer>

    <!-- Modals -->

    <!-- Auth Modal -->
    <div
      class="modal fade"
      id="authModal"
      tabindex="-1"
      aria-labelledby="authModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="authModalLabel">用户登录</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="auth-alert" class="alert" style="display: none"></div>
            <div class="mb-3">
              <label for="username" class="form-label">用户名</label>
              <input
                type="text"
                class="form-control"
                id="username"
                required
                autocomplete="username"
              />
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">密码</label>
              <input
                type="password"
                class="form-control"
                id="password"
                required
                autocomplete="current-password"
              />
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="switchAuthMode()"
            >
              切换到注册
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="performAuth()"
            >
              登录
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Create Tag Modal -->
    <div
      class="modal fade"
      id="createTagModal"
      tabindex="-1"
      aria-labelledby="createTagModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="createTagModalLabel">创建新Tag</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div
              id="create-tag-alert"
              class="alert"
              style="display: none"
            ></div>
            <div class="mb-3">
              <label for="tagName" class="form-label"
                >Tag名称 <span class="text-danger">*</span></label
              >
              <input
                type="text"
                class="form-control"
                id="tagName"
                required
                placeholder="例如: 游戏专用, 主力节点"
              />
              <div class="form-text">
                用于分类管理您的节点，如：游戏专用、主力节点、备用线路等
              </div>
            </div>
            <div class="mb-3">
              <label for="tagDescription" class="form-label">描述 (可选)</label>
              <textarea
                class="form-control"
                id="tagDescription"
                rows="2"
                placeholder="简单描述这个Tag的用途..."
              ></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              取消
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="createNewTag()"
            >
              创建Tag
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Import to Tag Modal -->
    <div
      class="modal fade"
      id="importToTagModal"
      tabindex="-1"
      aria-labelledby="importToTagModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="importToTagModalLabel">🏷️ 导入到Tag</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div
              id="import-tag-alert"
              class="alert"
              style="display: none"
            ></div>
            <div class="mb-3">
              <label for="importTagSelect" class="form-label">选择Tag</label>
              <select class="form-control" id="importTagSelect">
                <option value="">默认导入到"源节点"Tag</option>
              </select>
              <div class="form-text">
                选择要将源节点导入到哪个Tag，留空则导入到默认的"源节点"Tag
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              取消
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="confirmImportToTag()"
            >
              确认导入
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 添加节点到Tag模态框 -->
    <div
      class="modal fade"
      id="addToTagModal"
      tabindex="-1"
      aria-labelledby="addToTagModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addToTagModalLabel">🏷️ 添加到Tag</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div
              id="add-to-tag-alert"
              class="alert"
              style="display: none"
            ></div>
            <div class="mb-3">
              <label for="addToTagSelect" class="form-label">选择Tag</label>
              <select class="form-control" id="addToTagSelect">
                <option value="">请选择Tag...</option>
              </select>
              <div class="form-text">选择要将节点添加到哪个Tag</div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              取消
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="confirmAddToTag()"
            >
              确认添加
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ProxyIP Selector Modal -->
    <div
      class="modal fade"
      id="proxyIPSelectorModal"
      tabindex="-1"
      aria-labelledby="proxyIPSelectorModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="proxyIPSelectorModalLabel">
              🌐 获取可用代理IP
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-info">
              <h6>📋 使用说明</h6>
              <ol class="mb-0">
                <li>点击下方"打开测试页面"按钮</li>
                <li>在打开的页面中点击"单次测试"</li>
                <li>查看测试结果列表，选择您想要的IP地址</li>
                <li>复制IP地址，粘贴到代理IP地址输入框</li>
              </ol>
            </div>
            <div class="d-grid gap-2">
              <button
                type="button"
                class="btn btn-primary btn-lg"
                onclick="openProxyIPTestPage()"
              >
                🔗 打开测试页面
              </button>
            </div>
            <div class="mt-3">
              <h6>💡 提示</h6>
              <ul class="mb-0">
                <li>选择延迟较低的IP地址以获得更好的连接体验</li>
                <li>不同地区的IP可能提供不同的网络访问效果</li>
                <li>建议选择您目标地区的IP地址</li>
              </ul>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              关闭
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Source Modal -->
    <div
      class="modal fade"
      id="addSourceModal"
      tabindex="-1"
      aria-labelledby="addSourceModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addSourceModalLabel">添加新订阅源</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div
              id="add-source-alert"
              class="alert"
              style="display: none"
            ></div>
            <div class="mb-3">
              <label for="sourceName" class="form-label"
                >订阅名称 (例如: 机场A)</label
              >
              <input
                type="text"
                class="form-control"
                id="sourceName"
                required
              />
            </div>
            <div class="mb-3">
              <label for="sourceUrl" class="form-label">订阅链接 (URL)</label>
              <input type="url" class="form-control" id="sourceUrl" required />
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              取消
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="addSubscriptionSource()"
            >
              确认添加
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // =================================================================
      // 数据配置 - 从 data.js 嵌入
      // =================================================================
      const dataByCountry = {
        "🇺🇸 美国 (US)": {
          ipv4: [
            "8.6.144.0/24", "8.6.145.0/24", "8.6.146.0/24", "8.9.231.0/24", "8.10.148.0/24",
            "8.14.199.0/24", "8.14.201.0/24", "8.14.202.0/24", "8.14.203.0/24", "8.14.204.0/24",
            "8.17.205.0/24", "8.17.206.0/24", "8.18.50.0/24", "8.18.113.0/24", "8.18.194.0/24",
            "8.18.195.0/24", "8.18.196.0/24", "8.19.8.0/24", "8.20.100.0/24", "8.20.101.0/24",
            "8.20.103.0/24", "8.20.122.0/24", "8.20.123.0/24", "8.20.124.0/24", "8.20.125.0/24",
            "8.20.126.0/24", "8.20.253.0/24", "8.21.8.0/24", "8.21.9.0/24", "8.21.10.0/24",
            "8.21.13.0/24", "8.21.110.0/24", "8.21.111.0/24", "8.21.239.0/24", "8.23.139.0/24",
            "8.23.240.0/24", "8.24.87.0/24", "8.24.242.0/24", "8.24.243.0/24", "8.24.244.0/24",
            "8.25.96.0/24", "8.25.97.0/24", "8.25.249.0/24", "8.26.180.0/24", "8.26.182.0/24",
            "8.27.64.0/24", "8.27.66.0/24", "8.27.67.0/24", "8.27.68.0/24", "8.27.69.0/24",
            "8.27.79.0/24", "8.28.20.0/24", "8.28.82.0/24", "8.28.126.0/24", "8.28.213.0/24",
            "8.29.105.0/24", "8.29.230.0/24", "8.29.231.0/24", "8.30.234.0/24", "8.31.2.0/24",
            "8.31.160.0/24", "8.31.161.0/24", "8.34.69.0/24", "8.34.70.0/24", "8.34.71.0/24",
            "8.34.200.0/24", "8.34.201.0/24", "8.34.202.0/24", "8.35.57.0/24", "8.35.58.0/24",
            "8.35.59.0/24", "8.35.149.0/24", "8.35.211.0/24", "8.36.216.0/24", "8.36.217.0/24",
            "8.36.218.0/24", "8.36.219.0/24", "8.36.220.0/24", "8.37.41.0/24", "8.37.43.0/24",
            "8.38.147.0/24", "8.38.148.0/24", "8.38.149.0/24", "8.38.172.0/24", "8.39.6.0/24",
            "8.39.18.0/24", "8.39.125.0/24", "8.39.126.0/24", "8.39.201.0/24", "8.39.202.0/24",
            "8.39.203.0/24", "8.39.204.0/24", "8.39.205.0/24", "8.39.206.0/24", "8.39.207.0/24",
            "8.39.212.0/24", "8.39.213.0/24", "8.39.214.0/24", "8.39.215.0/24", "8.40.26.0/24",
            "8.40.27.0/24", "8.40.28.0/24", "8.40.29.0/24", "8.40.30.0/24", "8.40.31.0/24",
            "8.40.107.0/24", "8.40.111.0/24", "8.40.140.0/24", "8.41.5.0/24", "8.41.6.0/24",
            "8.41.7.0/24", "8.41.36.0/24", "8.41.37.0/24", "8.42.51.0/24", "8.42.52.0/24",
            "8.42.54.0/24", "8.42.55.0/24", "8.42.161.0/24", "8.42.164.0/24", "8.42.172.0/24",
            "8.42.245.0/24", "8.43.121.0/24", "8.43.122.0/24", "8.43.123.0/24", "8.43.224.0/24",
            "8.43.225.0/24", "8.43.226.0/24", "8.44.0.0/24", "8.44.1.0/24", "8.44.2.0/24", "8.44.3.0/24",
            "8.44.6.0/24", "8.44.58.0/24", "8.44.60.0/24", "8.44.61.0/24", "8.44.62.0/24", "8.44.63.0/24",
            "8.45.41.0/24", "8.45.43.0/24", "8.45.44.0/24", "8.45.45.0/24", "8.45.46.0/24", "8.45.47.0/24",
            "8.45.97.0/24", "8.45.101.0/24", "8.45.102.0/24", "8.45.108.0/24", "8.45.111.0/24",
            "8.45.144.0/24", "8.45.145.0/24", "8.45.146.0/24", "8.45.147.0/24", "8.46.113.0/24",
            "8.46.114.0/24", "8.46.115.0/24", "8.46.117.0/24", "8.46.118.0/24", "8.46.119.0/24",
            "8.47.9.0/24", "8.47.12.0/24", "8.47.13.0/24", "8.47.14.0/24", "8.47.15.0/24", "8.47.69.0/24",
            "8.47.71.0/24", "8.48.130.0/24", "8.48.132.0/24", "8.48.133.0/24", "8.48.134.0/24",
            "64.68.192.0/24", "65.110.63.0/24", "66.235.200.0/24", "68.67.65.0/24"
          ],
          ipv6: [
            "2a09:bac5:638a:1246::/64",
            "2606:4700:10::/48", "2606:4700:11::/48", "2606:4700:12::/48", "2606:4700:13::/48",
            "2606:4700:14::/48", "2606:4700:15::/48", "2606:4700:16::/48", "2606:4700:17::/48",
            "2606:4700:18::/48", "2606:4700:19::/48", "2606:4700:1a::/48", "2606:4700:1b::/48",
            "2606:4700:1c::/48", "2606:4700:1d::/48", "2606:4700:1e::/48", "2606:4700:1f::/48"
          ]
        },
        "🇪🇺 欧洲 (EU)": {
          ipv4: [
            "91.234.214.0/24", "185.146.172.0/24", "185.146.173.0/24", "188.114.96.0/24",
            "188.114.97.0/24", "188.114.98.0/24", "188.114.99.0/24", "188.114.100.0/24",
            "188.114.102.0/24", "188.114.103.0/24", "188.114.106.0/24", "188.114.107.0/24",
            "188.114.108.0/24", "188.114.111.0/24"
          ],
          ipv6: [
            "2a06:98c1:3100::/48", "2a06:98c1:3101::/48", "2a06:98c1:3102::/48", "2a06:98c1:3103::/48",
            "2a06:98c1:3104::/48", "2a06:98c1:3105::/48", "2a06:98c1:3106::/48", "2a06:98c1:3107::/48",
            "2a06:98c1:3108::/48", "2a06:98c1:3109::/48", "2a06:98c1:310a::/48", "2a06:98c1:310b::/48",
            "2a06:98c1:310c::/48", "2a06:98c1:310d::/48", "2a06:98c1:310e::/48", "2a06:98c1:310f::/48",
            "2a06:98c1:3120::/48", "2a06:98c1:3121::/48", "2a06:98c1:3122::/48", "2a06:98c1:3123::/48",
            "2a06:98c1:50::/48", "2a06:98c1:51::/48", "2a06:98c1:52::/48", "2a06:98c1:53::/48",
            "2a06:98c1:56::/48", "2a06:98c1:58::/48"
          ]
        },
        "🇭🇰 香港 (HK)": {
          ipv4: [
            "103.21.244.0/22", "103.22.200.0/22", "103.31.4.0/22", "162.158.0.0/15", 
            "103.22.203.0/24", "162.158.176.0/24"
          ],
          ipv6: [
            "2400:cb00:2048::/48", "2400:cb00:2049::/48", "2400:cb00:445::/48", "2400:cb00:497::/48",
            "2400:cb00:618::/48", "2400:cb00:bbd0::/48", "2400:cb00:bbd1::/48", "2400:cb00:bbd2::/48",
            "2400:cb00:bbd3::/48", "2400:cb00:bbd4::/48", "2400:cb00:bbd5::/48", "2400:cb00:bbd6::/48",
            "2400:cb00:bbd7::/48", "2400:cb00:bbd8::/48", "2400:cb00:bbd9::/48", "2400:cb00:bbda::/48",
            "2400:cb00:bbdb::/48", "2400:cb00:bbdc::/48", "2400:cb00:bbdd::/48", "2400:cb00:bbde::/48",
            "2400:cb00:bbdf::/48", "2400:cb00:f00e::/48"
          ]
        },
        "🇨🇳 中国 (CN)": {
          ipv4: [
            "103.21.244.0/8"
          ],
          ipv6: [
            "2400:cb00:2048::/48", "2400:cb00:2049::/48", "2400:cb00:445::/48", "2400:cb00:497::/48",
            "2400:cb00:618::/48", "2400:cb00:bbd0::/48", "2400:cb00:bbd1::/48", "2400:cb00:bbd2::/48",
            "2400:cb00:bbd3::/48", "2400:cb00:bbd4::/48", "2400:cb00:bbd5::/48", "2400:cb00:bbd6::/48",
            "2400:cb00:bbd7::/48", "2400:cb00:bbd8::/48", "2400:cb00:bbd9::/48", "2400:cb00:bbda::/48",
            "2400:cb00:bbdb::/48", "2400:cb00:bbdc::/48", "2400:cb00:bbdd::/48", "2400:cb00:bbde::/48",
            "2400:cb00:bbdf::/48", "2400:cb00:f00e::/48","2a09:bac1:19c0:10::/64",
          ]
        },
        "🌏 亚洲 (Asia)": {
          ipv4: [
            "103.21.244.0/24", "103.22.200.0/24", "103.22.201.0/24", "103.22.202.0/24",
            "103.22.203.0/24", "103.81.228.0/24"
          ],
          ipv6: [
            "2400:cb00:2048::/48", "2400:cb00:2049::/48", "2400:cb00:445::/48", "2400:cb00:497::/48",
            "2400:cb00:618::/48", "2400:cb00:bbd0::/48", "2400:cb00:bbd1::/48", "2400:cb00:bbd2::/48",
            "2400:cb00:bbd3::/48", "2400:cb00:bbd4::/48", "2400:cb00:bbd5::/48", "2400:cb00:bbd6::/48",
            "2400:cb00:bbd7::/48", "2400:cb00:bbd8::/48", "2400:cb00:bbd9::/48", "2400:cb00:bbda::/48",
            "2400:cb00:bbdb::/48", "2400:cb00:bbdc::/48", "2400:cb00:bbdd::/48", "2400:cb00:bbde::/48",
            "2400:cb00:bbdf::/48", "2400:cb00:f00e::/48"
          ]
        },
        "🌐 全球通用 (Global Anycast)": {
            ipv4: [
                "1.0.0.0/24", "1.1.1.0/24", "104.16.0.0/16", "104.17.0.0/16", "104.18.0.0/16",
                "104.19.0.0/16", "104.20.0.0/16", "104.21.0.0/16", "104.22.0.0/16", "104.23.0.0/16",
                "104.24.0.0/16", "104.25.0.0/16", "104.26.0.0/16", "104.27.0.0/16", "104.28.0.0/16",
                "104.29.0.0/16", "104.30.0.0/16", "104.31.0.0/16", "108.162.192.0/18", "141.101.64.0/18",
                "162.158.0.0/15", "172.64.0.0/13", "173.245.48.0/20", "190.93.240.0/20", "197.234.240.0/22",
                "198.41.128.0/17"
            ],
            ipv6: [
                "2606:4700::/32", "2803:f800::/32"
            ]
        },
        "✨ 优选域名 (Domains)": {
          domains: [
            "usa.visa.com", "myanmar.visa.com", "www.visa.com.tw", "www.visaeurope.ch",
            "www.visa.com.br", "www.visasoutheasteurope.com", "www.baikehotel.com"
          ]
        }
      };

      // 端口配置
      const portConfig = {
        https: [2053, 2083, 2087, 2096, 8443, 443],
        http: [2052, 2082, 2086, 2095, 80, 8080, 8880]
      };

      // 导出数据供其他文件使用
      if (typeof module !== 'undefined' && module.exports) {
        module.exports = { dataByCountry, portConfig };
      } else {
        window.dataByCountry = dataByCountry;
        window.portConfig = portConfig;
      }
    </script>
    <script>
      // =================================================================
      // 全局变量和状态管理
      // =================================================================
      let currentUser = null;
      let authModal, createTagModal, addSourceModal;
      let isLoginMode = true;
      let allTags = [];
      let allNodes = [];
      let filteredNodes = [];
      let currentPage = 1;
      const nodesPerPage = 20;

      // =================================================================
      // 核心API请求函数
      // =================================================================
      async function apiRequest(url, method, data = null) {
        const options = {
          method: method,
          headers: { "Content-Type": "application/json" },
        };
        if (data) options.body = JSON.stringify(data);

        try {
          const response = await fetch(url, options);
          const result = await response.json();
          return { ok: response.ok, data: result, status: response.status };
        } catch (error) {
          console.error("API请求失败:", error);
          return { ok: false, data: { error: error.message }, status: 500 };
        }
      }

      // =================================================================
      // 源节点管理相关函数
      // =================================================================

      // UUID生成函数
      function generateUUID(inputId) {
        const uuid = crypto.randomUUID();
        document.getElementById(inputId).value = uuid;
      }

      // NAT64源节点生成（已移除）

      // ProxyIP源节点生成并保存（简化流程）
      async function generateAndSaveProxyIPNode() {
        const configName =
          document.getElementById("proxyip-name").value || "ProxyIP配置";
        const config = {
          uuid: document.getElementById("proxyip-uuid").value,
          proxyIP: document.getElementById("proxyip-address").value,
          proxyPort: document.getElementById("proxyip-port").value,
        };

        // 自动生成UUID（如果没有）
        if (!config.uuid) {
          generateUUID("proxyip-uuid");
          config.uuid = document.getElementById("proxyip-uuid").value;
        }

        // 验证必填字段
        if (!config.proxyIP) {
          showAlert("请输入代理IP地址", "danger");
          return;
        }

        try {
          // 直接保存配置（域名由后端自动获取）
          const result = await apiRequest("/api/source-nodes", "POST", {
            config_name: configName,
            node_type: "proxyip",
            config_data: config,
          });

          if (result.ok) {
            showAlert("ProxyIP源节点配置成功并已添加到节点池！", "success");
            refreshSourceNodes();
            // 清空表单
            document.getElementById("proxyip-form").reset();
            // 隐藏结果区域（如果存在）
            const resultArea = document.getElementById("proxyip-result-area");
            if (resultArea) {
              resultArea.style.display = "none";
            }
          } else {
            showAlert(`配置失败: ${result.data.error}`, "danger");
          }
        } catch (error) {
          showAlert(`配置失败: ${error.message}`, "danger");
        }
      }

      // 保存NAT64配置（已移除）

      // 保存ProxyIP配置（已合并到generateAndSaveProxyIPNode函数中）

      // ProxyIP选择器相关函数
      function openProxyIPSelector() {
        const modal = new bootstrap.Modal(
          document.getElementById("proxyIPSelectorModal")
        );
        modal.show();
      }

      function openProxyIPTestPage() {
        // 打开itdog.cn的测试页面
        window.open(
          "https://www.itdog.cn/tcping/bpb.yousef.isegaro.com:443",
          "_blank"
        );

        // 显示提示信息
        showAlert("测试页面已在新窗口打开，请按照说明操作", "info");

        // 关闭弹窗
        const modal = bootstrap.Modal.getInstance(
          document.getElementById("proxyIPSelectorModal")
        );
        if (modal) {
          modal.hide();
        }
      }

      // 加载源节点配置
      async function loadSourceNodes() {
        try {
          const result = await apiRequest("/api/source-nodes", "GET");
          if (result.ok) {
            displaySourceNodes(result.data);
          } else {
            console.error("加载源节点配置失败:", result.data.error);
            document.getElementById("default-source-nodes").innerHTML =
              '<div class="text-center p-3 text-danger">加载失败，请刷新重试</div>';
            document.getElementById("custom-source-nodes").innerHTML =
              '<div class="text-center p-3 text-danger">加载失败，请刷新重试</div>';
          }
        } catch (error) {
          console.error("加载源节点配置失败:", error);
        }
      }

      // 显示源节点配置
      function displaySourceNodes(configs) {
        // 过滤掉NAT64节点，只显示ProxyIP节点
        const proxyipConfigs = configs.filter(
          (config) => config.node_type === "proxyip"
        );
        const defaultNodes = proxyipConfigs.filter(
          (config) => config.is_default
        );
        const customNodes = proxyipConfigs.filter(
          (config) => !config.is_default
        );

        // 显示默认源节点
        displayDefaultNodes(defaultNodes);

        // 显示自定义源节点
        displayCustomNodes(customNodes);
      }

      // 显示默认源节点
      function displayDefaultNodes(defaultNodes) {
        const container = document.getElementById("default-source-nodes");

        if (defaultNodes.length === 0) {
          container.innerHTML = `
                    <div class="alert alert-info">
                        <h6>🌍 还没有系统默认源节点</h6>
                        <p class="mb-0">系统会在用户注册时自动创建默认源节点。如果您是老用户，请联系管理员。</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = defaultNodes
          .map((node) => {
            const configData = JSON.parse(node.config_data);
            const nodeType = node.node_type.toUpperCase();
            const badgeClass = "bg-success";

            return `
                    <div class="card mb-2">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="card-title">
                                        ${node.config_name} 
                                        <span class="badge ${badgeClass}">${nodeType}</span>
                                        <span class="badge bg-info">系统默认</span>
                                    </h6>
                                    <small class="text-muted">域名: ${configData.domain}</small>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="copyToClipboard('default-node-${node.id}')">📋</button>
                                    <button class="btn btn-outline-success" onclick="importToTag(${node.id}, '${node.config_name}')">🏷️ 导入到Tag</button>
                                </div>
                            </div>
                            <div class="mt-2">
                                <textarea class="form-control" id="default-node-${node.id}" rows="2" readonly>${node.generated_node}</textarea>
                            </div>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      // 显示自定义源节点
      function displayCustomNodes(customNodes) {
        const container = document.getElementById("custom-source-nodes");

        if (customNodes.length === 0) {
          container.innerHTML = `
                    <div class="text-center p-3 text-muted">
                        <p>还没有自定义源节点配置</p>
                        <p>使用上方的源节点配置器创建您的第一个源节点配置吧！</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = customNodes
          .map((node) => {
            const configData = JSON.parse(node.config_data);
            const nodeType = node.node_type.toUpperCase();
            const badgeClass = "bg-success";
            const statusBadge = node.enabled
              ? '<span class="badge bg-success">启用</span>'
              : '<span class="badge bg-secondary">禁用</span>';

            return `
                    <div class="card mb-2">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="card-title">
                                        ${node.config_name} 
                                        <span class="badge ${badgeClass}">${nodeType}</span>
                                        ${statusBadge}
                                    </h6>
                                    <small class="text-muted">
                                        域名: ${configData.domain} | 
                                        创建时间: ${new Date(
                                          node.created_at
                                        ).toLocaleString()}
                                    </small>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="copyToClipboard('custom-node-${
                                      node.id
                                    }')">📋</button>
                                    <button class="btn btn-outline-success" onclick="importToTag(${
                                      node.id
                                    }, '${
              node.config_name
            }')">🏷️ 导入到Tag</button>
                                    <button class="btn btn-outline-danger" onclick="deleteSourceNode(${
                                      node.id
                                    }, '${node.config_name}')">🗑️</button>
                                </div>
                            </div>
                            <div class="mt-2">
                                <textarea class="form-control" id="custom-node-${
                                  node.id
                                }" rows="2" readonly>${
              node.generated_node
            }</textarea>
                            </div>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      // 导入到Tag相关函数
      let currentImportNodeId = null;
      let currentImportNodeName = null;

      function importToTag(nodeId, nodeName) {
        currentImportNodeId = nodeId;
        currentImportNodeName = nodeName;

        // 加载用户的所有Tag
        loadTagsForImport();

        // 显示模态框
        const modal = new bootstrap.Modal(
          document.getElementById("importToTagModal")
        );
        modal.show();
      }

      async function loadTagsForImport() {
        try {
          const result = await apiRequest("/api/tags", "GET");
          if (result.ok && Array.isArray(result.data)) {
            const select = document.getElementById("importTagSelect");
            // 保留默认选项
            select.innerHTML =
              '<option value="">默认导入到"源节点"Tag</option>';

            // 添加用户的所有Tag
            result.data.forEach((tag) => {
              const option = document.createElement("option");
              option.value = tag.id;
              option.textContent = `🏷️ ${tag.tag_name}`;
              select.appendChild(option);
            });
          }
        } catch (error) {
          console.error("加载Tag失败:", error);
        }
      }

      async function confirmImportToTag() {
        if (!currentImportNodeId) {
          showAlert(
            "导入失败：节点ID无效",
            "danger",
            document.getElementById("import-tag-alert")
          );
          return;
        }

        const tagId = document.getElementById("importTagSelect").value;

        try {
          const result = await apiRequest(
            `/api/source-nodes/${currentImportNodeId}/import-to-tag`,
            "POST",
            {
              tag_id: tagId || null,
            }
          );

          if (result.ok) {
            showAlert(
              `源节点"${currentImportNodeName}"已成功导入到Tag！`,
              "success",
              document.getElementById("import-tag-alert")
            );

            // 关闭模态框
            setTimeout(() => {
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("importToTagModal")
              );
              if (modal) {
                modal.hide();
              }
              // 刷新Tag列表
              loadTags();
            }, 1500);
          } else {
            showAlert(
              `导入失败: ${result.data.error}`,
              "danger",
              document.getElementById("import-tag-alert")
            );
          }
        } catch (error) {
          showAlert(
            `导入失败: ${error.message}`,
            "danger",
            document.getElementById("import-tag-alert")
          );
        }
      }

      // 导入到生成器（已简化，仅支持ProxyIP）
      function importToGenerator(nodeUrl, nodeType) {
        // 解析节点URL获取配置信息
        try {
          const url = new URL(nodeUrl);
          const uuid = url.username;
          const domain = url.hostname;

          if (nodeType === "proxyip") {
            document.getElementById("proxyip-uuid").value = uuid;
            // 切换到源节点管理标签页
            document.getElementById("source-nodes-tab").click();
            showAlert("已导入到源节点生成器", "success");
          }
        } catch (error) {
          showAlert("导入失败：节点格式无效", "danger");
        }
      }

      // 删除源节点配置
      async function deleteSourceNode(nodeId, nodeName) {
        if (!confirm(`确定要删除源节点配置 "${nodeName}" 吗？`)) {
          return;
        }

        try {
          const result = await apiRequest(
            `/api/source-nodes/${nodeId}`,
            "DELETE"
          );
          if (result.ok) {
            showAlert("源节点配置删除成功！", "success");
            refreshSourceNodes();
          } else {
            showAlert(`删除失败: ${result.data.error}`, "danger");
          }
        } catch (error) {
          showAlert(`删除失败: ${error.message}`, "danger");
        }
      }

      // 刷新源节点配置
      async function refreshSourceNodes() {
        await loadSourceNodes();
      }

      // 复制到剪贴板函数
      function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        if (element) {
          element.select();
          document.execCommand("copy");
          showAlert("已复制到剪贴板！", "success");
        }
      }

      // =================================================================
      // 用户认证相关函数
      // =================================================================
      async function checkLoginStatus() {
        console.log("检查登录状态...");
        const result = await apiRequest("/api/status", "GET");
        if (result.ok && result.data.authenticated) {
          currentUser = result.data;
          console.log("用户已登录:", currentUser.username);
        } else {
          currentUser = null;
          console.log("用户未登录");
        }
        updateUI();
      }

      function updateUI() {
        const userStatusArea = document.getElementById("user-status-area");
        const mainContent = document.getElementById("main-content");
        const loginPrompt = document.getElementById("login-prompt");

        if (currentUser) {
          if (mainContent) mainContent.style.display = "block";
          if (loginPrompt) loginPrompt.style.display = "none";
          if (userStatusArea) {
            userStatusArea.innerHTML = `
                        <span class="navbar-text me-3">欢迎, <strong>${currentUser.username}</strong></span>
                        <button class="btn btn-outline-light" onclick="logout()">登出</button>
                    `;
          }
          // 自动设置当前域名（已移除NAT64相关设置）

          // 加载数据
          loadTags();
          loadSubscriptionSources();
          loadSourceNodes(); // 加载源节点配置
          loadNodePool(); // 加载节点池
        } else {
          if (mainContent) mainContent.style.display = "none";
          if (loginPrompt) loginPrompt.style.display = "block";
          if (userStatusArea) {
            userStatusArea.innerHTML = `<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#authModal">登录 / 注册</button>`;
          }
        }
      }

      function switchAuthMode() {
        isLoginMode = !isLoginMode;
        const modalTitle = document.getElementById("authModalLabel");
        const submitButton = document.querySelector("#authModal .btn-primary");
        const switchButton = document.querySelector(
          "#authModal .btn-secondary"
        );

        if (isLoginMode) {
          modalTitle.textContent = "用户登录";
          submitButton.textContent = "登录";
          switchButton.textContent = "切换到注册";
        } else {
          modalTitle.textContent = "用户注册";
          submitButton.textContent = "注册";
          switchButton.textContent = "切换到登录";
        }
      }

      async function performAuth() {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value;
        const alertElement = document.getElementById("auth-alert");

        if (!username || !password) {
          showAlert("用户名和密码不能为空", "danger", alertElement);
          return;
        }

        const endpoint = isLoginMode ? "/api/login" : "/api/register";
        const result = await apiRequest(endpoint, "POST", {
          username,
          password,
        });

        if (result.ok) {
          showAlert(result.data.message, "success", alertElement);
          document.getElementById("username").value = "";
          document.getElementById("password").value = "";

          if (isLoginMode) {
            setTimeout(() => {
              authModal.hide();
              checkLoginStatus();
            }, 1000);
          }
        } else {
          showAlert(result.data.error, "danger", alertElement);
        }
      }

      async function logout() {
        await apiRequest("/api/logout", "POST");
        currentUser = null;
        updateUI();
      }

      function showAlert(message, type, element = null) {
        const alertElement = element || document.getElementById("global-alert");
        if (!alertElement) {
          console.error("Alert element not found");
          return;
        }
        alertElement.className = `alert alert-${type}`;
        alertElement.textContent = message;
        alertElement.style.display = "block";
        setTimeout(() => {
          alertElement.style.display = "none";
        }, 5000);
      }

      // =================================================================
      // Tag管理相关函数
      // =================================================================
      async function loadTags() {
        const listElement = document.getElementById("tags-list");
        if (!listElement) return;

        listElement.innerHTML =
          '<div class="text-center p-3 text-muted">正在加载Tag...</div>';

        const result = await apiRequest("/api/tags", "GET");

        if (result.ok && Array.isArray(result.data)) {
          allTags = result.data;

          // Tag选择器已集成到卡片中，无需单独渲染

          if (allTags.length === 0) {
            listElement.innerHTML =
              '<div class="text-center p-3 text-muted">您还没有创建任何Tag。点击上方按钮创建第一个Tag。</div>';
            return;
          }

          // 将tags分成四列显示，更紧凑的布局
          const tagsHTML = allTags
            .map(
              (tag) => `
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center mb-2">
                                    <input class="form-check-input me-2" type="checkbox" id="tag-select-${
                                      tag.id
                                    }" value="${tag.id}">
                                    <h6 class="card-title mb-0 text-truncate">
                                        🏷️ ${escapeHTML(tag.tag_name)}
                                    </h6>
                                </div>
                                <div class="mb-2">
                                    <span class="badge bg-info me-1">${
                                      tag.node_count || 0
                                    }个节点</span>
                                    ${
                                      tag.active_count > 0
                                        ? `<span class="badge bg-success">${tag.active_count}可用</span>`
                                        : ""
                                    }
                                </div>
                                ${
                                  tag.description
                                    ? `<p class="card-text text-muted small mb-2 text-truncate">${escapeHTML(
                                        tag.description
                                      )}</p>`
                                    : ""
                                }
                                <div class="d-grid gap-1">
                                    <button class="btn btn-outline-primary btn-sm" onclick="copyTagSubscription('${
                                      tag.tag_uuid
                                    }', 'v2ray')">
                                        📋 V2Ray订阅
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="copyTagSubscription('${
                                      tag.tag_uuid
                                    }', 'clash')">
                                        📋 Clash订阅
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            )
            .join("");

          listElement.innerHTML = `
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="selectAllTagsInCards(true)">全选Tag</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="selectAllTagsInCards(false)">取消全选</button>
                        <button type="button" class="btn btn-sm btn-danger" onclick="deleteSelectedTags()">🗑️ 删除选中Tag</button>
                    </div>
                    <div class="row">${tagsHTML}</div>
                `;

          updateTagDropdown();
        } else {
          listElement.innerHTML =
            '<div class="text-center p-3 text-danger">加载Tag失败。</div>';
        }
      }

      async function createNewTag() {
        const tagName = document.getElementById("tagName").value.trim();
        const tagDescription = document
          .getElementById("tagDescription")
          .value.trim();
        const alertElement = document.getElementById("create-tag-alert");

        if (!tagName) {
          showAlert("Tag名称不能为空", "danger", alertElement);
          return;
        }

        const result = await apiRequest("/api/tags", "POST", {
          tag_name: tagName,
          description: tagDescription,
        });

        if (result.ok) {
          showAlert(result.data.message, "success", alertElement);
          document.getElementById("tagName").value = "";
          document.getElementById("tagDescription").value = "";
          setTimeout(() => {
            createTagModal.hide();
            loadTags();
          }, 1500);
        } else {
          showAlert(`创建失败: ${result.data.error}`, "danger", alertElement);
        }
      }

      function updateTagDropdown() {
        const dropdown = document.getElementById("existing-tag-select");
        if (!dropdown) return;

        dropdown.innerHTML = '<option value="">-- 选择一个已有Tag --</option>';
        allTags.forEach((tag) => {
          const option = document.createElement("option");
          option.value = tag.tag_name;
          option.textContent = `${tag.tag_name} (${tag.node_count || 0}个节点)`;
          dropdown.appendChild(option);
        });
      }

      function copyTagSubscription(tagUuid, format) {
        const baseUrl = `${window.location.origin}/sub/tag/${tagUuid}`;
        const url = format === "clash" ? `${baseUrl}?type=clash` : baseUrl;

        const button = event.target;
        const originalText = button.textContent;

        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard
            .writeText(url)
            .then(() => {
              button.textContent = "✅ 已复制";
              button.classList.add("btn-success");
              button.classList.remove(
                "btn-outline-primary",
                "btn-outline-secondary"
              );
              setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove("btn-success");
                button.classList.add(
                  format === "clash"
                    ? "btn-outline-secondary"
                    : "btn-outline-primary"
                );
              }, 2000);
            })
            .catch(() => {
              fallbackCopyTextToClipboard(url, button, originalText);
            });
        } else {
          fallbackCopyTextToClipboard(url, button, originalText);
        }
      }

      async function deleteTag(tagId) {
        if (!confirm("确定要删除这个Tag吗？这将同时删除Tag与节点的关联关系。"))
          return;
        alert("删除功能将在下个版本实现");
      }

      function escapeHTML(str) {
        if (!str) return "";
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // =================================================================
      // 节点生成器相关函数
      // =================================================================

      // 全局变量存储Tag节点数据
      let allTagNodes = [];

      // 加载Tag节点数据到生成器
      async function loadTagNodesForGenerator() {
        try {
          // 获取所有Tag的节点数据
          const tagNodes = [];

          // 遍历所有Tag，获取每个Tag的节点
          for (const tag of allTags) {
            try {
              const result = await apiRequest(
                `/api/tags/${tag.id}/nodes`,
                "GET"
              );
              if (
                result.ok &&
                result.data.nodes &&
                result.data.nodes.length > 0
              ) {
                result.data.nodes.forEach((node) => {
                  tagNodes.push({
                    tagName: tag.tag_name,
                    nodeUrl: node.node_url,
                    nodeName: extractNodeName(node.node_url),
                    nodeId: node.id,
                  });
                });
              }
            } catch (error) {
              console.error(`获取Tag ${tag.tag_name} 的节点失败:`, error);
            }
          }

          allTagNodes = tagNodes;
          populateTemplateNodeDropdown();
        } catch (error) {
          console.error("加载Tag节点失败:", error);
          showAlert("加载Tag节点失败，请检查网络连接", "danger");
        }
      }

      // 填充模板节点下拉选择
      function populateTemplateNodeDropdown() {
        const select = document.getElementById("templateNodeSelect");
        select.innerHTML = '<option value="">请选择模板节点...</option>';

        if (allTagNodes.length === 0) {
          select.innerHTML =
            '<option value="">暂无可用节点，请先在Tag管理中添加节点</option>';
          return;
        }

        // 按Tag分组显示节点
        const nodesByTag = {};
        allTagNodes.forEach((node) => {
          if (!nodesByTag[node.tagName]) {
            nodesByTag[node.tagName] = [];
          }
          nodesByTag[node.tagName].push(node);
        });

        // 为每个Tag创建optgroup
        Object.keys(nodesByTag).forEach((tagName) => {
          const optgroup = document.createElement("optgroup");
          optgroup.label = `🏷️ ${tagName}`;

          nodesByTag[tagName].forEach((node) => {
            const option = document.createElement("option");
            option.value = node.nodeUrl;
            option.textContent = node.nodeName || "未命名节点";
            option.dataset.tagName = node.tagName;
            optgroup.appendChild(option);
          });

          select.appendChild(optgroup);
        });
      }

      // 模板节点选择事件
      function onTemplateNodeSelect() {
        const select = document.getElementById("templateNodeSelect");
        const selectedValue = select.value;

        if (selectedValue) {
          // 清空手动粘贴框
          document.getElementById("templateUrl").value = "";
          // 根据选择的模板节点自动选择输出格式
          autoSelectOutputFormat(selectedValue);
        }

        updateEstimation();
      }

      // 手动粘贴节点输入事件
      function onTemplateUrlInput() {
        const templateUrl = document.getElementById("templateUrl").value.trim();
        if (templateUrl) {
          // 清除下拉选择
          document.getElementById("templateNodeSelect").value = "";
          // 根据粘贴的节点URL自动选择输出格式
          autoSelectOutputFormat(templateUrl);
        }
        updateEstimation();
      }

      // 获取当前选中的模板节点URL
      function getCurrentSourceNodeUrl() {
        // 优先从下拉选择获取
        const selectedFromDropdown =
          document.getElementById("templateNodeSelect").value;
        if (selectedFromDropdown) {
          return selectedFromDropdown;
        }

        // 其次从手动粘贴获取
        const templateUrl = document.getElementById("templateUrl").value.trim();
        return templateUrl;
      }

      // 根据节点URL自动选择输出格式
      function autoSelectOutputFormat(nodeUrl) {
        if (!nodeUrl) return;

        const vlessRadio = document.getElementById("formatVless");
        const vmessJsonRadio = document.getElementById("formatVmessJson");
        const vmessQueryRadio = document.getElementById("formatVmessQuery");

        if (nodeUrl.startsWith("vless://")) {
          vlessRadio.checked = true;
          vmessJsonRadio.disabled = true;
          vmessQueryRadio.disabled = true;
        } else if (nodeUrl.startsWith("vmess://")) {
          vlessRadio.disabled = true;
          vmessJsonRadio.disabled = false;
          vmessQueryRadio.disabled = false;
          // 如果当前没有选中的格式，默认选择JSON格式
          if (!document.querySelector('input[name="outputFormat"]:checked')) {
            vmessJsonRadio.checked = true;
          }
        } else {
          // 重新启用所有选项
          vlessRadio.disabled = false;
          vmessJsonRadio.disabled = false;
          vmessQueryRadio.disabled = false;
        }
      }

      // 提取节点名称
      function extractNodeName(nodeUrl) {
        try {
          if (nodeUrl.startsWith("vless://")) {
            const url = new URL(nodeUrl);
            return url.hash
              ? decodeURIComponent(url.hash.substring(1))
              : `${url.hostname}:${url.port}`;
          } else if (nodeUrl.startsWith("vmess://")) {
            const data = nodeUrl.substring("vmess://".length);
            const decoded = safeBase64Decode(data);
            const config = JSON.parse(decoded);
            return config.ps || `${config.add}:${config.port}`;
          }
        } catch (error) {
          console.error("提取节点名称失败:", error);
        }
        return "未知节点";
      }

      function generateNodes() {
        // 获取源节点URL
        const templateLink = getCurrentSourceNodeUrl();

        if (!templateLink) {
          showAlert("请先选择或粘贴源节点！", "warning");
          return;
        }

        // 获取数据源
        const builtinTab = document.getElementById("builtin-tab");
        const isBuiltinActive = builtinTab.classList.contains("active");

        let addresses = [];

        if (isBuiltinActive) {
          // 内置数据源
          addresses = getBuiltinAddresses();
        } else {
          // 自定义数据源
          addresses = getCustomAddresses();
        }

        if (addresses.length === 0) {
          showAlert("没有找到有效的地址数据！", "warning");
          return;
        }

        // 获取输出格式
        const outputFormat = document.querySelector(
          'input[name="outputFormat"]:checked'
        ).value;

        const results = [];
        addresses.forEach((address) => {
          const generatedNode = generateSingleNode(
            templateLink,
            address.trim(),
            outputFormat
          );
          if (generatedNode) {
            results.push(generatedNode);
          }
        });

        document.getElementById("output").value = results.join("\n");

        if (results.length > 0) {
          showAlert(`成功生成 ${results.length} 个节点！`, "success");
        } else {
          showAlert("生成失败，请检查源节点格式！", "danger");
        }
      }

      // 获取内置地址数据
      function getBuiltinAddresses() {
        const addresses = [];

        // 获取IP版本选择
        const useIPv4 = document.getElementById("useIPv4").checked;
        const useIPv6 = document.getElementById("useIPv6").checked;

        if (!useIPv4 && !useIPv6) {
          showAlert("请至少选择一种IP版本！", "warning");
          return addresses;
        }

        // 获取选中的地区
        const selectedRegions = [];
        document
          .querySelectorAll('#region-selector input[type="checkbox"]:checked')
          .forEach((checkbox) => {
            selectedRegions.push(checkbox.value);
          });

        if (selectedRegions.length === 0) {
          showAlert("请至少选择一个地区！", "warning");
          return addresses;
        }

        // 获取选中的端口
        const selectedPorts = [];
        document
          .querySelectorAll(
            '#builtin-https-port-selector input[type="checkbox"]:checked'
          )
          .forEach((checkbox) => {
            selectedPorts.push(checkbox.value);
          });

        if (selectedPorts.length === 0) {
          showAlert("请至少选择一个端口！", "warning");
          return addresses;
        }

        // 从内置数据中获取地址
        if (window.builtInData) {
          selectedRegions.forEach((region) => {
            if (window.builtInData[region]) {
              window.builtInData[region].forEach((ipData) => {
                if (useIPv4 && ipData.ipv4) {
                  selectedPorts.forEach((port) => {
                    addresses.push(`${ipData.ipv4}:${port}`);
                  });
                }
                if (useIPv6 && ipData.ipv6) {
                  selectedPorts.forEach((port) => {
                    addresses.push(`[${ipData.ipv6}]:${port}`);
                  });
                }
              });
            }
          });
        }

        return addresses;
      }

      // 获取自定义地址数据
      function getCustomAddresses() {
        const customText = document.getElementById("customData").value.trim();
        if (!customText) {
          showAlert("请输入自定义地址！", "warning");
          return [];
        }

        const addresses = [];
        const lines = customText.split("\n").filter((line) => line.trim());

        // 获取选中的端口
        const selectedPorts = [];
        document
          .querySelectorAll(
            '#https-port-selector input[type="checkbox"]:checked'
          )
          .forEach((checkbox) => {
            selectedPorts.push(checkbox.value);
          });

        if (selectedPorts.length === 0) {
          // 如果没有选择端口，直接使用地址
          return lines;
        }

        // 为每个地址添加端口
        lines.forEach((line) => {
          const trimmedLine = line.trim();
          if (trimmedLine) {
            selectedPorts.forEach((port) => {
              if (trimmedLine.includes(":")) {
                // 如果地址已经包含端口，直接使用
                addresses.push(trimmedLine);
              } else {
                // 如果地址不包含端口，添加端口
                addresses.push(`${trimmedLine}:${port}`);
              }
            });
          }
        });

        return addresses;
      }

      function generateSingleNode(
        template,
        newAddress,
        outputFormat = "vmess_json"
      ) {
        try {
          if (template.startsWith("vless://")) {
            return generateVlessNode(template, newAddress, outputFormat);
          } else if (template.startsWith("vmess://")) {
            return generateVmessNode(template, newAddress, outputFormat);
          }
        } catch (e) {
          console.error("生成节点失败:", e);
        }
        return null;
      }

      // 生成VLESS节点
      function generateVlessNode(template, newAddress, outputFormat) {
        if (outputFormat === "vless") {
          // 保持VLESS格式
          const url = new URL(template);
          const [host, port] = newAddress.split(":");
          url.hostname = host;
          url.port = port || "443";

          if (url.hash) {
            const originalName = decodeURIComponent(url.hash.substring(1));
            const newName = `${originalName}-${host}`;
            url.hash = encodeURIComponent(newName);
          }
          return url.toString();
        } else {
          // 转换为VMess格式
          const url = new URL(template);
          const [host, port] = newAddress.split(":");
          const uuid = url.username;

          const vmessConfig = {
            v: "2",
            ps: `${
              url.hash ? decodeURIComponent(url.hash.substring(1)) : "vless"
            }-${host}`,
            add: host,
            port: port || "443",
            id: uuid,
            aid: "0",
            net: "ws",
            type: "none",
            host: url.hostname,
            path: url.pathname || "/",
            tls: "tls",
            sni: url.hostname,
          };

          if (outputFormat === "vmess_query") {
            // Shadowrocket格式
            return generateVmessQueryString(vmessConfig);
          } else {
            // v2rayN/U格式
            return "vmess://" + safeBase64Encode(JSON.stringify(vmessConfig));
          }
        }
      }

      // 生成VMess节点
      function generateVmessNode(template, newAddress, outputFormat) {
        const data = template.substring("vmess://".length);
        const decoded = safeBase64Decode(data);
        const config = JSON.parse(decoded);

        const [host, port] = newAddress.split(":");
        config.add = host;
        config.port = port || "443";
        config.ps = `${config.ps || "vmess"}-${host}`;

        if (outputFormat === "vless") {
          // 转换为VLESS格式
          return generateVlessFromVmess(config);
        } else if (outputFormat === "vmess_query") {
          // Shadowrocket格式
          return generateVmessQueryString(config);
        } else {
          // v2rayN/U格式
          return "vmess://" + safeBase64Encode(JSON.stringify(config));
        }
      }

      // 从VMess配置生成VLESS链接
      function generateVlessFromVmess(vmessConfig) {
        const url = new URL(
          "vless://" +
            vmessConfig.id +
            "@" +
            vmessConfig.add +
            ":" +
            vmessConfig.port
        );
        url.searchParams.set("type", vmessConfig.net || "ws");
        url.searchParams.set("security", vmessConfig.tls || "tls");

        if (vmessConfig.host) {
          url.searchParams.set("host", vmessConfig.host);
        }
        if (vmessConfig.path) {
          url.searchParams.set("path", vmessConfig.path);
        }
        if (vmessConfig.sni) {
          url.searchParams.set("sni", vmessConfig.sni);
        }

        url.hash = encodeURIComponent(vmessConfig.ps);
        return url.toString();
      }

      // 生成VMess查询字符串格式（Shadowrocket）
      function generateVmessQueryString(config) {
        const params = new URLSearchParams();
        params.set("v", config.v || "2");
        params.set("ps", config.ps);
        params.set("add", config.add);
        params.set("port", config.port);
        params.set("id", config.id);
        params.set("aid", config.aid || "0");
        params.set("net", config.net || "ws");
        params.set("type", config.type || "none");
        params.set("host", config.host || "");
        params.set("path", config.path || "/");
        params.set("tls", config.tls || "tls");
        params.set("sni", config.sni || "");

        return `vmess://${config.id}@${config.add}:${
          config.port
        }?${params.toString()}#${encodeURIComponent(config.ps)}`;
      }

      function copyResults() {
        const output = document.getElementById("output");
        if (!output.value) {
          alert("没有内容可复制！");
          return;
        }

        const button = document.getElementById("copyButton");
        const originalText = button.textContent;

        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard
            .writeText(output.value)
            .then(() => {
              button.textContent = "✅ 已复制";
              button.classList.add("btn-success");
              button.classList.remove("btn-success");
              setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove("btn-success");
                button.classList.add("btn-success");
              }, 2000);
            })
            .catch(() => {
              fallbackCopyTextToClipboard(output.value, button, originalText);
            });
        } else {
          fallbackCopyTextToClipboard(output.value, button, originalText);
        }
      }

      async function saveNodesToTag() {
        const outputText = document.getElementById("output").value;
        if (!outputText) {
          alert("请先生成节点！");
          return;
        }

        const existingTag = document.getElementById(
          "existing-tag-select"
        ).value;
        const newTagName = document
          .getElementById("new-tag-input")
          .value.trim();

        if (!existingTag && !newTagName) {
          alert("请选择一个已有Tag或输入新Tag名称！");
          return;
        }

        const tagName = existingTag || newTagName;
        const nodes = outputText.split("\n").filter(Boolean);

        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = "保存中...";

        try {
          const result = await apiRequest("/api/tags/add-nodes", "POST", {
            tag_name: tagName,
            nodes: nodes,
          });

          const resultDiv = document.getElementById("save-tag-result");
          if (result.ok) {
            resultDiv.className = "alert alert-success";
            resultDiv.textContent = result.data.message;
            resultDiv.style.display = "block";

            document.getElementById("existing-tag-select").value = "";
            document.getElementById("new-tag-input").value = "";

            setTimeout(() => {
              loadTags();
              resultDiv.style.display = "none";
            }, 3000);
          } else {
            resultDiv.className = "alert alert-danger";
            resultDiv.textContent = `保存失败: ${result.data.error}`;
            resultDiv.style.display = "block";
          }
        } catch (error) {
          const resultDiv = document.getElementById("save-tag-result");
          resultDiv.className = "alert alert-danger";
          resultDiv.textContent = `保存失败: ${error.message}`;
          resultDiv.style.display = "block";
        } finally {
          button.disabled = false;
          button.textContent = originalText;
        }
      }

      // Base64编码解码函数
      function safeBase64Encode(str) {
        try {
          return btoa(unescape(encodeURIComponent(str)));
        } catch (e) {
          console.error("Base64 encoding error:", e);
          return null;
        }
      }

      function safeBase64Decode(str) {
        try {
          return decodeURIComponent(
            escape(atob(str.replace(/-/g, "+").replace(/_/g, "/")))
          );
        } catch (e) {
          console.error("Base64 decoding error:", e);
          return null;
        }
      }

      // =================================================================
      // 订阅源管理和其他功能
      // =================================================================
      async function loadSubscriptionSources() {
        const listElement = document.getElementById(
          "subscription-sources-list"
        );
        if (!listElement) return;

        listElement.innerHTML =
          '<div class="text-center p-3 text-muted">正在加载订阅源...</div>';

        const result = await apiRequest("/api/subscription-sources", "GET");

        if (result.ok && Array.isArray(result.data)) {
          if (result.data.length === 0) {
            listElement.innerHTML =
              '<div class="text-center p-3 text-muted">您还没有添加任何订阅源。</div>';
            return;
          }

          listElement.innerHTML = result.data
            .map(
              (source) => `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">${escapeHTML(
                              source.source_name
                            )}</h5>
                            <small>节点数: ${source.node_count || 0}</small>
                        </div>
                        <p class="mb-1 small text-muted text-truncate">${escapeHTML(
                          source.source_url
                        )}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small>状态: <span class="badge bg-${getStatusColor(
                              source.fetch_status
                            )}">${source.fetch_status}</span></small>
                            <div>
                                <button class="btn btn-outline-primary btn-sm" onclick="refreshSource(${
                                  source.id
                                })">🔄</button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteSource(${
                                  source.id
                                })">🗑️</button>
                            </div>
                        </div>
                    </div>
                `
            )
            .join("");
        } else {
          listElement.innerHTML =
            '<div class="text-center p-3 text-danger">加载订阅源失败。</div>';
        }
      }

      async function addSubscriptionSource() {
        const sourceName = document.getElementById("sourceName").value;
        const sourceUrl = document.getElementById("sourceUrl").value;
        const alertElement = document.getElementById("add-source-alert");

        const result = await apiRequest("/api/subscription-sources", "POST", {
          source_name: sourceName,
          source_url: sourceUrl,
        });

        if (result.ok) {
          showAlert(result.data.message, "success", alertElement);
          document.getElementById("sourceName").value = "";
          document.getElementById("sourceUrl").value = "";
          setTimeout(() => {
            addSourceModal.hide();
            loadSubscriptionSources();
          }, 1500);
        } else {
          showAlert(`添加失败: ${result.data.error}`, "danger", alertElement);
        }
      }

      async function refreshSource(id) {
        if (!confirm("确定要立即刷新这个订阅源吗？")) return;
        await apiRequest(`/api/subscription-sources/${id}/refresh`, "POST");
        alert("刷新请求已发送，请稍后查看状态更新。");
        setTimeout(loadSubscriptionSources, 3000);
      }

      async function deleteSource(id) {
        if (!confirm("确定要删除这个订阅源及其所有节点吗？此操作不可撤销。"))
          return;
        await apiRequest(`/api/subscription-sources/${id}`, "DELETE");
        loadSubscriptionSources();
      }

      // 全选/取消全选Tag卡片中的勾选框
      function selectAllTagsInCards(selectAll) {
        const checkboxes = document.querySelectorAll(
          'input[id^="tag-select-"]'
        );
        checkboxes.forEach((checkbox) => {
          checkbox.checked = selectAll;
        });
      }

      // 获取选中的Tag IDs（从卡片中的勾选框）
      function getSelectedTagIdsFromCards() {
        const checkboxes = document.querySelectorAll(
          'input[id^="tag-select-"]:checked'
        );
        return Array.from(checkboxes).map((cb) => parseInt(cb.value));
      }

      // 清空节点文本框
      function clearNodeTextarea() {
        document.getElementById("node-feedback-textarea").value = "";
      }

      // 删除选中的Tag
      async function deleteSelectedTags() {
        const selectedTagIds = getSelectedTagIdsFromCards();
        if (selectedTagIds.length === 0) {
          alert("请先勾选要删除的Tag！");
          return;
        }

        if (
          !confirm(
            `确定要删除选中的 ${selectedTagIds.length} 个Tag吗？这将同时删除Tag与节点的关联关系。`
          )
        ) {
          return;
        }

        try {
          const result = await apiRequest("/api/tags/batch-delete", "POST", {
            tag_ids: selectedTagIds,
          });

          if (result.ok) {
            alert(result.data.message);
            loadTags(); // 重新加载Tag列表
          } else {
            alert(`删除失败: ${result.data.error}`);
          }
        } catch (error) {
          console.error("删除Tag失败:", error);
          alert(`删除失败: ${error.message}`);
        }
      }

      // 新的批量操作函数
      async function batchOperateNodes(action) {
        const selectedTagIds = getSelectedTagIdsFromCards();
        if (selectedTagIds.length === 0) {
          alert("请先勾选要操作的Tag！");
          return;
        }

        const nodeText = document
          .getElementById("node-feedback-textarea")
          .value.trim();
        if (!nodeText) {
          alert("请输入节点链接！");
          return;
        }

        const nodes = nodeText.split("\n").filter((line) => line.trim() !== "");
        if (nodes.length === 0) {
          alert("没有找到有效的节点链接！");
          return;
        }

        const actionText = action === "add" ? "添加" : "删除";

        if (
          !confirm(
            `确定要在选中的 ${selectedTagIds.length} 个Tag中${actionText} ${nodes.length} 个节点吗？`
          )
        ) {
          return;
        }

        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = "处理中...";

        try {
          const result = await apiRequest("/api/nodes/batch-operate", "POST", {
            tag_ids: selectedTagIds,
            nodes: nodes,
            action: action,
          });

          if (result.ok) {
            // 显示详细的操作结果
            let message = result.data.message;
            if (result.data.details) {
              message += "\n\n详细结果：\n" + result.data.details.join("\n");
            }
            alert(message);
            clearNodeTextarea();
            loadTags(); // 重新加载Tag列表
          } else {
            alert(`操作失败: ${result.data.error}`);
          }
        } catch (error) {
          console.error("批量操作错误:", error);
          alert(`操作失败: ${error.message}`);
        } finally {
          button.disabled = false;
          button.textContent = originalText;
        }
      }

      // 保留原有的函数（向后兼容）
      async function updateNodeStatus(markOthersFailed) {
        const nodeText = document
          .getElementById("node-feedback-textarea")
          .value.trim();
        if (!nodeText) {
          alert("请粘贴可用节点列表！");
          return;
        }

        const nodes = nodeText.split("\n").filter(Boolean);
        if (nodes.length === 0) {
          alert("没有找到有效的节点！");
          return;
        }

        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = "更新中...";

        try {
          const result = await apiRequest("/api/nodes/update-status", "POST", {
            nodes: nodes,
            mark_others_failed: markOthersFailed,
          });

          if (result.ok) {
            alert(result.data.message);
            document.getElementById("node-feedback-textarea").value = "";
            loadTags();
          } else {
            alert(`更新失败: ${result.data.error}`);
          }
        } catch (error) {
          alert(`更新失败: ${error.message}`);
        } finally {
          button.disabled = false;
          button.textContent = originalText;
        }
      }

      // =================================================================
      // 节点池管理功能
      // =================================================================
      async function loadNodePool() {
        const listElement = document.getElementById("node-pool-list");
        if (!listElement) return;

        listElement.innerHTML =
          '<div class="text-center p-3 text-muted">正在加载节点...</div>';

        const result = await apiRequest("/api/nodes", "GET");

        if (result.ok && Array.isArray(result.data)) {
          allNodes = result.data;

          if (allNodes.length === 0) {
            listElement.innerHTML =
              '<div class="text-center p-3 text-muted">您的节点池是空的。请先添加并刷新订阅源。</div>';
            updateNodeCountBadge(0);
            return;
          }

          // 填充来源过滤器下拉列表
          populateSourceFilter();

          // 应用初始过滤并显示
          filterNodes();
        } else {
          listElement.innerHTML =
            '<div class="text-center p-3 text-danger">加载节点池失败。</div>';
          updateNodeCountBadge(0);
        }
      }

      // 填充来源过滤器下拉列表
      function populateSourceFilter() {
        const sourceFilter = document.getElementById("source-filter");
        if (!sourceFilter) return;

        const sources = [...new Set(allNodes.map((node) => node.source_name))];

        // 清除现有选项，除了第一个
        sourceFilter.innerHTML = '<option value="">所有来源</option>';

        sources.forEach((source) => {
          const option = document.createElement("option");
          option.value = source;
          option.textContent = source;
          sourceFilter.appendChild(option);
        });
      }

      // 过滤节点
      function filterNodes() {
        const searchTerm =
          document.getElementById("node-search")?.value.toLowerCase() || "";
        const sourceFilter =
          document.getElementById("source-filter")?.value || "";
        const protocolFilter =
          document.getElementById("protocol-filter")?.value || "";

        filteredNodes = allNodes.filter((node) => {
          const matchesSearch =
            !searchTerm ||
            (node.node_name &&
              node.node_name.toLowerCase().includes(searchTerm)) ||
            (node.source_name &&
              node.source_name.toLowerCase().includes(searchTerm)) ||
            (node.server && node.server.toLowerCase().includes(searchTerm));

          const matchesSource =
            !sourceFilter || node.source_name === sourceFilter;
          const matchesProtocol =
            !protocolFilter || node.protocol === protocolFilter;

          return matchesSearch && matchesSource && matchesProtocol;
        });

        currentPage = 1; // 重置到第一页
        displayNodes();
        updatePagination();
        updateNodeCountBadge(filteredNodes.length);
      }

      // 显示当前页的节点
      function displayNodes() {
        const listElement = document.getElementById("node-pool-list");
        if (!listElement) return;

        const startIndex = (currentPage - 1) * nodesPerPage;
        const endIndex = startIndex + nodesPerPage;
        const nodesToShow = filteredNodes.slice(startIndex, endIndex);

        if (nodesToShow.length === 0) {
          listElement.innerHTML =
            '<div class="text-center p-3 text-muted">没有找到匹配的节点。</div>';
          return;
        }

        listElement.innerHTML = nodesToShow
          .map(
            (node) => `
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <h6 class="mb-0 text-truncate" style="max-width: 60%;">${escapeHTML(
                                  node.node_name || "未知节点"
                                )}</h6>
                                <div>
                                    <span class="badge bg-primary me-1">${(
                                      node.protocol || "unknown"
                                    ).toUpperCase()}</span>
                                    <span class="badge bg-secondary">${escapeHTML(
                                      node.server || "unknown"
                                    )}</span>
                                </div>
                            </div>
                            <p class="mb-1 small text-muted">来源: ${escapeHTML(
                              node.source_name || "未知"
                            )}</p>
                            <small class="text-muted">添加时间: ${new Date(
                              node.created_at
                            ).toLocaleString("zh-CN")}</small>
                        </div>
                        <div class="ms-2">
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-info" onclick="copyNodeUrl('${escapeHTML(
                                  node.node_url || ""
                                )}', this)" title="复制节点链接">📋</button>
                                <button class="btn btn-outline-success" onclick="addNodeToTag(${
                                  node.id
                                }, '${escapeHTML(
              node.node_name || "未知节点"
            )}')" title="添加到Tag">🏷️</button>
                            </div>
                        </div>
                    </div>
                </div>
            `
          )
          .join("");
      }

      // 更新分页
      function updatePagination() {
        const paginationElement = document.getElementById("node-pagination");
        if (!paginationElement) return;

        const totalPages = Math.ceil(filteredNodes.length / nodesPerPage);

        if (totalPages <= 1) {
          paginationElement.innerHTML = "";
          return;
        }

        let paginationHTML = "";

        // 上一页按钮
        paginationHTML += `
                <li class="page-item ${currentPage === 1 ? "disabled" : ""}">
                    <a class="page-link" href="#" onclick="changePage(${
                      currentPage - 1
                    })">上一页</a>
                </li>
            `;

        // 页码
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);

        if (startPage > 1) {
          paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(1)">1</a></li>`;
          if (startPage > 2) {
            paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
          }
        }

        for (let i = startPage; i <= endPage; i++) {
          paginationHTML += `
                    <li class="page-item ${i === currentPage ? "active" : ""}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `;
        }

        if (endPage < totalPages) {
          if (endPage < totalPages - 1) {
            paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
          }
          paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${totalPages})">${totalPages}</a></li>`;
        }

        // 下一页按钮
        paginationHTML += `
                <li class="page-item ${
                  currentPage === totalPages ? "disabled" : ""
                }">
                    <a class="page-link" href="#" onclick="changePage(${
                      currentPage + 1
                    })">下一页</a>
                </li>
            `;

        paginationElement.innerHTML = paginationHTML;
      }

      // 切换页面
      function changePage(page) {
        const totalPages = Math.ceil(filteredNodes.length / nodesPerPage);
        if (page < 1 || page > totalPages) return;

        currentPage = page;
        displayNodes();
        updatePagination();
      }

      // 更新节点计数徽章
      function updateNodeCountBadge(count) {
        const badge = document.getElementById("node-count-badge");
        if (badge) {
          badge.textContent = `总计: ${count}`;
        }
      }

      // 复制节点URL
      function copyNodeUrl(nodeUrl, button) {
        if (navigator.clipboard && window.isSecureContext) {
          // 使用现代 Clipboard API
          navigator.clipboard
            .writeText(nodeUrl)
            .then(() => {
              showCopySuccess(button);
            })
            .catch(() => {
              fallbackCopyTextToClipboard(nodeUrl, button, "📋");
            });
        } else {
          // 使用备用方案
          fallbackCopyTextToClipboard(nodeUrl, button, "📋");
        }
      }

      // 显示复制成功状态
      function showCopySuccess(button) {
        const originalText = button.textContent;
        button.textContent = "✅";
        button.classList.add("btn-success");
        button.classList.remove("btn-outline-info");

        setTimeout(() => {
          button.textContent = originalText;
          button.classList.remove("btn-success");
          button.classList.add("btn-outline-info");
        }, 1000);
      }

      // 将节点添加到Tag
      function addNodeToTag(nodeId, nodeName) {
        // 显示Tag选择模态框
        const modal = new bootstrap.Modal(
          document.getElementById("addToTagModal")
        );
        modal.show();

        // 设置当前操作的节点信息
        window.currentAddToTagNodeId = nodeId;
        window.currentAddToTagNodeName = nodeName;

        // 加载Tag列表
        loadTagsForAddToTag();
      }

      // 加载Tag列表用于添加到Tag
      async function loadTagsForAddToTag() {
        try {
          const result = await apiRequest("/api/tags", "GET");
          if (result.ok && Array.isArray(result.data)) {
            const select = document.getElementById("addToTagSelect");
            select.innerHTML = '<option value="">请选择Tag...</option>';

            // 添加用户的所有Tag
            result.data.forEach((tag) => {
              const option = document.createElement("option");
              option.value = tag.id;
              option.textContent = `${tag.tag_name} (${tag.node_count}个节点)`;
              select.appendChild(option);
            });
          }
        } catch (error) {
          console.error("加载Tag列表失败:", error);
          showAlert(
            "加载Tag列表失败",
            "danger",
            document.getElementById("add-to-tag-alert")
          );
        }
      }

      // 确认添加节点到Tag
      async function confirmAddToTag() {
        const tagId = document.getElementById("addToTagSelect").value;
        const nodeId = window.currentAddToTagNodeId;
        const nodeName = window.currentAddToTagNodeName;

        if (!tagId) {
          showAlert(
            "请选择一个Tag",
            "warning",
            document.getElementById("add-to-tag-alert")
          );
          return;
        }

        if (!nodeId) {
          showAlert(
            "节点ID无效",
            "danger",
            document.getElementById("add-to-tag-alert")
          );
          return;
        }

        try {
          // 获取Tag名称
          const tagSelect = document.getElementById("addToTagSelect");
          const selectedOption = tagSelect.options[tagSelect.selectedIndex];
          const tagName = selectedOption.textContent.split(" (")[0];

          const result = await apiRequest("/api/tags/add-nodes", "POST", {
            tag_name: tagName,
            nodes: [nodeId.toString()],
          });

          if (result.ok) {
            showAlert(
              `节点"${nodeName}"已成功添加到Tag"${tagName}"！`,
              "success",
              document.getElementById("add-to-tag-alert")
            );

            // 关闭模态框
            setTimeout(() => {
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("addToTagModal")
              );
              modal.hide();
            }, 1500);
          } else {
            showAlert(
              `添加失败: ${result.data.error || "未知错误"}`,
              "danger",
              document.getElementById("add-to-tag-alert")
            );
          }
        } catch (error) {
          console.error("添加节点到Tag失败:", error);
          showAlert(
            "添加节点到Tag失败",
            "danger",
            document.getElementById("add-to-tag-alert")
          );
        }
      }

      // 刷新所有订阅源
      async function refreshAllSources() {
        if (!confirm("确定要刷新所有订阅源吗？这可能需要一些时间。")) return;

        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = "刷新中...";

        try {
          // 获取所有订阅源并刷新它们
          const sourcesResult = await apiRequest(
            "/api/subscription-sources",
            "GET"
          );
          if (sourcesResult.ok && sourcesResult.data.length > 0) {
            const refreshPromises = sourcesResult.data.map((source) =>
              apiRequest(
                `/api/subscription-sources/${source.id}/refresh`,
                "POST"
              )
            );

            await Promise.all(refreshPromises);
            alert("所有订阅源刷新请求已发送，请稍后查看更新结果。");

            // 延迟后重新加载订阅源和节点池
            setTimeout(() => {
              loadSubscriptionSources();
              loadNodePool();
            }, 3000);
          } else {
            alert("没有找到订阅源需要刷新。");
          }
        } catch (error) {
          alert("刷新失败: " + error.message);
        } finally {
          button.disabled = false;
          button.textContent = originalText;
        }
      }

      function getStatusColor(status) {
        switch (status) {
          case "success":
            return "success";
          case "fetching":
            return "info";
          case "failed":
            return "danger";
          default:
            return "secondary";
        }
      }

      // 复制功能的备用方案
      function fallbackCopyTextToClipboard(text, button, originalText) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.position = "fixed";
        textArea.style.opacity = "0";

        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
          const successful = document.execCommand("copy");
          if (successful) {
            showCopySuccess(button);
          } else {
            alert("复制失败，请手动复制");
          }
        } catch (err) {
          alert("复制失败，请手动复制");
        }

        document.body.removeChild(textArea);
      }

      // =================================================================
      // 节点生成器功能
      // =================================================================

      // 端口配置
      const httpsPorts = [2053, 2083, 2087, 2096, 8443, 443];
      const httpPorts = [2052, 2082, 2086, 2095, 80, 8080, 8880];

      // 更新预估函数
      function updateEstimation() {
        let totalAddressSources = 0;
        const isBuiltinTabActive = document
          .getElementById("builtin-tab")
          .classList.contains("active");

        // 检查源节点是否已选择
        const sourceNodeUrl = getCurrentSourceNodeUrl();
        const hasSourceNode = !!sourceNodeUrl;

        if (isBuiltinTabActive) {
          const selectedRegions = Array.from(
            document.querySelectorAll(
              '#region-selector input[type="checkbox"]:checked'
            )
          ).map((cb) => cb.value);
          const useIPv4 = document.getElementById("useIPv4").checked;
          const useIPv6 = document.getElementById("useIPv6").checked;

          selectedRegions.forEach((region) => {
            const data = dataByCountry[region];

            // 正确计算IPv4 CIDR段的IP数量
            if (useIPv4 && data.ipv4) {
              data.ipv4.forEach((cidr) => {
                const [ip, prefix] = cidr.split("/");
                const prefixNum = parseInt(prefix);
                if (prefixNum >= 0 && prefixNum <= 32) {
                  const hostBits = 32 - prefixNum;
                  const availableIPs = Math.pow(2, hostBits);
                  totalAddressSources += availableIPs;
                  console.log(
                    `内置IPv4 CIDR ${cidr}: ${availableIPs.toLocaleString()} 个可用地址`
                  );
                }
              });
            }

            // 正确计算IPv6 CIDR段的IP数量
            if (useIPv6 && data.ipv6) {
              data.ipv6.forEach((cidr) => {
                const [ip, prefix] = cidr.split("/");
                const prefixNum = parseInt(prefix);
                if (prefixNum >= 0 && prefixNum <= 128) {
                  const hostBits = 128 - prefixNum;
                  if (hostBits <= 32) {
                    const availableIPs = Math.pow(2, hostBits);
                    totalAddressSources += availableIPs;
                    console.log(
                      `内置IPv6 CIDR ${cidr}: ${availableIPs.toLocaleString()} 个可用地址`
                    );
                  } else {
                    // 对于大型IPv6网络，使用合理的估算值
                    const estimatedIPs = Math.pow(2, 32); // 约42亿个地址作为上限
                    totalAddressSources += estimatedIPs;
                    console.log(
                      `内置IPv6 CIDR ${cidr}: 超大网络，估算 ${estimatedIPs.toLocaleString()} 个可用地址`
                    );
                  }
                }
              });
            }

            // 域名数量
            if (data.domains) {
              totalAddressSources += data.domains.length;
              console.log(`内置域名 ${region}: ${data.domains.length} 个域名`);
            }
          });
        } else {
          // 自定义数据：解析CIDR并计算可用IP数量
          const customData = document.getElementById("customData").value.trim();
          const lines = customData.split("\n").filter(Boolean);

          lines.forEach((line) => {
            if (line.includes("/")) {
              // CIDR格式：正确区分IPv4和IPv6
              const [ip, prefix] = line.split("/");
              const prefixNum = parseInt(prefix);

              if (ip.includes(".")) {
                // IPv4 处理
                if (prefixNum >= 0 && prefixNum <= 32) {
                  const hostBits = 32 - prefixNum;
                  const availableIPs = Math.pow(2, hostBits);
                  totalAddressSources += availableIPs;
                  console.log(`IPv4 CIDR ${line}: ${availableIPs} 个可用地址`);
                }
              } else if (ip.includes(":")) {
                // IPv6 处理
                if (prefixNum >= 0 && prefixNum <= 128) {
                  const hostBits = 128 - prefixNum;
                  // IPv6地址空间巨大，需要限制计算范围
                  if (hostBits <= 32) {
                    // 只有当主机位 <= 32 时才计算，否则数字太大
                    const availableIPs = Math.pow(2, hostBits);
                    totalAddressSources += availableIPs;
                    console.log(
                      `IPv6 CIDR ${line}: ${availableIPs} 个可用地址`
                    );
                  } else {
                    // 对于大型IPv6网络，使用一个合理的估算值
                    const estimatedIPs = Math.pow(2, 32); // 约42亿个地址作为上限
                    totalAddressSources += estimatedIPs;
                    console.log(
                      `IPv6 CIDR ${line}: 超大网络，估算 ${estimatedIPs} 个可用地址`
                    );
                  }
                }
              }
            } else {
              // 单个IP或域名
              totalAddressSources += 1;
            }
          });
        }

        // 获取选中的端口数量
        const selectedPorts = getSelectedPorts();
        const totalCombinations = totalAddressSources * selectedPorts.length;

        // 更新显示信息，包含最大可生成数量和源节点状态
        const estimationElement = document.getElementById("estimation");
        let statusText = "准备就绪";
        let statusClass = "text-muted";

        if (!hasSourceNode) {
          statusText = "⚠️ 请先选择或粘贴源节点";
          statusClass = "text-warning";
        } else if (totalAddressSources === 0) {
          statusText = "⚠️ 请配置数据源";
          statusClass = "text-warning";
        } else {
          statusText = "✅ 配置完成，可以生成节点";
          statusClass = "text-success";
        }

        estimationElement.innerHTML = `
                <strong>当前配置可生成 ${totalCombinations.toLocaleString()} 个不重复的"地址:端口"组合</strong><br>
                <small class="text-muted">地址源: ${totalAddressSources.toLocaleString()} 个 × 端口: ${
          selectedPorts.length
        } 个 = ${totalCombinations.toLocaleString()} 个组合</small><br />
                <small class="${statusClass}">${statusText}</small>
            `;

        // 存储最大可生成数量供验证使用
        window.maxGeneratableNodes = totalCombinations;

        // 检查当前输入的生成数量是否超限
        validateQuantityInput();
      }

      // 验证生成数量输入
      function validateQuantityInput() {
        const quantityInput = document.getElementById("quantity");
        const requestedQuantity = parseInt(quantityInput.value) || 0;
        const maxNodes = window.maxGeneratableNodes || 0;

        // 移除之前的警告样式
        quantityInput.classList.remove("is-invalid");

        // 移除之前的警告信息
        const existingWarning = document.getElementById("quantity-warning");
        if (existingWarning) {
          existingWarning.remove();
        }

        if (requestedQuantity > maxNodes && maxNodes > 0) {
          // 添加警告样式
          quantityInput.classList.add("is-invalid");

          // 创建警告信息
          const warningDiv = document.createElement("div");
          warningDiv.id = "quantity-warning";
          warningDiv.className = "invalid-feedback";
          warningDiv.innerHTML = `
                    <strong>⚠️ 数量超限！</strong><br>
                    请求生成 <strong>${requestedQuantity}</strong> 个节点，但当前配置最多只能生成 <strong>${maxNodes.toLocaleString()}</strong> 个不重复节点。<br>
                    <small>超出部分将产生重复节点，建议调整生成数量或增加地址源。</small>
                `;

          quantityInput.parentNode.appendChild(warningDiv);
          return false;
        }

        return true;
      }

      // 折叠提示信息函数
      function collapseAlert(alertId) {
        const alertElement = document.getElementById(alertId);
        if (alertElement) {
          // 添加淡出动画
          alertElement.style.transition =
            "opacity 0.3s ease-out, height 0.3s ease-out";
          alertElement.style.opacity = "0";
          alertElement.style.height = "0";
          alertElement.style.overflow = "hidden";
          alertElement.style.marginBottom = "0";
          alertElement.style.paddingTop = "0";
          alertElement.style.paddingBottom = "0";

          // 300ms后完全隐藏元素
          setTimeout(() => {
            alertElement.style.display = "none";
          }, 300);
        }
      }

      // 获取选中的端口
      function getSelectedPorts() {
        const isBuiltinTabActive = document
          .getElementById("builtin-tab")
          .classList.contains("active");

        if (isBuiltinTabActive) {
          // 内置数据使用选中的端口
          const selectedPorts = [];
          const portCheckboxes = document.querySelectorAll(
            '#builtin-https-port-selector input[type="checkbox"]:checked'
          );
          portCheckboxes.forEach((checkbox) => {
            selectedPorts.push(parseInt(checkbox.value));
          });
          return selectedPorts.length > 0 ? selectedPorts : [443]; // 如果没有选中任何端口，默认使用443
        } else {
          // 自定义数据使用选中的端口
          const selectedPorts = [];
          const portCheckboxes = document.querySelectorAll(
            '#https-port-selector input[type="checkbox"]:checked'
          );
          portCheckboxes.forEach((checkbox) => {
            selectedPorts.push(parseInt(checkbox.value));
          });
          return selectedPorts.length > 0 ? selectedPorts : httpsPorts; // 如果没有选中任何端口，使用默认端口
        }
      }

      // 复制结果函数
      function copyResults() {
        const outputText = document.getElementById("output");
        if (!outputText.value) {
          alert("没有可复制的内容！");
          return;
        }
        navigator.clipboard
          .writeText(outputText.value)
          .then(() => {
            alert(
              "已成功复制 " +
                outputText.value.split("\n").length +
                " 个节点到剪贴板！"
            );
          })
          .catch((err) => {
            try {
              outputText.select();
              document.execCommand("copy");
              alert("自动复制失败，但已为您全选文本，请按 Ctrl+C 手动复制。");
            } catch (e) {
              alert("复制失败，请手动复制。");
            }
          });
      }

      // 复制到剪贴板函数
      function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        const text = element.textContent;

        navigator.clipboard
          .writeText(text)
          .then(() => {
            alert("已复制到剪贴板！");
          })
          .catch((err) => {
            try {
              const textArea = document.createElement("textarea");
              textArea.value = text;
              document.body.appendChild(textArea);
              textArea.select();
              document.execCommand("copy");
              document.body.removeChild(textArea);
              alert("已复制到剪贴板！");
            } catch (e) {
              alert("复制失败，请手动复制。");
            }
          });
      }

      // 正确的CIDR解析函数
      function parseCIDR(cidr) {
        try {
          const [ip, prefixStr] = cidr.split("/");
          const prefix = parseInt(prefixStr, 10);

          if (ip.includes(".")) {
            // IPv4 处理
            if (isNaN(prefix) || prefix < 0 || prefix > 32) return null;
            const parts = ip.split(".").map(Number);
            if (
              parts.length !== 4 ||
              parts.some((p) => isNaN(p) || p < 0 || p > 255)
            )
              return null;

            // 将IP地址转换为BigInt
            const ipBigInt =
              (BigInt(parts[0]) << 24n) |
              (BigInt(parts[1]) << 16n) |
              (BigInt(parts[2]) << 8n) |
              BigInt(parts[3]);

            // 计算网络地址（清除主机位）
            const hostBits = 32 - prefix;
            const mask = hostBits === 0 ? 0n : (1n << BigInt(hostBits)) - 1n;
            const networkAddress = ipBigInt & ~mask;

            return {
              type: "v4",
              network: networkAddress,
              prefix: prefix,
              hostBits: hostBits,
            };
          } else {
            // IPv6 处理
            if (isNaN(prefix) || prefix < 0 || prefix > 128) return null;

            // 正确处理IPv6地址展开
            let expandedIP = ip;
            if (ip.includes("::")) {
              const parts = ip.split("::");
              const leftParts = parts[0]
                ? parts[0].split(":").filter((p) => p !== "")
                : [];
              const rightParts = parts[1]
                ? parts[1].split(":").filter((p) => p !== "")
                : [];
              const missingParts = 8 - leftParts.length - rightParts.length;
              const middleParts = Array(missingParts).fill("0");
              expandedIP = [...leftParts, ...middleParts, ...rightParts].join(
                ":"
              );
            }

            const parts = expandedIP.split(":");
            if (parts.length !== 8) return null;

            // 验证每个部分都是有效的16进制
            for (let part of parts) {
              if (part === "") part = "0";
              const num = parseInt(part, 16);
              if (isNaN(num) || num < 0 || num > 0xffff) return null;
            }

            // 计算IPv6地址的BigInt值
            let ipBigInt = 0n;
            for (let i = 0; i < 8; i++) {
              const part = parts[i] === "" ? "0" : parts[i];
              ipBigInt = (ipBigInt << 16n) | BigInt(parseInt(part, 16));
            }

            // 计算网络地址
            const hostBits = 128 - prefix;
            const mask = hostBits === 0 ? 0n : (1n << BigInt(hostBits)) - 1n;
            const networkAddress = ipBigInt & ~mask;

            return {
              type: "v6",
              network: networkAddress,
              prefix: prefix,
              hostBits: hostBits,
            };
          }
        } catch (e) {
          console.error("CIDR解析错误:", e, "CIDR:", cidr);
          return null;
        }
      }

      function getRandomIP(range) {
        // 如果没有主机位（/32 或 /128），直接返回网络地址
        if (range.hostBits === 0) {
          const ip = range.network;
          if (range.type === "v4") {
            return [
              (ip >> 24n) & 255n,
              (ip >> 16n) & 255n,
              (ip >> 8n) & 255n,
              ip & 255n,
            ].join(".");
          } else {
            const parts = [];
            for (let i = 7; i >= 0; i--) {
              const part = ((ip >> BigInt(i * 16)) & 0xffffn)
                .toString(16)
                .padStart(4, "0");
              parts.push(part);
            }
            return parts.join(":");
          }
        }

        const hostBits = BigInt(range.hostBits);

        // 生成随机主机部分
        let randomHost;
        if (hostBits <= 53n) {
          // 对于较小的范围，使用标准方法
          const maxHost = (1n << hostBits) - 1n;
          randomHost = BigInt(Math.floor(Math.random() * Number(maxHost + 1n)));
        } else {
          // 对于大范围，使用更安全的分段随机
          const maxSafeInt = BigInt(Number.MAX_SAFE_INTEGER);
          const maxHost = (1n << hostBits) - 1n;

          // 使用多次随机来覆盖大范围
          let attempts = 0;
          do {
            const segment = BigInt(
              Math.floor(Math.random() * Number(maxSafeInt))
            );
            const offset = BigInt(
              Math.floor(Math.random() * Number(maxSafeInt))
            );
            randomHost = (segment << 32n) | offset;
            attempts++;
          } while (randomHost > maxHost && attempts < 10);

          // 如果还是超出范围，使用取模
          if (randomHost > maxHost) {
            randomHost = randomHost % (maxHost + 1n);
          }
        }

        // 网络地址 + 随机主机部分 = 最终IP
        const finalIP = range.network + randomHost;

        if (range.type === "v4") {
          return [
            (finalIP >> 24n) & 255n,
            (finalIP >> 16n) & 255n,
            (finalIP >> 8n) & 255n,
            finalIP & 255n,
          ].join(".");
        } else {
          const parts = [];
          for (let i = 7; i >= 0; i--) {
            const part = ((finalIP >> BigInt(i * 16)) & 0xffffn)
              .toString(16)
              .padStart(4, "0");
            parts.push(part);
          }
          // 简化IPv6地址表示（移除前导零）
          let ipv6 = parts.join(":");
          ipv6 = ipv6.replace(/(^|:)0+([0-9a-f])/g, "$1$2");
          // 处理全零段
          ipv6 = ipv6.replace(/(^|:)0(:|$)/g, "$1$2");
          return ipv6;
        }
      }

      // 测试CIDR解析（调试用）
      function testCIDRParsing() {
        const testCases = [
          // IPv4 测试
          "104.28.43.44/22", // 您的测试用例
          "104.28.43.45/32", // 单个IP
          "192.168.1.100/24", // 标准网段
          "10.0.0.0/8", // 大网段
          // IPv6 测试
          "2a09:bac1:19c0:10::1/64",
          "2606:4700::1/32",
          "2001:db8::1/128", // 单个IPv6
          "fe80::/10",
        ];

        console.log("=== CIDR 解析测试 ===");
        testCases.forEach((cidr) => {
          console.log(`\n🔍 测试: ${cidr}`);
          const parsed = parseCIDR(cidr);
          if (parsed) {
            console.log(`✅ 解析成功:`);
            console.log(`   类型: ${parsed.type === "v4" ? "IPv4" : "IPv6"}`);
            console.log(`   网络地址: ${parsed.network.toString()}`);
            console.log(`   前缀长度: /${parsed.prefix}`);
            console.log(`   主机位数: ${parsed.hostBits}`);
            console.log(
              `   可用IP数: ${
                parsed.hostBits === 0
                  ? 1
                  : parsed.hostBits > 20
                  ? "2^" + parsed.hostBits + " (很大)"
                  : Math.pow(2, parsed.hostBits)
              }`
            );

            // 显示网络范围
            if (parsed.hostBits > 0) {
              const startIP = getRandomIP({ ...parsed, hostBits: 0 }); // 网络地址
              console.log(`   网络范围起始: ${startIP}`);
            }

            // 生成几个随机IP测试
            const testCount = parsed.hostBits === 0 ? 1 : 5;
            console.log(`   生成${testCount}个随机IP:`);
            for (let i = 0; i < testCount; i++) {
              const randomIP = getRandomIP(parsed);
              console.log(`     ${i + 1}. ${randomIP}`);
            }
          } else {
            console.log(`❌ 解析失败`);
          }
          console.log("─".repeat(50));
        });
      }

      // 初始化地区选择器
      function initializeRegionSelector() {
        const regionSelector = document.getElementById("region-selector");
        if (!regionSelector || !window.dataByCountry) return;

        let checkboxesHTML = "";
        for (const region in window.dataByCountry) {
          checkboxesHTML += `
                    <div class="region-checkbox">
                        <input class="form-check-input" type="checkbox" id="region-${region.replace(
                          /[^a-zA-Z0-9]/g,
                          "-"
                        )}" value="${region}" checked onchange="updateEstimation()">
                        <label class="form-check-label" for="region-${region.replace(
                          /[^a-zA-Z0-9]/g,
                          "-"
                        )}">${region}</label>
                    </div>`;
        }
        regionSelector.innerHTML = checkboxesHTML;

        // 初始化HTTPS端口选择器
        initializePortSelector();

        // 初始化其他组件
        initializeOtherComponents();
      }

      // 初始化端口选择器
      function initializePortSelector() {
        // 为自定义数据源初始化端口选择器
        const customPortSelector = document.getElementById(
          "https-port-selector"
        );
        if (customPortSelector && window.portConfig) {
          let portsHTML = "";
          window.portConfig.https.forEach((port) => {
            portsHTML += `
                        <div class="col-md-4 col-sm-6 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="custom-port-${port}" value="${port}" checked onchange="updateEstimation()">
                                <label class="form-check-label" for="custom-port-${port}">
                                    <strong>${port}</strong>
                                </label>
                            </div>
                        </div>`;
          });
          customPortSelector.innerHTML = portsHTML;
        }

        // 为内置数据源初始化端口选择器
        const builtinPortSelector = document.getElementById(
          "builtin-https-port-selector"
        );
        if (builtinPortSelector && window.portConfig) {
          let portsHTML = "";
          window.portConfig.https.forEach((port, index) => {
            // 默认只选择443端口，其他端口不选中
            const isChecked = port === 443 ? "checked" : "";
            portsHTML += `
                        <div class="col-md-4 col-sm-6 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="builtin-port-${port}" value="${port}" ${isChecked} onchange="updateEstimation()">
                                <label class="form-check-label" for="builtin-port-${port}">
                                    <strong>${port}</strong>
                                </label>
                            </div>
                        </div>`;
          });
          builtinPortSelector.innerHTML = portsHTML;
        }
      }

      // 初始化其他组件
      function initializeOtherComponents() {
        // 添加标签页切换事件监听器
        document.querySelectorAll("#sourceTab button").forEach((tab) => {
          tab.addEventListener("shown.bs.tab", updateEstimation);
        });

        // 节点生成器标签页切换事件监听器
        const generatorTab = document.getElementById("generator-tab");
        if (generatorTab) {
          generatorTab.addEventListener("shown.bs.tab", function (event) {
            console.log("切换到节点生成器标签，开始加载Tag节点...");
            loadTagNodesForGenerator(); // 当标签显示时加载Tag节点
          });
        }

        // 智能格式选择：根据输入的模板自动选择合适的输出格式
        const templateInput = document.getElementById("templateUrl");
        templateInput.addEventListener("input", (event) => {
          const url = event.target.value.trim();
          autoSelectOutputFormat(url);
        });

        // 为自定义数据输入框添加事件监听器
        const customDataInput = document.getElementById("customData");
        if (customDataInput) {
          customDataInput.addEventListener("input", updateEstimation);
        }

        // 初始化预估
        updateEstimation();
      }

      // ========================================================================
      // START: UTF-8 Safe Base64 Encoder/Decoder Pair
      // ========================================================================
      function safeBase64Encode(str) {
        try {
          return btoa(unescape(encodeURIComponent(str)));
        } catch (e) {
          console.error("Base64 encoding error:", e);
          return null;
        }
      }

      function safeBase64Decode(str) {
        try {
          return decodeURIComponent(
            escape(atob(str.replace(/-/g, "+").replace(/_/g, "/")))
          );
        } catch (e) {
          console.error("Base64 decoding error:", e);
          return null;
        }
      }
      // ========================================================================
      // END: UTF-8 Safe Base64 Encoder/Decoder Pair
      // ========================================================================

      // 主解析函数 - 修复Shadowrocket非标准格式支持
      function parseNodeLink(url) {
        if (url.startsWith("vless://")) {
          try {
            // Shadowrocket可能在username中放置auth: `auto:<uuid>`
            const urlObject = new URL(url);
            let uuid = urlObject.username;
            if (uuid.includes(":")) {
              uuid = uuid.split(":")[1];
            }
            const config = {
              id: uuid,
              address: urlObject.hostname,
              port: urlObject.port,
              ...Object.fromEntries(urlObject.searchParams.entries()),
            };
            config.ps = urlObject.hash
              ? decodeURIComponent(urlObject.hash.substring(1))
              : "VLESS_Node";

            return { protocol: "vless", config: config };
          } catch (e) {
            console.error("VLESS parsing error:", e);
            return null;
          }
        } else if (url.startsWith("vmess://")) {
          const data = url.substring("vmess://".length);
          const decodedJsonStr = safeBase64Decode(data);
          if (decodedJsonStr) {
            try {
              const config = JSON.parse(decodedJsonStr);
              if (config.v && config.add)
                return { protocol: "vmess", config: config };
            } catch (e) {}
          }
          try {
            const urlObject = new URL(url);
            const decodedAuth = safeBase64Decode(urlObject.username);
            const [scy, id] = decodedAuth.split(":");
            const config = {
              ps: urlObject.hash
                ? decodeURIComponent(urlObject.hash.substring(1))
                : "VMess_Node",
              add: urlObject.hostname,
              port: urlObject.port,
              id: id,
              scy: scy,
              net: urlObject.searchParams.get("obfs") || "tcp",
              type: "none",
              host:
                urlObject.searchParams.get("obfsParam") ||
                urlObject.searchParams.get("peer") ||
                "",
              path: urlObject.searchParams.get("path") || "/",
              tls: urlObject.searchParams.get("tls") === "1" ? "tls" : "",
              sni: urlObject.searchParams.get("peer") || "",
              aid: urlObject.searchParams.get("alterId") || "0",
            };
            return { protocol: "vmess", config: config };
          } catch (e) {
            console.error("VMess parsing failed for both formats:", e);
          }
        }
        return null;
      }

      // 输出格式生成函数
      function createVlessLink(config, newAddress, newPort) {
        const newConfig = { ...config };
        newConfig.address = newAddress.includes(":")
          ? `[${newAddress}]`
          : newAddress;
        newConfig.port = newPort;

        const query = new URLSearchParams();
        for (const key in newConfig) {
          if (!["id", "address", "port", "ps"].includes(key)) {
            query.set(key, newConfig[key]);
          }
        }
        const queryString = query.toString() ? `?${query.toString()}` : "";
        const name = encodeURIComponent(
          `${newConfig.ps || "VLESS"}_${newAddress}`
        );

        return `vless://${newConfig.id}@${newConfig.address}:${newConfig.port}${queryString}#${name}`;
      }

      function createVmessJsonLink(config, newAddress, newPort) {
        const newConfig = { ...config };
        newConfig.add = newAddress;
        newConfig.port = newPort.toString();
        newConfig.ps = `${newConfig.ps || "VMess"}_${newAddress}`;

        const jsonString = JSON.stringify(newConfig);
        const base64String = safeBase64Encode(jsonString);
        return `vmess://${base64String}`;
      }

      function createVmessQueryLink(config, newAddress, newPort) {
        const newConfig = { ...config };
        newConfig.add = newAddress;
        newConfig.port = newPort.toString();
        newConfig.ps = `${newConfig.ps || "VMess"}_${newAddress}`;

        const authString = `${newConfig.scy || "auto"}:${newConfig.id}`;
        const base64Auth = safeBase64Encode(authString).replace(/=/g, "");

        const params = new URLSearchParams();
        if (newConfig.net === "ws") params.set("obfs", "websocket");
        if (newConfig.host) params.set("obfsParam", newConfig.host);
        if (newConfig.path) params.set("path", newConfig.path);
        if (newConfig.tls === "tls") params.set("tls", "1");
        if (newConfig.sni) params.set("peer", newConfig.sni);
        if (newConfig.aid) params.set("alterId", newConfig.aid);

        const queryString = params.toString() ? `?${params.toString()}` : "";
        const name = encodeURIComponent(newConfig.ps);
        const finalAddress = newAddress.includes(":")
          ? `[${newAddress}]`
          : newAddress;

        return `vmess://${base64Auth}@${finalAddress}:${newConfig.port}${queryString}#${name}`;
      }

      // 主解析函数 - 修复Shadowrocket非标准格式支持
      function parseNodeLink(url) {
        if (url.startsWith("vless://")) {
          try {
            // Shadowrocket可能在username中放置auth: `auto:<uuid>`
            const urlObject = new URL(url);
            let uuid = urlObject.username;
            if (uuid.includes(":")) {
              uuid = uuid.split(":")[1];
            }
            const config = {
              id: uuid,
              address: urlObject.hostname,
              port: urlObject.port,
              ...Object.fromEntries(urlObject.searchParams.entries()),
            };
            config.ps = urlObject.hash
              ? decodeURIComponent(urlObject.hash.substring(1))
              : "VLESS_Node";

            return { protocol: "vless", config: config };
          } catch (e) {
            console.error("VLESS parsing error:", e);
            return null;
          }
        } else if (url.startsWith("vmess://")) {
          const data = url.substring("vmess://".length);
          const decodedJsonStr = safeBase64Decode(data);
          if (decodedJsonStr) {
            try {
              const config = JSON.parse(decodedJsonStr);
              if (config.v && config.add)
                return { protocol: "vmess", config: config };
            } catch (e) {}
          }
          try {
            const urlObject = new URL(url);
            const decodedAuth = safeBase64Decode(urlObject.username);
            const [scy, id] = decodedAuth.split(":");
            const config = {
              ps: urlObject.hash
                ? decodeURIComponent(urlObject.hash.substring(1))
                : "VMess_Node",
              add: urlObject.hostname,
              port: urlObject.port,
              id: id,
              scy: scy,
              net: urlObject.searchParams.get("obfs") || "tcp",
              type: "none",
              host:
                urlObject.searchParams.get("obfsParam") ||
                urlObject.searchParams.get("peer") ||
                "",
              path: urlObject.searchParams.get("path") || "/",
              tls: urlObject.searchParams.get("tls") === "1" ? "tls" : "",
              sni: urlObject.searchParams.get("peer") || "",
              aid: urlObject.searchParams.get("alterId") || "0",
            };
            return { protocol: "vmess", config: config };
          } catch (e) {
            console.error("VMess parsing failed for both formats:", e);
          }
        }
        return null;
      }

      // 输出格式生成函数
      function createVlessLink(config, newAddress, newPort) {
        const newConfig = { ...config };
        newConfig.address = newAddress.includes(":")
          ? `[${newAddress}]`
          : newAddress;
        newConfig.port = newPort;

        const query = new URLSearchParams();
        for (const key in newConfig) {
          if (!["id", "address", "port", "ps"].includes(key)) {
            query.set(key, newConfig[key]);
          }
        }
        const queryString = query.toString() ? `?${query.toString()}` : "";
        const name = encodeURIComponent(
          `${newConfig.ps || "VLESS"}_${newAddress}`
        );

        return `vless://${newConfig.id}@${newConfig.address}:${newConfig.port}${queryString}#${name}`;
      }

      function createVmessJsonLink(config, newAddress, newPort) {
        const newConfig = { ...config };
        newConfig.add = newAddress;
        newConfig.port = newPort.toString();
        newConfig.ps = `${newConfig.ps || "VMess"}_${newAddress}`;

        const jsonString = JSON.stringify(newConfig);
        const base64String = safeBase64Encode(jsonString);
        return `vmess://${base64String}`;
      }

      function createVmessQueryLink(config, newAddress, newPort) {
        const newConfig = { ...config };
        newConfig.add = newAddress;
        newConfig.port = newPort.toString();
        newConfig.ps = `${newConfig.ps || "VMess"}_${newAddress}`;

        const authString = `${newConfig.scy || "auto"}:${newConfig.id}`;
        const base64Auth = safeBase64Encode(authString).replace(/=/g, "");

        const params = new URLSearchParams();
        if (newConfig.net === "ws") params.set("obfs", "websocket");
        if (newConfig.host) params.set("obfsParam", newConfig.host);
        if (newConfig.path) params.set("path", newConfig.path);
        if (newConfig.tls === "tls") params.set("tls", "1");
        if (newConfig.sni) params.set("peer", newConfig.sni);
        if (newConfig.aid) params.set("alterId", newConfig.aid);

        const queryString = params.toString() ? `?${params.toString()}` : "";
        const name = encodeURIComponent(newConfig.ps);
        const finalAddress = newAddress.includes(":")
          ? `[${newAddress}]`
          : newAddress;

        return `vmess://${base64Auth}@${finalAddress}:${newConfig.port}${queryString}#${name}`;
      }

      // 生成节点函数
      function generateNodes() {
        // 获取当前选择的模板节点（优先从下拉选择，其次从手动粘贴）
        const templateUrl = getCurrentSourceNodeUrl();
        const quantity = parseInt(
          document.getElementById("quantity").value,
          10
        );
        const selectedFormat = document.querySelector(
          'input[name="outputFormat"]:checked'
        )?.value;

        if (!templateUrl || isNaN(quantity) || quantity < 1) {
          alert("请确保源节点链接和生成数量已正确填写！");
          return;
        }

        if (!selectedFormat) {
          alert("请选择输出格式！");
          return;
        }

        // 验证生成数量是否超限
        if (!validateQuantityInput()) {
          const maxNodes = window.maxGeneratableNodes || 0;
          const confirmMessage = `⚠️ 警告：请求生成 ${quantity} 个节点，但当前配置最多只能生成 ${maxNodes.toLocaleString()} 个不重复节点。\n\n超出部分将产生重复节点，这可能导致：\n• 节点功能重复\n• 存储空间浪费\n• 管理复杂度增加\n\n是否继续生成？建议调整数量为 ${maxNodes} 或更少。`;

          if (!confirm(confirmMessage)) {
            return;
          }
        }

        const parsedData = parseNodeLink(templateUrl);
        if (!parsedData) {
          alert("无法解析源节点链接！请检查格式是否正确。");
          return;
        }

        // 构建地址池
        const addressPool = [];
        const isBuiltinTabActive = document
          .getElementById("builtin-tab")
          .classList.contains("active");

        if (isBuiltinTabActive) {
          const selectedRegions = Array.from(
            document.querySelectorAll(
              '#region-selector input[type="checkbox"]:checked'
            )
          ).map((cb) => cb.value);
          const useIPv4 = document.getElementById("useIPv4").checked;
          const useIPv6 = document.getElementById("useIPv6").checked;

          if (selectedRegions.length === 0) {
            alert("请至少选择一个内置地区数据源！");
            return;
          }

          if (!useIPv4 && !useIPv6) {
            alert("请至少选择一种IP版本（IPv4或IPv6）！");
            return;
          }

          // 对于内置数据，直接使用CIDR段，不预先展开所有IP
          selectedRegions.forEach((region) => {
            const data = dataByCountry[region];
            if (useIPv4 && data.ipv4) addressPool.push(...data.ipv4);
            if (useIPv6 && data.ipv6) addressPool.push(...data.ipv6);
            if (data.domains) addressPool.push(...data.domains);
          });

          console.log(
            `内置数据源加载完成: ${addressPool.length} 个CIDR段/域名`
          );
        } else {
          const customDataLines = document
            .getElementById("customData")
            .value.trim()
            .split("\n")
            .filter(Boolean);
          addressPool.push(...customDataLines);
          console.log(`自定义数据源加载完成: ${addressPool.length} 个条目`);
        }

        if (addressPool.length === 0) {
          alert("地址池为空！请检查所选的数据是否有效。");
          return;
        }

        // 获取选中的端口
        const selectedPorts = getSelectedPorts();

        // 智能生成节点：按需生成，避免内存问题
        const generatedCombinations = [];
        const usedCombinations = new Set(); // 防止重复
        let attempts = 0;
        const maxAttempts = quantity * 10; // 防止无限循环

        while (
          generatedCombinations.length < quantity &&
          attempts < maxAttempts
        ) {
          attempts++;

          // 随机选择一个地址源
          const randomAddressItem =
            addressPool[Math.floor(Math.random() * addressPool.length)];
          if (!randomAddressItem || typeof randomAddressItem !== "string")
            continue;

          let randomAddress;
          if (randomAddressItem.includes("/")) {
            // 处理CIDR格式 - 随机生成一个IP
            const parsedCidr = parseCIDR(randomAddressItem);
            if (parsedCidr) {
              randomAddress = getRandomIP(parsedCidr);
            } else {
              continue;
            }
          } else {
            // 直接使用IP地址或域名
            randomAddress = randomAddressItem;
          }

          // 随机选择一个端口
          const randomPort =
            selectedPorts[Math.floor(Math.random() * selectedPorts.length)];

          // 创建唯一标识，防止重复
          const combinationKey = `${randomAddress}:${randomPort}`;
          if (!usedCombinations.has(combinationKey)) {
            usedCombinations.add(combinationKey);
            generatedCombinations.push({
              address: randomAddress,
              port: randomPort,
            });
          }
        }

        if (generatedCombinations.length === 0) {
          alert("无法生成有效的地址:端口组合！请检查数据源配置。");
          return;
        }

        const selectedCombinations = generatedCombinations;

        const generatedNodes = [];

        for (const combination of selectedCombinations) {
          let newNode;

          switch (selectedFormat) {
            case "vless":
              if (parsedData.protocol !== "vless") {
                alert("源节点不是 VLESS 协议，无法生成 VLESS 链接！");
                return;
              }
              newNode = createVlessLink(
                parsedData.config,
                combination.address,
                combination.port
              );
              break;
            case "vmess_json":
              if (parsedData.protocol !== "vmess") {
                alert("源节点不是 VMess 协议，无法生成 VMess 链接！");
                return;
              }
              newNode = createVmessJsonLink(
                parsedData.config,
                combination.address,
                combination.port
              );
              break;
            case "vmess_query":
              if (parsedData.protocol !== "vmess") {
                alert("源节点不是 VMess 协议，无法生成 VMess 链接！");
                return;
              }
              newNode = createVmessQueryLink(
                parsedData.config,
                combination.address,
                combination.port
              );
              break;
          }

          if (newNode) {
            generatedNodes.push(newNode);
          }
        }

        if (generatedNodes.length < quantity) {
          alert(
            `注意：由于地址池限制，实际生成了 ${generatedNodes.length} 个节点（请求 ${quantity} 个）。\n\n建议：\n• 增加更多地址源\n• 减少生成数量\n• 检查CIDR配置是否正确`
          );
        } else {
          alert(`✅ 成功生成 ${generatedNodes.length} 个不重复节点！`);
        }

        document.getElementById("output").value = generatedNodes.join("\n");
      }

      // 从CIDR生成随机IP的函数
      function generateRandomIPFromCIDR(cidr) {
        const [baseIP, prefix] = cidr.split("/");
        const prefixNum = parseInt(prefix);

        // 将IP转换为32位整数
        const ipParts = baseIP.split(".").map(Number);
        let baseIPInt =
          (ipParts[0] << 24) +
          (ipParts[1] << 16) +
          (ipParts[2] << 8) +
          ipParts[3];

        // 计算网络掩码
        const mask = (0xffffffff << (32 - prefixNum)) >>> 0;
        const networkAddress = baseIPInt & mask;

        // 计算可用IP范围
        const totalIPs = Math.pow(2, 32 - prefixNum);
        const randomOffset = Math.floor(Math.random() * totalIPs);

        // 生成随机IP（跳过网络地址和广播地址）
        const randomIPInt = networkAddress + randomOffset;

        // 转换回IP字符串
        const ip1 = (randomIPInt >>> 24) & 0xff;
        const ip2 = (randomIPInt >>> 16) & 0xff;
        const ip3 = (randomIPInt >>> 8) & 0xff;
        const ip4 = randomIPInt & 0xff;

        return `${ip1}.${ip2}.${ip3}.${ip4}`;
      }

      // =================================================================
      // 页脚功能
      // =================================================================

      // 打开 GitHub Star 页面
      function openGitHubStar() {
        const githubUrl = "https://github.com/samni728/cfvless-admin";
        const starUrl = `${githubUrl}/stargazers`;

        // 在新窗口打开 GitHub 项目页面
        window.open(githubUrl, "_blank");

        // 显示提示信息
        setTimeout(() => {
          alert(
            "感谢您的支持！\n\n如果这个项目对您有帮助，请：\n1. 点击 ⭐ Star 按钮\n2. 分享给更多朋友\n3. 提出宝贵建议\n\n您的支持是我持续改进的动力！"
          );
        }, 500);
      }

      // =================================================================
      // 页面初始化
      // =================================================================
      document.addEventListener("DOMContentLoaded", () => {
        console.log("页面开始初始化...");

        try {
          // 初始化模态框
          const authModalElement = document.getElementById("authModal");
          if (authModalElement) {
            authModal = new bootstrap.Modal(authModalElement);
          }

          const addSourceModalElement =
            document.getElementById("addSourceModal");
          if (addSourceModalElement) {
            addSourceModal = new bootstrap.Modal(addSourceModalElement);
          }

          const createTagModalElement =
            document.getElementById("createTagModal");
          if (createTagModalElement) {
            createTagModal = new bootstrap.Modal(createTagModalElement);
          }

          // 初始化地区选择器
          initializeRegionSelector();

          // 添加标签页切换事件监听器
          const nodePoolTab = document.getElementById("nodepool-tab");
          if (nodePoolTab) {
            nodePoolTab.addEventListener("shown.bs.tab", function (event) {
              console.log("切换到节点池标签，开始加载节点...");
              loadNodePool(); // 当标签显示时加载节点
            });
          }

          // 添加订阅源管理标签页切换事件监听器
          const managerTab = document.getElementById("manager-tab");
          if (managerTab) {
            managerTab.addEventListener("shown.bs.tab", function (event) {
              console.log("切换到订阅源管理标签，开始加载订阅源...");
              loadSubscriptionSources(); // 当标签显示时加载订阅源
            });
          }

          // 添加源节点管理标签页切换事件监听器
          const sourceNodesTab = document.getElementById("source-nodes-tab");
          if (sourceNodesTab) {
            sourceNodesTab.addEventListener("shown.bs.tab", function (event) {
              console.log("切换到源节点管理标签，开始加载源节点...");
              loadSourceNodes(); // 当标签显示时加载源节点
            });
          }

          // 检查登录状态
          checkLoginStatus();

          console.log("页面初始化完成");
        } catch (error) {
          console.error("页面初始化失败:", error);
          // 如果初始化失败，至少显示登录提示
          const loginPrompt = document.getElementById("login-prompt");
          if (loginPrompt) {
            loginPrompt.style.display = "block";
          }
        }
      });
    </script>
  </body>
</html>
