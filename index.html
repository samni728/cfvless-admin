<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è®¢é˜…èšåˆç®¡ç†å¹³å° V2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8fafc; /* gray-50 */
        }
        .material-icons {
            vertical-align: middle;
        }
        /* Custom styles for better UX */
        .tab-active {
            color: #2563eb; /* text-blue-600 */
            font-weight: 600;
            border-bottom: 2px solid #2563eb;
        }
        .tab-inactive {
            color: #4b5563; /* text-gray-600 */
        }
        .tab-inactive:hover {
            color: #2563eb; /* hover:text-blue-600 */
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Login/Register View -->
    <div id="login-prompt" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="max-w-4xl w-full mx-auto p-8">
            <div class="text-center mb-12">
                <h1 class="text-5xl font-bold text-gray-800">ğŸ·ï¸ è®¢é˜…èšåˆç®¡ç†å¹³å°</h1>
                <p class="text-xl text-gray-600 mt-4">ä¸€ä¸ªåŸºäºTagçš„æ™ºèƒ½èŠ‚ç‚¹ç®¡ç†ã€ç”Ÿæˆä¸èšåˆç³»ç»Ÿ</p>
            </div>
            <div class="bg-white rounded-2xl shadow-xl p-10">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-10 items-center">
                    <div>
                        <h2 class="text-2xl font-semibold text-gray-700 mb-6">æ ¸å¿ƒåŠŸèƒ½</h2>
                        <ul class="space-y-4">
                            <li class="flex items-start">
                                <span class="material-icons text-blue-500 mt-1 mr-3">sell</span>
                                <div>
                                    <h3 class="font-semibold text-gray-800">Tagé©±åŠ¨çš„ç®¡ç†</h3>
                                    <p class="text-gray-600 text-sm">æŒ‰éœ€ä¸ºèŠ‚ç‚¹æ‰“ä¸ŠTagï¼Œå®ç°çµæ´»åˆ†ç±»ä¸è®¢é˜…è¾“å‡ºã€‚</p>
                                </div>
                            </li>
                            <li class="flex items-start">
                                <span class="material-icons text-blue-500 mt-1 mr-3">bolt</span>
                                <div>
                                    <h3 class="font-semibold text-gray-800">æ™ºèƒ½èŠ‚ç‚¹ç”Ÿæˆå™¨</h3>
                                    <p class="text-gray-600 text-sm">åŸºäºæ¨¡æ¿å’Œæµ·é‡IPåº“ï¼Œæ‰¹é‡ç”Ÿæˆå¯ç”¨èŠ‚ç‚¹ã€‚</p>
                                </div>
                            </li>
                            <li class="flex items-start">
                                <span class="material-icons text-blue-500 mt-1 mr-3">sync</span>
                                <div>
                                    <h3 class="font-semibold text-gray-800">è®¢é˜…æºèšåˆ</h3>
                                    <p class="text-gray-600 text-sm">å¯¼å…¥å¹¶èšåˆå¤šä¸ªå¤–éƒ¨è®¢é˜…æºï¼Œè‡ªåŠ¨æ›´æ–°èŠ‚ç‚¹æ± ã€‚</p>
                                </div>
                            </li>
                             <li class="flex items-start">
                                <span class="material-icons text-blue-500 mt-1 mr-3">hub</span>
                                <div>
                                    <h3 class="font-semibold text-gray-800">æºèŠ‚ç‚¹é…ç½®</h3>
                                    <p class="text-gray-600 text-sm">è½»æ¾é…ç½®å’Œç®¡ç†NAT64/ProxyIPç­‰å¤šç§åŸºç¡€æºèŠ‚ç‚¹ã€‚</p>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div id="auth-form-container" class="bg-gray-50 p-8 rounded-xl">
                        <h3 id="auth-title" class="text-2xl font-bold text-center text-gray-800 mb-6">ç”¨æˆ·ç™»å½•</h3>
                        <div id="auth-alert" class="hidden p-3 mb-4 rounded-md text-sm"></div>
                        <form onsubmit="event.preventDefault(); performAuth();">
                            <div class="mb-4">
                                <label for="username" class="block text-sm font-medium text-gray-700 mb-1">ç”¨æˆ·å</label>
                                <input type="text" id="username" autocomplete="username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" required>
                            </div>
                            <div class="mb-6">
                                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">å¯†ç </label>
                                <input type="password" id="password" autocomplete="current-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" required>
                            </div>
                            <button id="auth-submit-button" type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition shadow-md">ç™»å½•</button>
                        </form>
                        <p class="text-center text-sm text-gray-600 mt-6">
                            <span id="auth-switch-text">è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿ</span>
                            <button onclick="switchAuthMode()" class="font-semibold text-blue-600 hover:underline">
                                <span id="auth-switch-link">ç«‹å³æ³¨å†Œ</span>
                            </button>
                        </p>
                    </div>
                </div>
            </div>
             <footer class="text-center py-10 text-gray-500 text-sm">
                <p>CloudflareèŠ‚ç‚¹èšåˆç®¡ç†å¹³å° Power by @samni728</p>
                <div class="flex justify-center items-center space-x-4 my-2">
                    <a href="https://github.com/samni728/cfvless-admin" target="_blank" class="text-gray-500 hover:text-gray-700" title="é¡¹ç›®åœ°å€">
                        <svg aria-hidden="true" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path clip-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.418 2.865 8.165 6.839 9.489.5.092.682-.217.682-.482 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.031-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.203 2.398.1 2.651.64.7 1.03 1.595 1.03 2.688 0 3.848-2.338 4.695-4.566 4.942.359.308.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.001 10.001 0 0022 12c0-5.523-4.477-10-10-10z" fill-rule="evenodd"></path></svg>
                    </a>
                    <a href="https://github.com/samni728/cfvless-admin/stargazers" target="_blank" class="text-yellow-500" title="ç»™ä¸ªStar">
                        <span class="material-icons" style="font-size: 1.5rem;">star</span>
                    </a>
                </div>
                <p>æœ€åæ›´æ–°: 2025-8-26</p>
            </footer>
        </div>
    </div>

    <!-- Main Application View -->
    <div id="main-content" class="min-h-screen bg-gray-50" style="display: none;">
        <header class="bg-blue-600 text-white shadow-md">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold">è®¢é˜…èšåˆç®¡ç†å¹³å° V2.0</h1>
                <div id="user-status-area" class="flex items-center space-x-4">
                    <!-- User status will be rendered here -->
                </div>
            </div>
        </header>

        <main class="container mx-auto px-6 py-8">
            <nav class="bg-white p-4 rounded-lg shadow-sm mb-8">
                <ul id="main-tabs" class="flex items-center space-x-8 text-gray-600">
                    <!-- Tabs will be rendered here -->
                </ul>
            </nav>

            <div id="tab-content">
                <!-- Tab panes will be rendered here -->
            </div>
        </main>

        <footer class="text-center py-6 text-gray-500 text-sm">
            <p>CloudflareèŠ‚ç‚¹èšåˆç®¡ç†å¹³å° Power by @samni728</p>
            <div class="flex justify-center items-center space-x-4 my-2">
                <a href="https://github.com/samni728/cfvless-admin" target="_blank" class="text-gray-500 hover:text-gray-700" title="é¡¹ç›®åœ°å€">
                    <svg aria-hidden="true" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path clip-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.418 2.865 8.165 6.839 9.489.5.092.682-.217.682-.482 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.031-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.203 2.398.1 2.651.64.7 1.03 1.595 1.03 2.688 0 3.848-2.338 4.695-4.566 4.942.359.308.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.001 10.001 0 0022 12c0-5.523-4.477-10-10-10z" fill-rule="evenodd"></path></svg>
                </a>
                 <a href="https://github.com/samni728/cfvless-admin/stargazers" target="_blank" class="text-yellow-500" title="ç»™ä¸ªStar">
                    <span class="material-icons" style="font-size: 1.5rem;">star</span>
                </a>
            </div>
            <p>æœ€åæ›´æ–°: 2025-8-26</p>
        </footer>
    </div>

    <!-- Global Alert/Toast -->
    <div id="global-alert" class="hidden fixed top-5 right-5 w-auto max-w-sm p-4 rounded-lg shadow-lg text-white z-50 flex items-center">
        <span id="global-alert-icon" class="material-icons mr-3"></span>
        <span id="global-alert-message"></span>
    </div>

    <!-- Modals (re-styled with Tailwind) -->
    <!-- Create Tag Modal -->
    <div id="createTagModal" class="fixed inset-0 z-40 hidden items-center justify-center modal">
        <div class="modal-backdrop fixed inset-0 bg-black opacity-50"></div>
        <div class="bg-white rounded-lg shadow-xl m-4 max-w-lg w-full z-50">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800">åˆ›å»ºæ–°Tag</h3>
                <button onclick="hideModal('createTagModal')" class="text-gray-400 hover:text-gray-600">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="p-6">
                <div id="create-tag-alert" class="hidden p-3 mb-4 rounded-md text-sm"></div>
                <div class="mb-4">
                    <label for="tagName" class="block text-sm font-medium text-gray-700 mb-1">Tagåç§° <span class="text-red-500">*</span></label>
                    <input type="text" id="tagName" required placeholder="ä¾‹å¦‚: æ¸¸æˆä¸“ç”¨, ä¸»åŠ›èŠ‚ç‚¹" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <div>
                    <label for="tagDescription" class="block text-sm font-medium text-gray-700 mb-1">æè¿° (å¯é€‰)</label>
                    <textarea id="tagDescription" rows="2" placeholder="ç®€å•æè¿°è¿™ä¸ªTagçš„ç”¨é€”..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"></textarea>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 text-right space-x-2">
                <button onclick="hideModal('createTagModal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">å–æ¶ˆ</button>
                <button onclick="createNewTag()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">åˆ›å»ºTag</button>
            </div>
        </div>
    </div>

    <!-- Add Source Modal -->
    <div id="addSourceModal" class="fixed inset-0 z-40 hidden items-center justify-center modal">
        <div class="modal-backdrop fixed inset-0 bg-black opacity-50"></div>
        <div class="bg-white rounded-lg shadow-xl m-4 max-w-lg w-full z-50">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800">æ·»åŠ æ–°è®¢é˜…æº</h3>
                <button onclick="hideModal('addSourceModal')" class="text-gray-400 hover:text-gray-600">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="p-6">
                <div id="add-source-alert" class="hidden p-3 mb-4 rounded-md text-sm"></div>
                <div class="mb-4">
                    <label for="sourceName" class="block text-sm font-medium text-gray-700 mb-1">è®¢é˜…åç§° <span class="text-red-500">*</span></label>
                    <input type="text" id="sourceName" required placeholder="ä¾‹å¦‚: æœºåœºA" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <div>
                    <label for="sourceUrl" class="block text-sm font-medium text-gray-700 mb-1">è®¢é˜…é“¾æ¥ (URL) <span class="text-red-500">*</span></label>
                    <input type="url" id="sourceUrl" required placeholder="https://..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 text-right space-x-2">
                <button onclick="hideModal('addSourceModal')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">å–æ¶ˆ</button>
                <button onclick="addSubscriptionSource()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>
    </div>

    <script src="data.js"></script>
    <script>
    // The entire JS block from the old file will be pasted here.
    // I will keep it as is, but add new functions for the new UI.
    // =================================================================
    // æ–°çš„UIæ§åˆ¶å‡½æ•°
    // =================================================================

    let activeTab = 'tag-management'; // Default active tab

    const tabs = [
        { id: 'tag-management', icon: 'sell', name: 'Tagç®¡ç†' },
        { id: 'generator', icon: 'bolt', name: 'èŠ‚ç‚¹ç”Ÿæˆå™¨' },
        { id: 'manager', icon: 'tune', name: 'è®¢é˜…æºç®¡ç†' },
        { id: 'source-nodes', icon: 'hub', name: 'æºèŠ‚ç‚¹ç®¡ç†' },
        { id: 'nodepool', icon: 'storage', name: 'èŠ‚ç‚¹æ± ç®¡ç†' },
    ];

    function renderTabs() {
        const tabsContainer = document.getElementById('main-tabs');
        if (!tabsContainer) return;
        tabsContainer.innerHTML = tabs.map(tab => `
            <li>
                <a href="#" id="tab-link-${tab.id}" onclick="switchTab('${tab.id}')" class="flex items-center pb-2 transition ${activeTab === tab.id ? 'tab-active' : 'tab-inactive'}">
                    <span class="material-icons mr-2">${tab.icon}</span>
                    ${tab.name}
                </a>
            </li>
        `).join('');
    }

    function renderTabContent() {
        const contentContainer = document.getElementById('tab-content');
        if (!contentContainer) return;

        contentContainer.innerHTML = `
            <!-- Tag Management Pane -->
            <div id="tag-management-pane" class="hidden">
                <section class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-800">æˆ‘çš„Tagç®¡ç†</h2>
                        <button onclick="showModal('createTagModal')" class="bg-blue-600 text-white px-6 py-2 rounded-lg flex items-center hover:bg-blue-700 transition shadow-md">
                            <span class="material-icons mr-2">add_circle</span> åˆ›å»ºæ–°Tag
                        </button>
                    </div>
                    <div id="tags-list-container" class="bg-white p-6 rounded-lg shadow-sm"></div>
                </section>
                <section class="mb-8">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">èŠ‚ç‚¹æ‰¹é‡æ“ä½œ</h2>
                    <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-900 p-6 rounded-lg shadow-sm">
                        <p class="font-bold mb-2">ä½¿ç”¨è¯´æ˜ï¼š</p>
                        <ol class="list-decimal list-inside space-y-2 text-sm">
                            <li><span class="font-semibold">å‹¾é€‰Tagï¼š</span>åœ¨ä¸Šæ–¹Tagå¡ç‰‡ä¸­å‹¾é€‰è¦æ“ä½œçš„Tagï¼ˆå¯å¤šé€‰ï¼‰</li>
                            <li><span class="font-semibold">ç²˜è´´èŠ‚ç‚¹ï¼š</span>å°†èŠ‚ç‚¹é“¾æ¥ç²˜è´´åˆ°ä¸‹æ–¹æ–‡æœ¬æ¡†</li>
                            <li><span class="font-semibold">é€‰æ‹©æ“ä½œï¼š</span>æ·»åŠ åˆ°é€‰ä¸­Tagæˆ–ä»é€‰ä¸­Tagåˆ é™¤</li>
                        </ol>
                    </div>
                </section>
                <section>
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">èŠ‚ç‚¹åˆ—è¡¨</h2>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <textarea id="node-feedback-textarea" class="w-full h-48 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition mb-4 resize-none" placeholder="ç¤ºä¾‹:\nvless://uuid@server:port?params#name\nvmess://base64data"></textarea>
                        <div class="flex items-center space-x-4">
                            <button onclick="batchOperateNodes('add')" class="bg-green-500 text-white px-6 py-2 rounded-lg flex items-center hover:bg-green-600 transition shadow-md">
                                <span class="material-icons mr-2">add</span> æ·»åŠ åˆ°é€‰ä¸­Tag
                            </button>
                            <button onclick="batchOperateNodes('delete')" class="bg-red-500 text-white px-6 py-2 rounded-lg flex items-center hover:bg-red-600 transition shadow-md">
                                <span class="material-icons mr-2">remove</span> ä»é€‰ä¸­Tagåˆ é™¤
                            </button>
                            <button onclick="clearNodeTextarea()" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg flex items-center hover:bg-gray-300 transition">
                                <span class="material-icons mr-2">clear</span> æ¸…ç©ºæ–‡æœ¬æ¡†
                            </button>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Generator Pane -->
            <div id="generator-pane" class="hidden space-y-8">
                <div class="text-center">
                    <h2 class="text-3xl font-bold text-gray-800">âš¡ ç»ˆæèŠ‚ç‚¹ç”Ÿæˆå™¨</h2>
                    <p class="text-lg text-gray-600 mt-2">ä¸€ä¸ªå¼ºå¤§ã€çµæ´»çš„åœ¨çº¿èŠ‚ç‚¹æ‰¹é‡ç”Ÿæˆå·¥å…·</p>
                </div>

                <!-- Step 1: Data Source -->
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">ç¬¬ä¸€æ­¥ï¼šæä¾›æ•°æ®æº</h3>
                    <!-- Built-in vs Custom tabs -->
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <a href="#" id="gen-builtin-tab" onclick="switchGenTab('builtin')" class="border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">å†…ç½®åœ°åŒºæ•°æ®</a>
                            <a href="#" id="gen-manual-tab" onclick="switchGenTab('manual')" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">è‡ªå®šä¹‰ç²˜è´´æ•°æ®</a>
                        </nav>
                    </div>

                    <div id="gen-builtin-pane" class="mt-4 space-y-4">
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸŒ IPç‰ˆæœ¬é€‰æ‹©</label>
                            <div class="flex gap-4">
                                <label class="flex items-center"><input type="checkbox" id="useIPv4" checked onchange="updateEstimation()" class="h-4 w-4 text-blue-600 border-gray-300 rounded"> <span class="ml-2 text-gray-700">IPv4</span></label>
                                <label class="flex items-center"><input type="checkbox" id="useIPv6" checked onchange="updateEstimation()" class="h-4 w-4 text-blue-600 border-gray-300 rounded"> <span class="ml-2 text-gray-700">IPv6</span></label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸŒ åœ°åŒºé€‰æ‹©</label>
                            <div id="region-selector" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2"></div>
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ”Œ HTTPSç«¯å£é€‰æ‹©</label>
                            <div id="builtin-https-port-selector" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2"></div>
                        </div>
                    </div>

                    <div id="gen-manual-pane" class="hidden mt-4 space-y-4">
                        <div>
                            <label for="customData" class="block text-sm font-medium text-gray-700">è‡ªå®šä¹‰åœ°å€ (IPã€CIDR æˆ–åŸŸåï¼Œæ¯è¡Œä¸€ä¸ª)</label>
                            <textarea id="customData" rows="6" oninput="updateEstimation()" placeholder="ç¤ºä¾‹ï¼š&#10;104.28.43.45/32&#10;192.168.1.0/24&#10;example.com" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ”Œ HTTPSç«¯å£é€‰æ‹©</label>
                            <div id="https-port-selector" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Template -->
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">ç¬¬äºŒæ­¥ï¼šè®¾ç½®æ¨¡æ¿å’Œé€‰é¡¹</h3>
                     <div class="space-y-4">
                        <div>
                           <label for="templateUrl" class="block text-sm font-medium text-gray-700">ç²˜è´´æºèŠ‚ç‚¹ (VLESS æˆ– VMess)</label>
                           <input type="text" id="templateUrl" placeholder="vless://... æˆ– vmess://..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">é€‰æ‹©è¾“å‡ºæ ¼å¼</label>
                            <div id="format-selector" class="mt-2 flex gap-4">
                                <label class="flex items-center"><input type="radio" name="outputFormat" id="formatVless" value="vless" class="h-4 w-4 text-blue-600 border-gray-300"> <span class="ml-2 text-gray-700">VLESS</span></label>
                                <label class="flex items-center"><input type="radio" name="outputFormat" id="formatVmessJson" value="vmess_json" checked class="h-4 w-4 text-blue-600 border-gray-300"> <span class="ml-2 text-gray-700">VMess (v2rayN/U)</span></label>
                            </div>
                        </div>
                        <div id="estimation" class="!mt-6 p-4 rounded-lg bg-blue-50 text-blue-800 text-center"></div>
                    </div>
                </div>

                <!-- Step 3: Generate -->
                 <div class="bg-white p-6 rounded-lg shadow-sm">
                     <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">ç¬¬ä¸‰æ­¥ï¼šç”ŸæˆèŠ‚ç‚¹</h3>
                     <div class="flex items-end gap-4">
                         <div class="flex-grow">
                            <label for="quantity" class="block text-sm font-medium text-gray-700">ç”Ÿæˆæ•°é‡</label>
                            <input type="number" id="quantity" value="20" min="1" oninput="validateQuantityInput()" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                         </div>
                         <button onclick="generateNodes()" class="bg-blue-600 text-white h-10 px-8 rounded-lg flex items-center justify-center font-semibold hover:bg-blue-700 transition shadow-md">ç”ŸæˆèŠ‚ç‚¹</button>
                     </div>
                </div>

                <!-- Step 4: Results -->
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">ç”Ÿæˆç»“æœ</h3>
                    <textarea id="output" rows="10" readonly class="w-full p-2 border bg-gray-50 rounded-md"></textarea>
                    <div class="mt-4 flex gap-4">
                        <button id="copyButton" onclick="copyResults()" class="flex-1 bg-green-500 text-white px-6 py-2 rounded-lg flex items-center justify-center hover:bg-green-600 transition">
                            <span class="material-icons mr-2">content_copy</span> ä¸€é”®å¤åˆ¶
                        </button>
                    </div>
                    <!-- Save to Tag Section -->
                    <div class="mt-6 border-t pt-4">
                        <h4 class="font-semibold text-gray-700 mb-2">ğŸ’¾ å°†è¿™äº›èŠ‚ç‚¹å­˜å…¥Tag</h4>
                        <div class="flex gap-4 items-center">
                            <select id="existing-tag-select" class="flex-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">-- é€‰æ‹©ä¸€ä¸ªå·²æœ‰Tag --</option>
                            </select>
                            <span class="text-gray-500">æˆ–</span>
                            <input type="text" id="new-tag-input" placeholder="è¾“å…¥æ–°Tagåç§°..." class="flex-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <button onclick="saveNodesToTag()" class="bg-blue-500 text-white px-6 py-2 rounded-lg flex items-center hover:bg-blue-600 transition">
                                <span class="material-icons mr-2 text-sm">save</span> å­˜å…¥Tag
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Subscription Manager Pane -->
            <div id="manager-pane" class="hidden">
                 <section>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-800">æˆ‘çš„è®¢é˜…æº</h2>
                        <button onclick="showModal('addSourceModal')" class="bg-blue-600 text-white px-6 py-2 rounded-lg flex items-center hover:bg-blue-700 transition shadow-md">
                            <span class="material-icons mr-2">add</span> æ·»åŠ æ–°è®¢é˜…æº
                        </button>
                    </div>
                    <div id="subscription-sources-list" class="bg-white rounded-lg shadow-sm"></div>
                </section>
            </div>

            <!-- Source Nodes Pane -->
            <div id="source-nodes-pane" class="hidden">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-800">æºèŠ‚ç‚¹ç®¡ç†</h2>
                    <p class="text-lg text-gray-600 mt-2">NAT64 å’Œ ProxyIP æºèŠ‚ç‚¹ç”Ÿæˆä¸ç®¡ç†</p>
                </div>
                <div class="mb-8">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">ğŸŒŸ é»˜è®¤æºèŠ‚ç‚¹</h3>
                    <div id="default-source-nodes" class="space-y-4"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <!-- NAT64 Config -->
                    <div class="bg-white p-6 rounded-lg shadow-sm border-t-4 border-blue-500">
                        <h4 class="text-lg font-bold text-blue-600 mb-4">ğŸŒ NAT64 æºèŠ‚ç‚¹é…ç½®</h4>
                        <form id="nat64-form" class="space-y-4">
                             <div>
                                <label for="nat64-name" class="block text-sm font-medium text-gray-700">é…ç½®åç§°</label>
                                <input type="text" id="nat64-name" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„NAT64èŠ‚ç‚¹" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="nat64-domain" class="block text-sm font-medium text-gray-700">åŸŸå</label>
                                <input type="text" id="nat64-domain" placeholder="your-worker.workers.dev" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="nat64-uuid" class="block text-sm font-medium text-gray-700">UUID</label>
                                <div class="mt-1 flex rounded-md shadow-sm">
                                    <input type="text" id="nat64-uuid" placeholder="ç‚¹å‡»ç”ŸæˆUUID" class="flex-1 block w-full rounded-none rounded-l-md px-3 py-2 border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <button type="button" onclick="generateUUID('nat64-uuid')" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 hover:bg-gray-100">ç”Ÿæˆ</button>
                                </div>
                            </div>
                             <div class="flex items-center">
                                <input id="nat64-auto-fallback" type="checkbox" checked class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <label for="nat64-auto-fallback" class="ml-2 block text-sm text-gray-900">å¯ç”¨è‡ªåŠ¨å›é€€ (æ¨è)</label>
                            </div>
                            <div class="pt-2">
                                <button type="button" onclick="saveSourceNodeConfig('nat64')" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">ğŸ’¾ ä¿å­˜å¹¶æ·»åŠ åˆ°èŠ‚ç‚¹æ± </button>
                            </div>
                        </form>
                    </div>
                    <!-- ProxyIP Config -->
                    <div class="bg-white p-6 rounded-lg shadow-sm border-t-4 border-green-500">
                         <h4 class="text-lg font-bold text-green-600 mb-4">ğŸŒ ProxyIP æºèŠ‚ç‚¹é…ç½®</h4>
                         <form id="proxyip-form" class="space-y-4">
                            <div>
                                <label for="proxyip-name" class="block text-sm font-medium text-gray-700">é…ç½®åç§°</label>
                                <input type="text" id="proxyip-name" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ProxyIPèŠ‚ç‚¹" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            </div>
                             <div>
                                <label for="proxyip-domain" class="block text-sm font-medium text-gray-700">åŸŸå</label>
                                <input type="text" id="proxyip-domain" placeholder="your-worker.workers.dev" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            </div>
                            <div>
                                <label for="proxyip-uuid" class="block text-sm font-medium text-gray-700">UUID</label>
                                <div class="mt-1 flex rounded-md shadow-sm">
                                    <input type="text" id="proxyip-uuid" placeholder="ç‚¹å‡»ç”ŸæˆUUID" class="flex-1 block w-full rounded-none rounded-l-md px-3 py-2 border border-gray-300 focus:outline-none focus:ring-green-500 focus:border-green-500">
                                    <button type="button" onclick="generateUUID('proxyip-uuid')" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 hover:bg-gray-100">ç”Ÿæˆ</button>
                                </div>
                            </div>
                             <div>
                                <label for="proxyip-address" class="block text-sm font-medium text-gray-700">ä»£ç†IP</label>
                                <input type="text" id="proxyip-address" placeholder="ä¼˜é€‰IPåœ°å€" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            </div>
                            <div class="pt-2">
                                <button type="button" onclick="saveSourceNodeConfig('proxyip')" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">ğŸ’¾ ä¿å­˜å¹¶æ·»åŠ åˆ°èŠ‚ç‚¹æ± </button>
                            </div>
                         </form>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-xl font-semibold text-gray-700">ğŸ“‹ æˆ‘çš„æºèŠ‚ç‚¹é…ç½®</h3>
                        <button onclick="loadSourceNodes()" class="text-blue-600 hover:text-blue-800 p-2 rounded-full"><span class="material-icons">refresh</span></button>
                    </div>
                    <div id="custom-source-nodes" class="bg-white rounded-lg shadow-sm"></div>
                </div>
            </div>

            <!-- Nodepool Pane -->
            <div id="nodepool-pane" class="hidden">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">æˆ‘çš„èŠ‚ç‚¹æ± </h2>
                    <div>
                        <span id="node-count-badge" class="inline-block bg-blue-100 text-blue-800 text-sm font-semibold px-3 py-1 rounded-full mr-4">æ€»è®¡: 0</span>
                        <button onclick="refreshAllSources()" class="bg-blue-600 text-white px-6 py-2 rounded-lg flex items-center hover:bg-blue-700 transition shadow-md">
                            <span class="material-icons mr-2">refresh</span> åˆ·æ–°æ‰€æœ‰æº
                        </button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <input type="text" id="node-search" placeholder="æœç´¢èŠ‚ç‚¹åç§°ã€æ¥æºã€æœåŠ¡å™¨..." oninput="filterNodes()" class="p-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        <select id="source-filter" onchange="filterNodes()" class="p-2 border rounded-lg focus:ring-2 focus:ring-blue-500"><option value="">æ‰€æœ‰æ¥æº</option></select>
                        <select id="protocol-filter" onchange="filterNodes()" class="p-2 border rounded-lg focus:ring-2 focus:ring-blue-500"><option value="">æ‰€æœ‰åè®®</option></select>
                    </div>
                    <div id="node-pool-list" class="divide-y divide-gray-200"></div>
                    <nav class="mt-6 flex justify-center">
                        <ul id="node-pagination" class="flex items-center -space-x-px h-8 text-sm"></ul>
                    </nav>
                </div>
            </div>
        `;
    }

    function switchTab(tabId) {
        activeTab = tabId;
        renderTabs(); // Re-render tabs to update active state

        // Hide all panes
        document.getElementById('tag-management-pane').classList.add('hidden');
        document.getElementById('generator-pane').classList.add('hidden');
        document.getElementById('manager-pane').classList.add('hidden');
        document.getElementById('source-nodes-pane').classList.add('hidden');
        document.getElementById('nodepool-pane').classList.add('hidden');

        // Show the active one
        const activePane = document.getElementById(`${tabId}-pane`);
        if (activePane) {
            activePane.classList.remove('hidden');
        }

        // Trigger data loading for the new tab
        if (tabId === 'tag-management') loadTags();
        if (tabId === 'manager') loadSubscriptionSources();
        if (tabId === 'source-nodes') loadSourceNodes();
        if (tabId === 'nodepool') loadNodePool();

    }

    function showModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
    }

    function hideModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    }

    function showGlobalAlert(message, type = 'success') {
        const alertElement = document.getElementById('global-alert');
        const iconElement = document.getElementById('global-alert-icon');
        const messageElement = document.getElementById('global-alert-message');

        alertElement.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'bg-yellow-500');

        if (type === 'success') {
            alertElement.classList.add('bg-green-500');
            iconElement.textContent = 'check_circle';
        } else if (type === 'danger') {
            alertElement.classList.add('bg-red-500');
            iconElement.textContent = 'error';
        } else { // info/warning
             alertElement.classList.add('bg-yellow-500');
            iconElement.textContent = 'warning';
        }

        messageElement.textContent = message;
        alertElement.classList.remove('hidden');

        setTimeout(() => {
            alertElement.classList.add('hidden');
        }, 3000);
    }

    // =================================================================
    // æ—§çš„JSé€»è¾‘ï¼Œéœ€è¦é€‚é…æ–°çš„UI
    // =================================================================
    let currentUser = null;
    let isLoginMode = true;
    let allTags = [];
    let allNodes = [];
    let filteredNodes = [];
    let currentPage = 1;
    const nodesPerPage = 20;

    async function apiRequest(url, method, data = null) {
        const options = {
            method: method,
            headers: { "Content-Type": "application/json" },
        };
        if (data) options.body = JSON.stringify(data);

        try {
            const response = await fetch(url, options);
            const result = await response.json();
            return { ok: response.ok, data: result, status: response.status };
        } catch (error) {
            console.error("APIè¯·æ±‚å¤±è´¥:", error);
            return { ok: false, data: { error: error.message }, status: 500 };
        }
    }

    async function checkLoginStatus() {
        console.log("æ£€æŸ¥ç™»å½•çŠ¶æ€...");
        const result = await apiRequest("/api/status", "GET");
        if (result.ok && result.data.authenticated) {
            currentUser = result.data;
            console.log("ç”¨æˆ·å·²ç™»å½•:", currentUser.username);
        } else {
            currentUser = null;
            console.log("ç”¨æˆ·æœªç™»å½•");
        }
        updateUI();
    }

    function updateUI() {
        const mainContent = document.getElementById("main-content");
        const loginPrompt = document.getElementById("login-prompt");

        if (currentUser) {
            mainContent.style.display = "block";
            loginPrompt.style.display = "none";

            const userStatusArea = document.getElementById("user-status-area");
            userStatusArea.innerHTML = `
                <span>æ¬¢è¿, <span class="font-semibold">${currentUser.username}</span></span>
                <button onclick="logout()" class="bg-white text-blue-600 px-4 py-2 rounded-md font-semibold hover:bg-blue-100 transition">ç™»å‡º</button>
            `;

            renderTabs();
            renderTabContent();
            // Initial data load for the default tab
            switchTab(activeTab);

        } else {
            mainContent.style.display = "none";
            loginPrompt.style.display = "flex";
        }
    }

    function switchAuthMode() {
        isLoginMode = !isLoginMode;
        const title = document.getElementById('auth-title');
        const submitButton = document.getElementById('auth-submit-button');
        const switchText = document.getElementById('auth-switch-text');
        const switchLink = document.getElementById('auth-switch-link');

        if (isLoginMode) {
            title.textContent = "ç”¨æˆ·ç™»å½•";
            submitButton.textContent = "ç™»å½•";
            switchText.textContent = "è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿ";
            switchLink.textContent = "ç«‹å³æ³¨å†Œ";
        } else {
            title.textContent = "ç”¨æˆ·æ³¨å†Œ";
            submitButton.textContent = "æ³¨å†Œ";
            switchText.textContent = "å·²æœ‰è´¦æˆ·ï¼Ÿ";
            switchLink.textContent = "è¿”å›ç™»å½•";
        }
    }

    async function performAuth() {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value;
        const alertElement = document.getElementById("auth-alert");

        if (!username || !password) {
            showAlert(alertElement, "danger", "ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º");
            return;
        }

        const endpoint = isLoginMode ? "/api/login" : "/api/register";
        const result = await apiRequest(endpoint, "POST", { username, password });

        if (result.ok) {
            showAlert(alertElement, "success", result.data.message);
            document.getElementById("username").value = "";
            document.getElementById("password").value = "";

            if (isLoginMode) {
                setTimeout(() => {
                    checkLoginStatus();
                }, 1000);
            }
        } else {
            showAlert(alertElement, "danger", result.data.error);
        }
    }

    function showAlert(element, type, message) {
        element.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
        if (type === 'success') {
            element.classList.add('bg-green-100', 'text-green-800');
        } else {
            element.classList.add('bg-red-100', 'text-red-800');
        }
        element.textContent = message;
        element.classList.remove('hidden');
    }


    async function logout() {
        await apiRequest("/api/logout", "POST");
        currentUser = null;
        updateUI();
    }

    // =================================================================
    // Tagç®¡ç†ç›¸å…³å‡½æ•° (é€‚é…æ–°UI)
    // =================================================================
    async function loadTags() {
        const listContainer = document.getElementById("tags-list-container");
        if (!listContainer) return;

        listContainer.innerHTML = '<p class="text-gray-500">æ­£åœ¨åŠ è½½Tag...</p>';

        const result = await apiRequest("/api/tags", "GET");

        if (result.ok && Array.isArray(result.data)) {
            allTags = result.data;

            if (allTags.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500">æ‚¨è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•Tagã€‚ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªTagã€‚</p>';
                return;
            }

            const tagsHTML = allTags.map(tag => `
                <div class="border border-gray-200 rounded-lg p-4 bg-white shadow-md hover:shadow-lg transition-shadow duration-300">
                    <div class="flex items-center mb-3">
                        <input type="checkbox" id="tag-select-${tag.id}" value="${tag.id}" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-3"/>
                        <h3 class="font-bold text-lg text-gray-800 truncate">${escapeHTML(tag.tag_name)}</h3>
                    </div>
                    <div class="mb-4">
                        <span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-full mr-2">${tag.node_count || 0}ä¸ªèŠ‚ç‚¹</span>
                        ${tag.active_count > 0 ? `<span class="inline-block bg-green-100 text-green-800 text-xs font-semibold px-3 py-1 rounded-full">${tag.active_count}å¯ç”¨</span>` : ''}
                    </div>
                    <div class="space-y-2">
                        <button onclick="copyTagSubscription('${tag.tag_uuid}', 'v2ray')" class="w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-md flex items-center justify-center text-sm hover:bg-gray-200 transition">
                            <span class="material-icons mr-2 text-base">link</span> V2Rayè®¢é˜…
                        </button>
                        <button onclick="copyTagSubscription('${tag.tag_uuid}', 'clash')" class="w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-md flex items-center justify-center text-sm hover:bg-gray-200 transition">
                            <span class="material-icons mr-2 text-base">link</span> Clashè®¢é˜…
                        </button>
                    </div>
                </div>
            `).join('');

            listContainer.innerHTML = `
                <div class="flex items-center space-x-4 mb-6 pb-4 border-b">
                    <button onclick="selectAllTags(true)" class="bg-blue-100 text-blue-700 px-4 py-2 rounded-full text-sm font-medium">å…¨é€‰Tag</button>
                    <button onclick="selectAllTags(false)" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-full text-sm font-medium">å–æ¶ˆå…¨é€‰</button>
                    <button onclick="deleteSelectedTags()" class="bg-red-500 text-white px-4 py-2 rounded-full text-sm font-medium flex items-center">
                        <span class="material-icons text-base mr-1">delete</span> åˆ é™¤é€‰ä¸­Tag
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    ${tagsHTML}
                </div>
            `;
        } else {
            listContainer.innerHTML = '<p class="text-red-500">åŠ è½½Tagå¤±è´¥ã€‚</p>';
        }
    }

    function selectAllTags(select) {
        document.querySelectorAll('input[id^="tag-select-"]').forEach(cb => cb.checked = select);
    }

    function getSelectedTagIds() {
        return Array.from(document.querySelectorAll('input[id^="tag-select-"]:checked')).map(cb => parseInt(cb.value));
    }

    async function createNewTag() {
        const tagName = document.getElementById("tagName").value.trim();
        const tagDescription = document.getElementById("tagDescription").value.trim();
        const alertElement = document.getElementById("create-tag-alert");

        if (!tagName) {
            showAlert(alertElement, "danger", "Tagåç§°ä¸èƒ½ä¸ºç©º");
            return;
        }

        const result = await apiRequest("/api/tags", "POST", { tag_name: tagName, description: tagDescription });

        if (result.ok) {
            showAlert(alertElement, "success", result.data.message);
            document.getElementById("tagName").value = "";
            document.getElementById("tagDescription").value = "";
            setTimeout(() => {
                hideModal('createTagModal');
                loadTags();
            }, 1500);
        } else {
            showAlert(alertElement, "danger", `åˆ›å»ºå¤±è´¥: ${result.data.error}`);
        }
    }

    async function deleteSelectedTags() {
        const selectedTagIds = getSelectedTagIds();
        if (selectedTagIds.length === 0) {
            showGlobalAlert("è¯·å…ˆå‹¾é€‰è¦åˆ é™¤çš„Tagï¼", "warning");
            return;
        }

        if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedTagIds.length} ä¸ªTagå—ï¼Ÿ`)) return;

        const result = await apiRequest("/api/tags/batch-delete", "POST", { tag_ids: selectedTagIds });

        if (result.ok) {
            showGlobalAlert(result.data.message, "success");
            loadTags();
        } else {
            showGlobalAlert(`åˆ é™¤å¤±è´¥: ${result.data.error}`, "danger");
        }
    }

    function copyTagSubscription(tagUuid, format) {
        const baseUrl = `${window.location.origin}/sub/tag/${tagUuid}`;
        const url = format === 'clash' ? `${baseUrl}?type=clash` : baseUrl;
        navigator.clipboard.writeText(url).then(() => {
            showGlobalAlert(`${format.charAt(0).toUpperCase() + format.slice(1)} è®¢é˜…é“¾æ¥å·²å¤åˆ¶!`, 'success');
        });
    }

    async function batchOperateNodes(action) {
        const selectedTagIds = getSelectedTagIds();
        if (selectedTagIds.length === 0) {
            showGlobalAlert("è¯·å…ˆå‹¾é€‰è¦æ“ä½œçš„Tagï¼", "warning");
            return;
        }

        const nodeText = document.getElementById("node-feedback-textarea").value.trim();
        if (!nodeText) {
            showGlobalAlert("è¯·è¾“å…¥èŠ‚ç‚¹é“¾æ¥ï¼", "warning");
            return;
        }

        const nodes = nodeText.split('\\n').filter(line => line.trim() !== "");
        if (nodes.length === 0) {
            showGlobalAlert("æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„èŠ‚ç‚¹é“¾æ¥ï¼", "warning");
            return;
        }

        const result = await apiRequest("/api/nodes/batch-operate", "POST", {
            tag_ids: selectedTagIds,
            nodes: nodes,
            action: action
        });

        if (result.ok) {
            let message = result.data.message;
            if (result.data.details) {
                message += " è¯¦æƒ…: " + result.data.details.join(', ');
            }
            showGlobalAlert(message, 'success');
            clearNodeTextarea();
            loadTags();
        } else {
            showGlobalAlert(`æ“ä½œå¤±è´¥: ${result.data.error}`, 'danger');
        }
    }

    function clearNodeTextarea() {
        document.getElementById("node-feedback-textarea").value = "";
    }

    // =================================================================
    // è®¢é˜…æºç®¡ç†
    // =================================================================
    async function loadSubscriptionSources() {
        const listElement = document.getElementById("subscription-sources-list");
        if (!listElement) return;

        listElement.innerHTML = '<p class="p-4 text-gray-500">æ­£åœ¨åŠ è½½è®¢é˜…æº...</p>';
        const result = await apiRequest("/api/subscription-sources", "GET");

        if (result.ok && Array.isArray(result.data)) {
            if (result.data.length === 0) {
                listElement.innerHTML = '<p class="p-4 text-gray-500">æ‚¨è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•è®¢é˜…æºã€‚</p>';
                return;
            }

            listElement.innerHTML = result.data.map(source => `
                <div class="border-b p-4 hover:bg-gray-50">
                    <div class="flex justify-between items-center">
                        <div class="flex-1 truncate">
                            <h4 class="font-semibold text-gray-800">${escapeHTML(source.source_name)}</h4>
                            <p class="text-sm text-gray-500 truncate">${escapeHTML(source.source_url)}</p>
                        </div>
                        <div class="ml-4 text-right">
                            <span class="text-sm text-gray-600">èŠ‚ç‚¹: ${source.node_count || 0}</span>
                            <span class="ml-2 inline-block px-2 py-1 text-xs font-semibold rounded-full bg-${getStatusColor(source.fetch_status)}-100 text-${getStatusColor(source.fetch_status)}-800">${source.fetch_status}</span>
                        </div>
                    </div>
                    <div class="flex justify-end items-center mt-2 space-x-2">
                         <button onclick="refreshSource(${source.id})" class="text-gray-500 hover:text-blue-600 p-2 rounded-full transition"><span class="material-icons">refresh</span></button>
                         <button onclick="deleteSource(${source.id})" class="text-gray-500 hover:text-red-600 p-2 rounded-full transition"><span class="material-icons">delete</span></button>
                    </div>
                </div>
            `).join('');
        } else {
            listElement.innerHTML = '<p class="p-4 text-red-500">åŠ è½½è®¢é˜…æºå¤±è´¥ã€‚</p>';
        }
    }

    async function addSubscriptionSource() {
        const sourceName = document.getElementById("sourceName").value;
        const sourceUrl = document.getElementById("sourceUrl").value;
        const alertElement = document.getElementById("add-source-alert");

        const result = await apiRequest("/api/subscription-sources", "POST", { source_name: sourceName, source_url: sourceUrl });

        if (result.ok) {
            showAlert(alertElement, "success", result.data.message);
            document.getElementById("sourceName").value = "";
            document.getElementById("sourceUrl").value = "";
            setTimeout(() => {
                hideModal('addSourceModal');
                loadSubscriptionSources();
            }, 1500);
        } else {
            showAlert(alertElement, "danger", `æ·»åŠ å¤±è´¥: ${result.data.error}`);
        }
    }

    async function refreshSource(id) {
        await apiRequest(`/api/subscription-sources/${id}/refresh`, "POST");
        showGlobalAlert("åˆ·æ–°è¯·æ±‚å·²å‘é€ï¼Œè¯·ç¨åæŸ¥çœ‹çŠ¶æ€ã€‚", 'success');
        setTimeout(loadSubscriptionSources, 3000);
    }

    async function deleteSource(id) {
        if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¢é˜…æºåŠå…¶æ‰€æœ‰èŠ‚ç‚¹å—ï¼Ÿ")) return;
        await apiRequest(`/api/subscription-sources/${id}`, "DELETE");
        showGlobalAlert("è®¢é˜…æºå·²åˆ é™¤", 'success');
        loadSubscriptionSources();
    }

    function getStatusColor(status) {
        switch (status) {
            case 'success': return 'green';
            case 'fetching': return 'blue';
            case 'failed': return 'red';
            default: return 'gray';
        }
    }

    function escapeHTML(str) {
        if (!str) return "";
        return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    // =================================================================
    // æºèŠ‚ç‚¹ç®¡ç†ç›¸å…³å‡½æ•°
    // =================================================================

    function generateUUID(inputId) {
        document.getElementById(inputId).value = crypto.randomUUID();
    }

    async function saveSourceNodeConfig(nodeType) {
        let configName, configData;

        if (nodeType === 'nat64') {
            configName = document.getElementById("nat64-name").value || "NAT64è‡ªåŠ¨é…ç½®";
            configData = {
                uuid: document.getElementById("nat64-uuid").value,
                domain: document.getElementById("nat64-domain").value,
            };
        } else {
            // Logic for proxyip
        }

        if (!configData.domain || !configData.uuid) {
            showGlobalAlert("åŸŸåå’ŒUUIDä¸èƒ½ä¸ºç©ºï¼", "danger");
            return;
        }

        const result = await apiRequest("/api/source-nodes", "POST", {
            config_name: configName,
            node_type: nodeType,
            config_data: configData,
        });

        if (result.ok) {
            showGlobalAlert("æºèŠ‚ç‚¹é…ç½®å·²ä¿å­˜å¹¶æ·»åŠ åˆ°èŠ‚ç‚¹æ± ï¼", "success");
            loadSourceNodes();
            // Optionally reset form
            document.getElementById(`${nodeType}-form`).reset();
        } else {
            showGlobalAlert(`ä¿å­˜å¤±è´¥: ${result.data.error}`, "danger");
        }
    }

    async function loadSourceNodes() {
        const result = await apiRequest("/api/source-nodes", "GET");
        if (result.ok) {
            displaySourceNodes(result.data);
        } else {
            document.getElementById("default-source-nodes").innerHTML = `<p class="text-red-500">åŠ è½½é»˜è®¤æºèŠ‚ç‚¹å¤±è´¥</p>`;
            document.getElementById("custom-source-nodes").innerHTML = `<p class="text-red-500">åŠ è½½è‡ªå®šä¹‰æºèŠ‚ç‚¹å¤±è´¥</p>`;
        }
    }

    function displaySourceNodes(configs) {
        const defaultNodesContainer = document.getElementById("default-source-nodes");
        const customNodesContainer = document.getElementById("custom-source-nodes");

        const defaultNodes = configs.filter(c => c.is_default);
        const customNodes = configs.filter(c => !c.is_default);

        if (defaultNodes.length > 0) {
            defaultNodesContainer.innerHTML = defaultNodes.map(node => {
                const configData = JSON.parse(node.config_data);
                return `
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="flex justify-between items-center">
                        <div>
                            <h5 class="font-semibold">${escapeHTML(node.config_name)}</h5>
                            <p class="text-sm text-gray-600">ç±»å‹: <span class="font-medium text-blue-600">${node.node_type.toUpperCase()}</span> | åŸŸå: ${escapeHTML(configData.domain)}</p>
                        </div>
                        <button onclick="copyToClipboard('${node.generated_node}')" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons text-gray-600">content_copy</span></button>
                    </div>
                </div>
            `;
            }).join('');
        } else {
            defaultNodesContainer.innerHTML = `<p class="text-gray-500">æ²¡æœ‰æ‰¾åˆ°é»˜è®¤æºèŠ‚ç‚¹ã€‚</p>`;
        }

        if (customNodes.length > 0) {
            customNodesContainer.innerHTML = customNodes.map(node => `
                 <div class="border-t p-4 hover:bg-gray-50">
                    <div class="flex justify-between items-start">
                        <div>
                            <h5 class="font-semibold">${escapeHTML(node.config_name)}</h5>
                            <p class="text-sm text-gray-500">ç±»å‹: <span class="font-medium text-blue-600">${node.node_type.toUpperCase()}</span></p>
                            <p class="text-sm text-gray-500 break-all">èŠ‚ç‚¹: <code class="text-xs bg-gray-100 p-1 rounded">${escapeHTML(node.generated_node)}</code></p>
                        </div>
                        <div class="flex space-x-1">
                            <button onclick="deleteSourceNode(${node.id}, '${escapeHTML(node.config_name)}')" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons text-red-500">delete</span></button>
                            <button onclick="copyToClipboard('${node.generated_node}')" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons text-gray-600">content_copy</span></button>
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            customNodesContainer.innerHTML = `<p class="p-4 text-center text-gray-500">è¿˜æ²¡æœ‰è‡ªå®šä¹‰æºèŠ‚ç‚¹é…ç½®ã€‚</p>`;
        }
    }

    async function deleteSourceNode(id, name) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤æºèŠ‚ç‚¹é…ç½® "${name}" å—ï¼Ÿ`)) return;
        const result = await apiRequest(`/api/source-nodes/${id}`, 'DELETE');
        if (result.ok) {
            showGlobalAlert('æºèŠ‚ç‚¹é…ç½®å·²åˆ é™¤', 'success');
            loadSourceNodes();
        } else {
            showGlobalAlert(`åˆ é™¤å¤±è´¥: ${result.data.error}`, 'danger');
        }
    }

    // =================================================================
    // èŠ‚ç‚¹æ± ç®¡ç†
    // =================================================================
    async function loadNodePool() {
        const result = await apiRequest('/api/nodes', 'GET');
        if (result.ok) {
            allNodes = result.data;
            populateSourceFilter();
            filterNodes();
        } else {
            document.getElementById('node-pool-list').innerHTML = `<p class="text-red-500">åŠ è½½èŠ‚ç‚¹æ± å¤±è´¥</p>`;
        }
    }

    function populateSourceFilter() {
        const sourceFilter = document.getElementById("source-filter");
        const sources = [...new Set(allNodes.map(node => node.source_name || 'æ‰‹åŠ¨æ·»åŠ '))];
        sourceFilter.innerHTML = '<option value="">æ‰€æœ‰æ¥æº</option>';
        sources.forEach(source => {
            sourceFilter.innerHTML += `<option value="${escapeHTML(source)}">${escapeHTML(source)}</option>`;
        });
    }

    function filterNodes() {
        const searchTerm = document.getElementById('node-search').value.toLowerCase();
        const sourceFilter = document.getElementById('source-filter').value;
        const protocolFilter = document.getElementById('protocol-filter').value;

        filteredNodes = allNodes.filter(node => {
            const name = node.node_name || '';
            const server = node.server || '';
            const source = node.source_name || 'æ‰‹åŠ¨æ·»åŠ ';
            const protocol = node.protocol || '';

            return (name.toLowerCase().includes(searchTerm) || server.toLowerCase().includes(searchTerm)) &&
                   (!sourceFilter || source === sourceFilter) &&
                   (!protocolFilter || protocol === protocolFilter);
        });

        currentPage = 1;
        displayNodes();
        updatePagination();
        updateNodeCountBadge(filteredNodes.length);
    }

    function displayNodes() {
        const listElement = document.getElementById('node-pool-list');
        const startIndex = (currentPage - 1) * nodesPerPage;
        const endIndex = startIndex + nodesPerPage;
        const nodesToShow = filteredNodes.slice(startIndex, endIndex);

        if (nodesToShow.length === 0) {
            listElement.innerHTML = '<p class="text-center text-gray-500 py-4">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„èŠ‚ç‚¹ã€‚</p>';
            return;
        }

        listElement.innerHTML = nodesToShow.map(node => `
            <div class="py-3 px-2 hover:bg-gray-50">
                <div class="flex items-center justify-between">
                    <div class="flex-1 truncate">
                        <p class="font-medium text-gray-800 truncate">${escapeHTML(node.node_name)}</p>
                        <p class="text-sm text-gray-500">æ¥æº: ${escapeHTML(node.source_name || 'æ‰‹åŠ¨æ·»åŠ ')} | æœåŠ¡å™¨: ${escapeHTML(node.server)}</p>
                    </div>
                    <div class="ml-4 flex items-center space-x-2">
                        <span class="inline-block px-2 py-1 text-xs font-semibold rounded-full bg-indigo-100 text-indigo-800">${(node.protocol || 'N/A').toUpperCase()}</span>
                        <button onclick="copyToClipboard('${node.node_url}')" class="p-2 rounded-full hover:bg-gray-200"><span class="material-icons text-gray-600 text-base">content_copy</span></button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function updatePagination() {
        const paginationElement = document.getElementById('node-pagination');
        const totalPages = Math.ceil(filteredNodes.length / nodesPerPage);
        if (totalPages <= 1) {
            paginationElement.innerHTML = '';
            return;
        }
        // ... implementation for pagination buttons
    }

    function updateNodeCountBadge(count) {
        document.getElementById('node-count-badge').textContent = `æ€»è®¡: ${count}`;
    }

    async function refreshAllSources() {
         if (!confirm("ç¡®å®šè¦åˆ·æ–°æ‰€æœ‰è®¢é˜…æºå—ï¼Ÿ")) return;
         // In a real app, you might want to show a loading state
         const result = await apiRequest('/api/subscription-sources/refresh-all', 'POST'); // Assuming a new batch-refresh endpoint
         if (result.ok) {
            showGlobalAlert('æ‰€æœ‰è®¢é˜…æºåˆ·æ–°ä»»åŠ¡å·²å¯åŠ¨ã€‚', 'success');
            setTimeout(() => { loadSubscriptionSources(); loadNodePool(); }, 5000);
         } else {
            showGlobalAlert('å¯åŠ¨åˆ·æ–°ä»»åŠ¡å¤±è´¥ã€‚', 'danger');
         }
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showGlobalAlert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿!', 'success');
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        checkLoginStatus();
    });
    </script>
</body>
</html>
